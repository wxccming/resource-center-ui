(function(D,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(D=typeof globalThis<"u"?globalThis:D||self,g(D.liGlobe={}))})(this,function(D){"use strict";var Ca=Object.defineProperty;var _a=(D,g,A)=>g in D?Ca(D,g,{enumerable:!0,configurable:!0,writable:!0,value:A}):D[g]=A;var Gn=(D,g,A)=>(_a(D,typeof g!="symbol"?g+"":g,A),A);const g=Cesium,A=g.Color,S=g.Color,mt=g.Fullscreen,T=g.Math,wi=g.Viewer,jn=g.Viewer,$n=g.Scene,Yn=g.BoundingSphere,W=g.CallbackProperty,gt=g.Camera,E=g.Cartesian2,d=g.Cartesian3,Ke=g.Cartesian4,q=g.Cartographic,yi=g.ClassificationType,Ci=g.clone;g.ConstantProperty;const B=g.CustomDataSource,p=g.defaultValue,a=g.defined;g.createPropertyDescriptor,g.DeveloperError;const Zn=g.PerspectiveFrustum,Jn=g.ShadowMap;g.createMaterialPropertyDescriptor,g.viewerCesium3DTilesInspectorMixin;const vt=g.knockout,pe=g.Cesium3DTileset;g.HeadingPitchRange;const wt=g.Cesium3DTileStyle,k=g.DistanceDisplayCondition,_i=g.Ellipsoid,Kn=g.EllipsoidGeodesic,me=g.Entity,qe=g.Event,bi=g.EventHelper,qn=g.GeographicTilingScheme,Xn=g.GeoJsonDataSource,Xe=g.getElement,$=g.getTimestamp,Ve=g.HeadingPitchRange,Qn=g.HeadingPitchRoll,yt=g.HeightReference,Qe=g.HorizontalOrigin,Si=g.ImageMaterialProperty,es=g.CesiumTerrainProvider,ts=g.IntersectionTests,Ti=g.knockout,Z=g.Material,Q=g.Matrix3,O=g.Matrix4,Li=g.Cesium3DTileset;g.Cesium3DTileStyle;const is=g.PolygonGraphics,et=g.PolygonHierarchy,ns=g.PolygonPipeline,Ie=g.PolylineGeometry,U=g.PolylineDashMaterialProperty,ss=g.PolylineArrowMaterialProperty,Ei=g.PostProcessStage,ie=g.Property,Ue=g.Quaternion,Di=g.Ray,ne=g.Rectangle,z=g.SceneMode,ae=g.ScreenSpaceEventHandler,F=g.ScreenSpaceEventType,Pi=g.SingleTileImageryProvider,rs=g.SkyBox,le=g.Transforms,os=g.UrlTemplateImageryProvider,tt=g.VerticalOrigin,as=g.WebMapServiceImageryProvider,ls=g.WebMapTileServiceImageryProvider,xi=g.WebMercatorProjection,hs=g.WebMercatorTilingScheme,cs=g.sampleTerrainMostDetailed,ki=g.sampleTerrain,ds=g.PolylinePipeline,us=g.CzmlDataSource,Ae=g.SampledPositionProperty,Ct=g.SampledProperty,fs=g.VelocityOrientationProperty,b=g.JulianDate;g.HermitePolynomialApproximation;const ps=g.TimeIntervalCollection,ms=g.TimeInterval;g.Clock;const gs=g.ClockRange,vs=g.ModelGraphics,J=g.LabelStyle,se=g.ColorGeometryInstanceAttribute,_e=g.GeometryInstance,be=g.PolylineColorAppearance,ws=g.Primitive,ys=g.buildModuleUrl,Cs=g.EllipsoidTerrainProvider,_s=g.Cesium3DTileFeature,bs=g.EllipsoidalOccluder,Ii=g.AutoRotate;g.VERSION;const Ss=g.NearFarScalar,Me=g.PrimitiveCollection;g.PostProcessStageLibrary;const _t=g.SceneTransforms,Ai=g.PolylineGlowMaterialProperty;g.Resource;const bt=g.PointPrimitiveCollection,Ge=g.LabelCollection,Le=g.BillboardCollection,St=g.PolylineCollection;g.ColorMaterialProperty;const Ts=g.PolygonGeometry,Ls=g.GroundPrimitive,Es=g.GroundPolylinePrimitive,Ds=g.MaterialAppearance;g.CylinderGeometry,g.PerInstanceColorAppearance;function Ps(n){var e=document.createElement("div");e.innerHTML=n;for(var t=document.createDocumentFragment();e.firstChild;)t.appendChild(e.firstChild);return t}function Tt(n,e,t){e=Xe(e);var i=Ps(n),s=[],r;for(r=0;r<i.childNodes.length;++r)s.push(i.childNodes[r]);for(e.appendChild(i),r=0;r<s.length;++r){var o=s[r];(o.nodeType===1||o.nodeType===8)&&vt.applyBindings(t,o)}return s}function xs(n,e){let t=document.createElement(n);return a(e)&&(a(e.type)&&(t.type=e.type),a(e.id)&&(t.id=e.id),a(e.class)&&(t.class=e.class),a(e.className)&&(t.className=e.className),a(e.checked)&&e.checked&&(t.checked="checked"),a(e.style)&&t.setAttribute("style",e.style),a(e.src)&&(t.src=e.src),a(e.href)&&(t.src=e.href),a(e.title)&&t.setAttribute("title",e.title),a(e.value)&&t.setAttribute("value",e.value),a(e.innerText)&&(t.innerText=e.innerText),a(e.innerHTML)&&(t.innerHTML=e.innerHTML),a(e.disablecontextmenu)&&(t.oncontextmenu=function(){return!1}),a(e.click)&&t.addEventListener("click",e.click),a(e.container)&&e.container.appendChild(t)),t}function ks(n,e){n.classList.contains(e)||n.classList.add(e)}function Is(n,e){n.classList.contains(e)?n.classList.remove(e):n.classList.add(e)}function As(n,e){n.classList.contains(e)&&n.classList.remove(e)}function Ms(){return ys.getCesiumBaseUrl()}let ge={createElement:xs,removeClass:As,switchClass:Is,addClass:ks,getBaseUrlFromScript:Ms,loadView:Tt};function Fs(n){var e,t,i;return n instanceof Array?(n[1]>90?(t=n[0],e=n[1]):(e=n[0],t=n[1]),i=n[2]||0):typeof n=="object"&&(e=n.lng||n.x||n.longitude||n.lon||n.X||n.LONGITUDE||n.LNG||n.LON,t=n.lat||n.y||n.latitude||n.Y||n.LATITUDE||n.LAT,i=n.alt||n.altitude||n.z||n.Z||n.ALT||n.ALTITUDE||n.height||n.h||n.HEIGHT),[e,t,i]}class he{constructor(e){let t=Fs(e);this.x=t[0],this.y=t[1],this.z=t[2]}getCartesian(){return d.fromDegrees(this.x,this.y,this.z)}static getCartesian(e){if(!a(e))return;if(e instanceof d||e instanceof W)return e;let t=new he(e);return d.fromDegrees(t.x,t.y,t.z)}static getArray(e){return new he(e).getArray()}getArray(){return[this.x,this.y,this.z]}}function Lt(n){if(n instanceof wi)return n.scene;if(n instanceof $n)return n;throw new Error("未指定参数viewer")}function Os(n){var e=[];if(n instanceof Array)e=n;else throw new Error("指定参数不符合要求，请设置为array[3]");return d.fromArray(e)}function Ee(n,e){var t=Lt(n),i=t.globe.ellipsoid,s=i.cartesianToCartographic(e),r=T.toDegrees(s.latitude),o=T.toDegrees(s.longitude),l=s.height;return new he([o,r,l])}function Rs(n,e=!1){if(!a(n))return;let t=T.toDegrees(n.latitude),i=T.toDegrees(n.longitude),s=n.height,r=[i,t,s];return e?r:new he(r)}function Et(n,e,t,i){var s=Lt(n),r=s.globe.ellipsoid;return d.fromDegrees(e,t,i,r)}function Dt(n){return d.clone(n)}function Hs(n,e){if(!a(n)||n.length<3)throw new Error("数组长度应该为3");var t=Dt(n[0]),i=Dt(n[1]),s=Dt(n[2]),r=new d,o=new d;switch(e){case 2:d.subtract(t,i,r),d.subtract(s,i,o);break;case 3:d.subtract(t,s,r),d.subtract(i,s,o);break;default:d.subtract(i,t,r),d.subtract(s,t,o);break}return T.toDegrees(d.angleBetween(r,o))}function zs(n){if(!a(n)||n.length<2)throw new Error("数组长度应大于1");for(var e=0,t=0;t<n.length-1;t++){var i=n[t],s=n[t+1];e+=d.distance(i,s)}return e}function Mi(n){for(var e=ns.triangulate(n.positions,n.holes),t=0,i=0;i<e.length;i+=3){var s=n.positions[e[i]],r=n.positions[e[i+1]],o=n.positions[e[i+2]],l=d.subtract(r,s,new d),c=d.subtract(o,s,new d),h=d.cross(l,c,new d);t+=d.magnitude(h)/2}return t}function Bs(n,e){var t=new d;return d.midpoint(n,e,t),t}function Ns(n){for(var e=new d,t=new d,i=0;i<n.length;i++){var s=n[i];d.add(t,s,t)}return d.divideByScalar(t,n.length,e),e}function ve(n,e){var t=Lt(n),i,s=!1,r=t.globe.depthTestAgainstTerrain;r||(t.globe.depthTestAgainstTerrain=!0,s=!0);var o=t.pick(e);if(t.pickPositionSupported&&a(o)&&(i=t.pickPosition(e)),!a(i)){var l=t.camera.getPickRay(e);i=t.globe.pick(l,t)}return s&&(t.globe.depthTestAgainstTerrain=!1),i}function Ws(n,e,t,i,s){let r=[],o,l=i||Ee(n,e),c=s||Ee(n,t);return a(l)&&a(c)&&(c.z>l.z?(o=Et(n,l.x,l.y,c.z),[e,t]=[t,e]):o=Et(n,c.x,c.y,l.z),r.push(t),r.push(o),r.push(e)),r}function Vs(n,e=!1){let t=new he(n);return e?t.getArray():t}function Fi(n){for(var e=[],t=[],i=0;i<n.length;i++){var s=q.fromCartesian(n[i]);e.push(s.longitude),t.push(s.latitude)}var r=0,o=0,l=0,c=0,h=0,u=0,f=0,m=0;for(i=0;i<n.length;i++)r=e[i],o=t[i],i==n.length-1?(l=e[0],c=t[0]):(l=e[i+1],c=t[i+1]),u=r*c-l*o,h+=u,f+=(r+l)*u,m+=(o+c)*u;return h*=.5,f/=6*h,m/=6*h,q.toCartesian(new q(f,m))}function Oi(n){return[[n[0],n[3]],[n[2],n[3]],[n[2],n[1]],[n[0],n[1]],[n[0],n[3]]]}function Ri(n,e,t,i){let s=le.eastNorthUpToFixedFrame(new d.fromDegrees(n,e)),r=O.inverse(s,new O),o=O.multiplyByPoint(r,new d.fromDegrees(n,e),new d),l=O.multiplyByPoint(r,new d.fromDegrees(t,i),new d),h=Math.atan2(l.y-o.y,l.x-o.x)*(180/T.PI);return h<0&&(h=h+360),h}function Us(n,e,t){let i=le.eastNorthUpToFixedFrame(n),s=Q.fromRotationZ(T.toRadians(e||0)),r=O.fromRotationTranslation(s);return O.multiply(i,r,i),O.multiplyByPoint(i,new d(0,t,0),new d)}let x={pickPosition:ve,getCentroid:Ns,getCenter:Bs,getArea:Mi,getDistance:zs,getAngle:Hs,lngLatToCartesian:Et,formatLngLatAlt:Vs,cartesianToLngLat:Ee,cartoToLngLat:Rs,getCartesian:Os,getRightTriangle:Ws,computeCentroidOfPolygon:Fi,boundsToPolygon:Oi,courseAngle:Ri,byDirectionAndLen:Us};const L=function(n,e){M(n);let t=n._viewer;return e?t.cesiumWidget:t},ce=function(n){return M(n),n._viewer.scene},it=function(n){return M(n),n._viewer.scene.camera},de=function(n){return M(n),n._viewer.scene.canvas},Gs=function(n){return M(n),n._viewer.scene.globe.ellipsoid};function N(n){return d.clone(n)}function Pt(n,e){if(!a(n))return;let t=Se(n,e);return a(t)?(n.entities.remove(t),!0):!1}function Se(n,e){if(!a(n)||!a(n.entities))return;let t=n.entities.values;for(let i=0;i<t.length;i++){let s=t[i];if(s.name==e)return s}}function js(n){let e=n.canvas.clientWidth/2,t=n.canvas.clientHeight/2,i=n.camera.getPickRay(new E(e,t)),s=n.globe.pick(i,n);return!!a(s)}function $s(n){let e=L(n),t=!1,i=$(),s=e.clock.onTick.addEventListener(function(){let r=$();r<i+100||(i=r,t=js(e.scene),t&&(n.dispatchEvent({type:"ready"}),s(),s=null))})}function Ys(n){let e=Xe(n);return ge.createElement("div",{style:"display:none",id:"creditContainer",container:e}),e}const Hi=new Kn;function zi(n,e,t){let i,s=n.camera.getPickRay(new E(e|0,t)),r=n.camera.getPickRay(new E(1+e|0,t)),o=n.globe,l=o.pick(s,n),c;if(a(l)&&(c=o.pick(r,n),a(c))){let h=o.ellipsoid.cartesianToCartographic(l),u=o.ellipsoid.cartesianToCartographic(c);Hi.setEndPoints(h,u),i=Hi.surfaceDistance}return i}function Zs(n){let e,t=n.canvas.clientWidth,i=n.canvas.clientHeight;return e=zi(n,t/2,i-1),a(e)||(e=zi(n,t/2,i/2)),e}function Js(n){const e=L(n);let t=a(e.cesiumWidget)?e.cesiumWidget:e;t.options=p(t.options,{});let i=$();const s=e.scene.camera;let r=!0;s.moveStart.addEventListener(function(){r=!0}),s.moveEnd.addEventListener(function(){r=!1}),e.scene.postRender.addEventListener(function(){if(!r)return;let o=$();if($()<i+30)return;i=o;let l=Zs(e.scene);t.options.pixelDistance=l,n.dispatchEvent({type:"update",options:{pd:l}})})}let Bi=ge.createElement;class Ks{constructor(e,t){this.container=Bi("div",{id:"liglobe-title-container",container:e}),this.titleElement=Bi("span",{id:"liglobe-title-text",container:this.container}),a(t)&&this.setTitle(t)}show(e){let t=p(e,!0);this.container.style.display=t?"":"none"}setTitle(e){this.titleElement.innerHTML=e}}function qs(n,e){n.title=new Ks(n.domElement,e)}function nt(n){let e="";switch(n){case"distance":e="measure/distance.svg";break;case"area":e="measure/area.svg";break;case"angle":e="measure/angle.png";break;case"height":e="measure/height.svg";break;case"remove":e="measure/remove.svg";break;case"ttdetail":e="pointcloud/detail.png";break;case"ttpanorama":e="pointcloud/panorama.png";break;case"ttred":e="pointcloud/red.png";break;default:return""}return`${R()}/Assets/Images/${e}`}function xt(n,e,t){var i=document.createElement("link");i.rel="stylesheet",i.type="text/css",i.href=n,i.onload=e,i.onerror=t,document.getElementsByTagName("head")[0].appendChild(i)}const kt=[1,2,3,5,10,20,30,50,100,200,300,500,1e3,2e3,3e3,5e3,1e4,2e4,3e4,5e4,1e5,2e5,3e5,5e5,1e6,2e6,3e6,5e6,1e7,2e7,3e7,5e7];function Ni(n,e){if(!n.enableDistanceLegend){n.barWidth=void 0,n.distanceLabel=void 0;return}var t=$();if(!(t<n._lastLegendUpdate+200)){n._lastLegendUpdate=t;var i=n.viewer.options.pixelDistance;if(!a(i)){n.barWidth=void 0,n.distanceLabel=void 0;return}for(var s=100,r,o=kt.length-1;!a(r)&&o>=0;--o)kt[o]/i<s&&(r=kt[o]);if(a(r)&&r<5e6){var l;r>=1e3?l=(r/1e3).toString()+" km":l=r.toString()+" m",n.barWidth=r/i|0,n.distanceLabel=l}else n.barWidth=void 0,n.distanceLabel=void 0}}class It{constructor(e){if(!a(e)||!a(e.viewer))throw new Error("options.viewer is required.");this.viewer=e.viewer,this._removeSubscription=void 0,this._lastLegendUpdate=void 0,this.eventHelper=new bi,this.distanceLabel=void 0,this.barWidth=void 0,this.enableDistanceLegend=p(e.enableDistanceLegend,!0),vt.track(this,["distanceLabel","barWidth"]);var t=this,i=t.viewer.scene;function s(){a(t.viewer)&&t.enableDistanceLegend?(a(t._removeSubscription)&&(t._removeSubscription(),t._removeSubscription=void 0),t._removeSubscription=i.postRender.addEventListener(function(){Ni(t)},t)):(a(t._removeSubscription)&&(t._removeSubscription(),t._removeSubscription=void 0),Ni(t))}this.eventHelper.add(this.viewer.afterWidgetChanged,function(){s()},this),s()}show(e){var t=this.enableDistanceLegend?"":'style="display: none;"',i=`<div class="distance-legend" ${t} data-bind="visible: distanceLabel && barWidth">
          <div class="distance-legend-label"  data-bind="text: distanceLabel"></div>
          <div class="distance-legend-scale-bar"  data-bind="style: { width: barWidth + 'px', left: (5 + (125 - barWidth) / 2) + 'px' }"></div>
          </div>`;Tt(i,e,this)}destroy(){this.eventHelper.removeAll()}static create(e){var t=new It(e);return t.show(e.container),t}}var Xs=new q,At=new Di;function st(n,e,t){var i=n.scene,s=i.camera;if(i.mode!==z.MORPHING&&(a(t)||(t=new d),a(n.trackedEntity)?t=n.trackedEntity.position.getValue(n.clock.currentTime,t):(At.origin=s.positionWC,At.direction=s.directionWC,t=i.globe.pick(At,i,t)),!!a(t)))return i.mode===z.SCENE2D||i.mode===z.COLUMBUS_VIEW?(t=s.worldToCameraCoordinatesPoint(t,t),e&&(t=i.globe.ellipsoid.cartographicToCartesian(i.mapProjection.unproject(t,Xs),t))):e||(t=s.worldToCameraCoordinatesPoint(t,t)),t}class Wi{constructor(){this.name="Unnamed Control",this.text=void 0,this.svgIcon=void 0,this.svgHeight=void 0,this.svgWidth=void 0,this.cssClass=void 0,this.isActive=!1}activate(){throw new Error("activate must be implemented in the derived class.")}get hasText(){return a(this.text)&&typeof this.text=="string"}}var Qs=new d;class Vi extends Wi{constructor(e,t){super(),this.viewer=e,this.name=t?"放大":"缩小",this.text=t?"+":"−",this.cssClass="navigation-control-icon-zoom-"+(t?"in":"out"),this.relativeAmount=2,t&&(this.relativeAmount=1/this.relativeAmount)}zoom(e){if(this.isActive=!0,a(this.viewer)){var t=this.viewer.scene,i=t.screenSpaceCameraController;if(!i.enableInputs||!i.enableZoom)return;var s=t.camera,r;switch(t.mode){case z.MORPHING:break;case z.SCENE2D:s.zoomIn(s.positionCartographic.height*(1-this.relativeAmount));break;default:{var o;if(a(this.viewer.trackedEntity)?o=new d:o=st(this.viewer,!1),a(o))r={direction:s.direction,up:s.up};else{var l=new Di(s.worldToCameraCoordinatesPoint(t.globe.ellipsoid.cartographicToCartesian(s.positionCartographic)),s.directionWC);o=ts.grazingAltitudeLocation(l,t.globe.ellipsoid),r={heading:s.heading,pitch:s.pitch,roll:s.roll}}var c=d.subtract(s.position,o,Qs),h=d.multiplyByScalar(c,e,c),u=d.add(o,h,o);a(this.viewer.trackedEntity)||t.mode===z.COLUMBUS_VIEW?s.position=u:s.flyTo({destination:u,orientation:r,duration:.5,convert:!1})}}}}activate(){this.zoom(this.relativeAmount)}}class er extends Wi{constructor(e){super(),this.viewer=e,this.name="重置视角",this.svgHeight=15,this.svgWidth=15,this.cssClass="navigation-control-icon-reset"}resetView(){var e=this.viewer.scene,t=e.screenSpaceCameraController;if(t.enableInputs){this.isActive=!0;var i=e.camera;if(a(this.viewer.trackedEntity)){var s=this.viewer.trackedEntity;this.viewer.trackedEntity=void 0,this.viewer.trackedEntity=s}else if(a(this.viewer.options)&&a(this.viewer.options.defaultResetView)){var r=this.viewer.options.defaultResetView;if(r&&r instanceof q)i.flyTo({destination:e.globe.ellipsoid.cartographicToCartesian(r)});else if(r&&r instanceof ne)try{ne.validate(r),i.flyTo({destination:r})}catch{console.log("ResetViewNavigationControl: options.defaultResetView rectangle is invalid!")}}else typeof i.flyHome=="function"?i.flyHome(1):i.flyTo({destination:gt.DEFAULT_VIEW_RECTANGLE,duration:1});this.isActive=!1}}activate(){this.resetView()}}var Mt=new O,rt=new O,Ft=new d,Ot=new E;function tr(n,e,t){var i=n.viewer.scene,s=i.screenSpaceCameraController;if(i.mode===z.MORPHING||!s.enableInputs)return;switch(i.mode){case z.COLUMBUS_VIEW:if(s.enableLook)break;if(!s.enableTranslate||!s.enableTilt)return;break;case z.SCENE3D:if(s.enableLook)break;if(!s.enableTilt||!s.enableRotate)return;break;case z.SCENE2D:if(!s.enableTranslate)return;break}document.removeEventListener("mousemove",n.orbitMouseMoveFunction,!1),document.removeEventListener("mouseup",n.orbitMouseUpFunction,!1),a(n.orbitTickFunction)&&n.viewer.clock.onTick.removeEventListener(n.orbitTickFunction),n.orbitMouseMoveFunction=void 0,n.orbitMouseUpFunction=void 0,n.orbitTickFunction=void 0,n.isOrbiting=!0,n.orbitLastTimestamp=$();var r=i.camera;if(a(n.viewer.trackedEntity))n.orbitFrame=void 0,n.orbitIsLook=!1;else{var o=st(n.viewer,!0,Ft);a(o)?(n.orbitFrame=le.eastNorthUpToFixedFrame(o,i.globe.ellipsoid,rt),n.orbitIsLook=!1):(n.orbitFrame=le.eastNorthUpToFixedFrame(r.positionWC,i.globe.ellipsoid,rt),n.orbitIsLook=!0)}n.orbitTickFunction=function(c){var h=$(),u=h-n.orbitLastTimestamp,f=(n.orbitCursorOpacity-.5)*2.5/1e3,m=u*f,w=n.orbitCursorAngle+T.PI_OVER_TWO,y=Math.cos(w)*m,v=Math.sin(w)*m,C;a(n.orbitFrame)&&(C=O.clone(r.transform,Mt),r.lookAtTransform(n.orbitFrame)),i.mode===z.SCENE2D?r.move(new d(y,v,0),Math.max(i.canvas.clientWidth,i.canvas.clientHeight)/100*r.positionCartographic.height*m):n.orbitIsLook?(r.look(d.UNIT_Z,-y),r.look(r.right,-v)):(r.rotateLeft(y),r.rotateUp(v)),a(n.orbitFrame)&&r.lookAtTransform(C),n.orbitLastTimestamp=h};function l(c,h){var u=Math.atan2(-c.y,c.x);n.orbitCursorAngle=T.zeroToTwoPi(u-T.PI_OVER_TWO);var f=E.magnitude(c),m=h/2,w=Math.min(f/m,1),y=.5*w*w+.5;n.orbitCursorOpacity=y}n.orbitMouseMoveFunction=function(c){var h=e.getBoundingClientRect(),u=new E((h.right-h.left)/2,(h.bottom-h.top)/2),f=new E(c.clientX-h.left,c.clientY-h.top),m=E.subtract(f,u,Ot);l(m,h.width)},n.orbitMouseUpFunction=function(c){n.isOrbiting=!1,document.removeEventListener("mousemove",n.orbitMouseMoveFunction,!1),document.removeEventListener("mouseup",n.orbitMouseUpFunction,!1),a(n.orbitTickFunction)&&n.viewer.clock.onTick.removeEventListener(n.orbitTickFunction),n.orbitMouseMoveFunction=void 0,n.orbitMouseUpFunction=void 0,n.orbitTickFunction=void 0},document.addEventListener("mousemove",n.orbitMouseMoveFunction,!1),document.addEventListener("mouseup",n.orbitMouseUpFunction,!1),n.viewer.clock.onTick.addEventListener(n.orbitTickFunction),l(t,e.getBoundingClientRect().width)}function ir(n,e,t){if(n.viewer.options.enableCompassOuterRing=p(n.viewer.options.enableCompassOuterRing,!0),n.viewer.options.enableCompassOuterRing){var i=n.viewer.scene,s=i.camera,r=i.screenSpaceCameraController;if(i.mode===z.MORPHING||i.mode===z.SCENE2D||!r.enableInputs||!r.enableLook&&(i.mode===z.COLUMBUS_VIEW||i.mode===z.SCENE3D&&!r.enableRotate))return;if(document.removeEventListener("mousemove",n.rotateMouseMoveFunction,!1),document.removeEventListener("mouseup",n.rotateMouseUpFunction,!1),n.rotateMouseMoveFunction=void 0,n.rotateMouseUpFunction=void 0,n.isRotating=!0,n.rotateInitialCursorAngle=Math.atan2(-t.y,t.x),a(n.viewer.trackedEntity))n.rotateFrame=void 0,n.rotateIsLook=!1;else{var o=st(n.viewer,!0,Ft);!a(o)||i.mode===z.COLUMBUS_VIEW&&!r.enableLook&&!r.enableTranslate?(n.rotateFrame=le.eastNorthUpToFixedFrame(s.positionWC,i.globe.ellipsoid,rt),n.rotateIsLook=!0):(n.rotateFrame=le.eastNorthUpToFixedFrame(o,i.globe.ellipsoid,rt),n.rotateIsLook=!1)}var l;a(n.rotateFrame)&&(l=O.clone(s.transform,Mt),s.lookAtTransform(n.rotateFrame)),n.rotateInitialCameraAngle=-s.heading,a(n.rotateFrame)&&s.lookAtTransform(l),n.rotateMouseMoveFunction=function(c){var h=e.getBoundingClientRect(),u=new E((h.right-h.left)/2,(h.bottom-h.top)/2),f=new E(c.clientX-h.left,c.clientY-h.top),m=E.subtract(f,u,Ot),w=Math.atan2(-m.y,m.x),y=w-n.rotateInitialCursorAngle,v=T.zeroToTwoPi(n.rotateInitialCameraAngle-y),C=n.viewer.scene.camera,_;a(n.rotateFrame)&&(_=O.clone(C.transform,Mt),C.lookAtTransform(n.rotateFrame));var P=-C.heading;C.rotateRight(v-P),a(n.rotateFrame)&&C.lookAtTransform(_)},n.rotateMouseUpFunction=function(c){n.isRotating=!1,document.removeEventListener("mousemove",n.rotateMouseMoveFunction,!1),document.removeEventListener("mouseup",n.rotateMouseUpFunction,!1),n.rotateMouseMoveFunction=void 0,n.rotateMouseUpFunction=void 0},document.addEventListener("mousemove",n.rotateMouseMoveFunction,!1),document.addEventListener("mouseup",n.rotateMouseUpFunction,!1)}}class Rt{constructor(e){this.viewer=e.viewer,this.eventHelper=new bi,this.enableZoomControls=p(e.enableZoomControls,!0),this.enableCompass=p(e.enableCompass,!0),this.controls=e.controls,a(this.controls)||(this.controls=[new Vi(this.viewer,!0),new er(this.viewer),new Vi(this.viewer,!1)]),this.showCompass=a(this.viewer)&&this.enableCompass,this.heading=this.showCompass?this.viewer.scene.camera.heading:0,this.isOrbiting=!1,this.orbitCursorAngle=0,this.orbitCursorOpacity=0,this.orbitLastTimestamp=0,this.orbitFrame=void 0,this.orbitIsLook=!1,this.orbitMouseMoveFunction=void 0,this.orbitMouseUpFunction=void 0,this.isRotating=!1,this.rotateInitialCursorAngle=void 0,this.rotateFrame=void 0,this.rotateIsLook=!1,this.rotateMouseMoveFunction=void 0,this.rotateMouseUpFunction=void 0,this._unsubcribeFromPostRender=void 0,vt.track(this,["controls","showCompass","heading","isOrbiting","orbitCursorAngle","isRotating"]);var t=this;function i(){a(t.viewer)&&t.enableCompass?(t._unsubcribeFromPostRender&&(t._unsubcribeFromPostRender(),t._unsubcribeFromPostRender=void 0),t.showCompass=!0,t._unsubcribeFromPostRender=t.viewer.scene.postRender.addEventListener(function(){t.heading=t.viewer.scene.camera.heading},t)):(t._unsubcribeFromPostRender&&(t._unsubcribeFromPostRender(),t._unsubcribeFromPostRender=void 0),t.showCompass=!1)}this.eventHelper.add(this.viewer.afterWidgetChanged,i,this),i()}static create(e){var t=new Rt(e);return t.show(e.container),t}destroy(){this.eventHelper.removeAll()}show(e){var t=this.enableCompass?"":'style="display: none;" ',i=this.enableZoomControls?"":'style="display: none;" ',s=`<div class="compass" ${t} title="按下鼠标左键并向四周拖拽不释放可修改视图角度.双击:重置视图." 
          data-bind="visible: showCompass, event: { mousedown: handleMouseDown, dblclick: handleDoubleClick }">
          <div class="compass-outer-ring-background"></div>
           <div class="compass-rotation-marker" data-bind="visible: isOrbiting, style: { transform: 'rotate(-' + orbitCursorAngle + 'rad)', '-webkit-transform': 'rotate(-' + orbitCursorAngle + 'rad)', opacity: orbitCursorOpacity }"></div>
           <div class="compass-outer-ring" title="单击并拖动可修改视角" data-bind="style: { transform: 'rotate(-' + heading + 'rad)', '-webkit-transform': 'rotate(-' + heading + 'rad)' }"></div>
           <div class="compass-gyro-background"></div>
           <div class="compass-gyro" data-bind="css: { 'compass-gyro-active': isOrbiting }"></div>
          </div>
          <div id="navigation-zoomControls" class="navigation-controls user-select" ${i}>
          <!-- ko foreach: controls -->
          <div data-bind="click: activate, attr: { title: $data.name }, css: $root.isLastControl($data) ? 'navigation-control-last' : 'navigation-control' ">
             <div data-bind="text: $data.text, css: $data.isActive ?  'navigation-control-icon-active ' + $data.cssClass : $data.cssClass"></div>
      
           </div>
           <!-- /ko -->
          </div>`;Tt(s,e,this)}add(e){this.controls.push(e)}remove(e){this.controls.remove(e)}isLastControl(e){return e===this.controls[this.controls.length-1]}handleMouseDown(e,t){var i=this.viewer.scene;if(i.mode===z.MORPHING)return!0;var s=t.currentTarget,r=t.currentTarget.getBoundingClientRect(),o=r.width/2,l=new E((r.right-r.left)/2,(r.bottom-r.top)/2),c=new E(t.clientX-r.left,t.clientY-r.top),h=E.subtract(c,l,Ot),u=E.magnitude(h),f=u/o,m=145,w=50;if(f<w/m)tr(this,s,h);else if(f<1)ir(this,s,h);else return!0}handleDoubleClick(e,t){var i=e.viewer.scene,s=i.camera,r=i.screenSpaceCameraController;if(i.mode===z.MORPHING||!r.enableInputs)return!0;if(!(i.mode===z.COLUMBUS_VIEW&&!r.enableTranslate)&&!((i.mode===z.SCENE3D||i.mode===z.COLUMBUS_VIEW)&&(!r.enableLook||i.mode===z.SCENE3D&&!r.enableRotate))){var o=st(e.viewer,!0,Ft);if(!a(o)){this.controls[1].resetView();return}var l=i.globe.ellipsoid.cartographicToCartesian(s.positionCartographic,new d),c=i.globe.ellipsoid.geodeticSurfaceNormal(o),h=new Yn(o,0);s.flyToBoundingSphere(h,{offset:new Ve(0,T.PI_OVER_TWO-d.angleBetween(c,s.directionWC),d.distance(l,o)),duration:1.5})}}}class nr{constructor(e,t){this.distanceLegendViewModel=void 0,this.navigationViewModel=void 0,this.navigationDiv=void 0,this.distanceLegendDiv=void 0,this.container=void 0,this._onDestroyListeners=void 0,t=p(t,{});var i=p(t.enableDistanceLegend,!0),s=p(t.enableZoomControls,!0),r=p(t.enableCompass,!0),o=document.createElement("div");e.container.appendChild(o),this.viewer=e,this.viewer.options=t,this.viewer.afterWidgetChanged=new qe,this.viewer.beforeWidgetChanged=new qe,this.container=o,this.distanceLegendDiv=document.createElement("div"),o.appendChild(this.distanceLegendDiv),this.distanceLegendDiv.setAttribute("id","distanceLegendDiv"),this.distanceLegendViewModel=It.create({container:this.distanceLegendDiv,viewer:this.viewer,mapElement:o,enableDistanceLegend:i}),this.navigationDiv=document.createElement("div"),this.navigationDiv.setAttribute("id","navigationDiv"),o.appendChild(this.navigationDiv),this.navigationViewModel=Rt.create({container:this.navigationDiv,viewer:this.viewer,enableZoomControls:s,enableCompass:r}),this._onDestroyListeners=[]}get enableCompass(){if(a(this.navigationViewModel))return this.navigationViewModel.enableCompass}set enableCompass(e){a(this.navigationViewModel)&&this.navigationViewModel.enableCompass!==e&&(this.navigationViewModel.enableCompass=e,this.viewer.afterWidgetChanged.raiseEvent())}get enableZoomControls(){if(a(this.navigationViewModel))return this.navigationViewModel.enableZoomControls}set enableZoomControls(e){if(a(this.navigationViewModel)&&this.navigationViewModel.enableZoomControls!==e){this.navigationViewModel.enableZoomControls=e;var t=Xe("navigation-zoomControls");t.style.display=e?"":"none"}}get enableDistanceLegend(){if(a(this.distanceLegendViewModel))return this.distanceLegendViewModel.enableDistanceLegend}set enableDistanceLegend(e){a(this.distanceLegendViewModel)&&this.distanceLegendViewModel.enableDistanceLegend!==e&&(this.distanceLegendViewModel.enableDistanceLegend=e,this.viewer.afterWidgetChanged.raiseEvent())}set defaultResetView(e){this.viewer.options.defaultResetView=e}addOnDestroyListener(e){typeof e=="function"&&this._onDestroyListeners.push(e)}destroy(){a(this.navigationViewModel)&&this.navigationViewModel.destroy(),a(this.distanceLegendViewModel)&&this.distanceLegendViewModel.destroy(),a(this.navigationDiv)&&this.navigationDiv.parentNode.removeChild(this.navigationDiv),delete this.navigationDiv,a(this.distanceLegendDiv)&&this.distanceLegendDiv.parentNode.removeChild(this.distanceLegendDiv),delete this.distanceLegendDiv,a(this.container)&&this.container.parentNode.removeChild(this.container),delete this.container;for(var e=0;e<this._onDestroyListeners.length;e++)this._onDestroyListeners[e]()}}class Ui{constructor(e){M(e),this.map=e,this.navigation=void 0}attach(e){a(this.navigation)&&this.detach();let t=this;xt(R()+"/Assets/css/navigation.css",function(){t.navigation=new nr(L(t.map,!0),e)})}detach(){a(this.navigation)&&(this.navigation.destroy(),this.navigation=void 0)}set enableCompass(e){a(this.navigation)&&(this.navigation.enableCompass=e)}set enableZoomControls(e){a(this.navigation)&&(this.navigation.enableZoomControls=e)}set enableDistanceLegend(e){a(this.navigation)&&(this.navigation.enableDistanceLegend=e)}get enableCompass(){if(a(this.navigation))return this.navigation.enableCompass}get enableZoomControls(){if(a(this.navigation))return this.navigation.enableZoomControls}get enableDistanceLegend(){if(a(this.navigation))return this.navigation.enableDistanceLegend}}function Ht(n){M(n);let e=n.toolManager.navigationControl;return a(e)&&e instanceof Ui||(e=new Ui(n),n.toolManager.navigationControl=e),e}function sr(n,e){let t=L(n),i={maxZoom:5e7,minZoom:1,defaultView:[30,-10,180,80]};re(e)?Object.entries(i).forEach(([s,r])=>{i[s]=p(e[s],r)}):e={},t.scene.screenSpaceCameraController.minimumZoomDistance=i.minZoom,t.scene.screenSpaceCameraController.maximumZoomDistance=i.maxZoom,G(i.defaultView)&&(gt.DEFAULT_VIEW_RECTANGLE=ne.fromDegrees(...i.defaultView),G(e.initView)?n.goTo({duration:0,rectangle:e.initView}):t.camera.flyHome(0)),n.addEventListener("ready",function(){if(qs(n,e.title),a(e.navigationControl)){let s=p(e.navigationControl,{});new Ht(n).attach(s)}})}function rr(n={}){n=p(n,{});let e=p(".jpg"),t=n.basePath;if(a(t))return new rs({sources:{positiveX:t+p(n.px,"right1")+e,negativeX:t+p(n.nx,"left2")+e,positiveY:t+p(n.py,"bottom4")+e,negativeY:t+p(n.ny,"top3")+e,positiveZ:t+p(n.pz,"front5")+e,negativeZ:t+p(n.nz,"back6")+e}})}function or(n,e={}){e=p(e,{}),lo(function(){n.skyBox=rr(p(e.skybox,{basePath:Pn()+"SkyBox/u_"}))})}class ee{constructor(){this._listeners={}}addEventListener(e,t){const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t);let s=this;return function(){s.removeEventListener(e,t)}}hasEventListener(e,t){const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){let s=this._listeners[e];if(s!==void 0){let r=s.indexOf(t);r!==-1&&s.splice(r,1)}}removeEventListeners(e){this._listeners[e]!==void 0&&delete this._listeners[e]}dispatchEvent(e){let i=this._listeners[e.type];if(i!==void 0){e.target=this;for(let s of i.slice(0))s.call(this,e)}}}class ar extends ee{constructor(){super(),this.measurements=[],this.layers=[],this.powerLines=[],this.flightLines=[],this.sightLines=[],this.viewsheds=[],this.terrainProfiles=[],this.bufferAnalysiss=[]}addPowerLine(e){this.powerLines.push(e),this.dispatchEvent({type:"powerLine_added",scene:this,powerLine:e})}removePowerLine(e){let t=this.powerLines.indexOf(e);t>-1&&(this.powerLines.splice(t,1),this.dispatchEvent({type:"powerLine_removed",scene:this,powerLine:e}))}addFlightLine(e){this.flightLines.push(e),this.dispatchEvent({type:"flightLine_added",scene:this,flightLine:e})}removeFlightLine(e){let t=this.flightLines.indexOf(e);t>-1&&(this.flightLines.splice(t,1),this.dispatchEvent({type:"flightLine_removed",scene:this,flightLine:e}))}addLayer(e){this.layers.push(e),this.dispatchEvent({type:"layer_added",scene:this,layer:e})}removeLayer(e){let t=this.layers.indexOf(e);t>-1&&(this.layers.splice(t,1),this.dispatchEvent({type:"layer_removed",scene:this,layer:e}))}addMeasurement(e){this.measurements.push(e),this.dispatchEvent({type:"measurement_added",scene:this,measurement:e})}removeMeasurement(e){let t=this.measurements.indexOf(e);t>-1&&(this.measurements.splice(t,1),this.dispatchEvent({type:"measurement_removed",scene:this,measurement:e}))}addSightLine(e){this.sightLines.push(e),this.dispatchEvent({type:"sightLine_added",scene:this,sightLine:e})}removeSightLine(e){let t=this.sightLines.indexOf(e);t>-1&&(this.sightLines.splice(t,1),this.dispatchEvent({type:"sightLine_removed",scene:this,sightLine:e}))}addViewshed(e){this.viewsheds.push(e),this.dispatchEvent({type:"viewshed_added",scene:this,viewshed:e})}removeViewshed(e){let t=this.viewsheds.indexOf(e);t>-1&&(this.viewsheds.splice(t,1),this.dispatchEvent({type:"viewshed_removed",scene:this,viewshed:e}))}addTerrainProfile(e){this.terrainProfiles.push(e),this.dispatchEvent({type:"terrainProfile_added",scene:this,terrainProfile:e})}removeTerrainProfile(e){let t=this.terrainProfiles.indexOf(e);t>-1&&(this.terrainProfiles.splice(t,1),this.dispatchEvent({type:"terrainProfile_removed",scene:this,terrainProfile:e}))}addBufferAnalysis(e){this.bufferAnalysiss.push(e),this.dispatchEvent({type:"bufferAnalysis_added",scene:this,bufferAnalysis:e})}removeBufferAnalysis(e){let t=this.bufferAnalysiss.indexOf(e);t>-1&&(this.bufferAnalysiss.splice(t,1),this.dispatchEvent({type:"bufferAnalysis_removed",scene:this,bufferAnalysis:e}))}removeAllMeasurements(){for(;this.measurements.length>0;)this.removeMeasurement(this.measurements[0])}removeAllTerrainProfiles(){for(;this.terrainProfiles.length>0;)this.removeTerrainProfile(this.terrainProfiles[0])}removeAllBufferAnalysiss(){for(;this.bufferAnalysiss.length>0;)this.removeBufferAnalysis(this.bufferAnalysiss[0])}removeAllSightLines(){for(;this.sightLines.length>0;)this.removeSightLine(this.sightLines[0])}removeAllViewsheds(){for(;this.viewsheds.length>0;)this.removeViewshed(this.viewsheds[0])}removeAllFlightLines(){for(;this.flightLines.length>0;)this.removeFlightLine(this.flightLines[0])}removeAllPowerLines(){for(;this.powerLines.length>0;)this.removePowerLine(this.powerLines[0])}}const ba="";function lr(n){const e=L(n),t=e.camera;let i=x.cartesianToLngLat(e,t.position),s=T.toDegrees(t.heading),r=T.toDegrees(t.pitch),o=T.toDegrees(t.roll);return{position:i.getArray(),pitch:r,heading:s,roll:o}}function hr(n,e){let t=it(n);if(re(e)){let i=e;if(i.duration=p(e.duration,2),i.pitchAdjustHeight=5e3,(De(e.heading)||De(e.pitch)||De(e.roll)||G(e.direction)||G(e.up))&&(i.orientation={},a(e.direction)&&(i.orientation.direction=x.getCartesian(e.direction)),a(e.up)&&(i.orientation.up=x.getCartesian(e.up)),a(e.heading)&&(i.orientation.heading=T.toRadians(e.heading)),a(e.pitch)&&(i.orientation.pitch=T.toRadians(e.pitch)),a(e.roll)&&(i.orientation.roll=T.toRadians(e.roll))),a(i.destination)){(i.destination instanceof d||i.destination instanceof ne)&&t.flyTo(i);return}else if(a(e.position)){i.destination=he.getCartesian(e.position),t.flyTo(i);return}else if(G(e.rectangle)){i.destination=ne.fromDegrees(...e.rectangle),t.flyTo(i);return}}}function cr(n,e){if(n&&n.id){e=p(e,{});let t=n.id.entityCollection._owner.tag,i=e.tag;if(a(i))if(ai(i)||G(i)){if(i.indexOf(t)==-1)return}else throw new Error("");if(n.id instanceof me){let s=n.id.properties._propertyNames,r={};for(let o=0;o<s.length;o++){const l=s[o],c=n.id.properties[l];r[l]=c._value}return n.feature=r,a(t)&&(n.tag=t),n}}}const dr=`
  uniform sampler2D colorTexture;
  in vec2 v_textureCoordinates;
  uniform vec4 highlight;
  void main() {
      vec4 color = texture(colorTexture, v_textureCoordinates);
      if (czm_selected()) {
          vec3 highlighted = highlight.a * highlight.rgb + (1.0 - highlight.a) * color.rgb;
          out_FragColor = vec4(highlighted, 1.0);
      } else { 
          out_FragColor = color;
      }
  }
  `;let we={};function ur(n){let e=ce(n);we=e.postProcessStages.add(new Ei({fragmentShader:dr,uniforms:{highlight:function(){return new A(1,0,0,.5)}}})),we.selected=[],n.pickObject=function(i){return e.pick(i)},n.pickGeojson=function(i,s){let r=n.pickObject(i);return cr(r,s)},n.pickPosition=function(i){let s=x.pickPosition(L(n),i);if(a(s))return x.cartesianToLngLat(L(n),s)};function t(i,s,r){i.children.forEach(o=>{if(o.content){o.content.innerContents&&o.content.innerContents.forEach(c=>{let h=c.featuresLength;for(let u=0;u<h;++u){let f=c.getFeature(u);s==f.getProperty("name")&&r.push(f)}});let l=o.content.featuresLength;for(let c=0;c<l;++c){let h=o.content.getFeature(c);s==h.getProperty("name")&&r.push(h)}}t(o,s,r)})}n.pick3DTileFeature=function(i){if(n.isTooling)return;let r=L(n).scene.pick(i);if(!r||!(r instanceof _s)){we.selected=[],we.pickedFeature=void 0;return}if(r===we.pickedFeature)return;we.selected=[],we.pickedFeature=r;let o=r.getProperty("name"),l=[];t(r.tileset.root,o,l),l.length<2&&l.push(r),we.selected=l;let c={type:"",gtbh:""};if(o){let h=o.split("_");switch(c.type=h[0],h[0]){case"tower":c.gtbh=h[2];break;case"powerline":c.gtbh=h[3];break;case"groundline":c.gtbh=h[3];break;case"insulator":c.gtbh=h[1];break;case"ff":c.gtbh=h[1];break}switch(h[1]){case"T":c.gtbh=h[0],c.id=h[2],c.type="tower";break;case"I":c.gtbh=h[0],c.id=h[2],c.type="insulator";break}switch(h[2]){case"L":c.gtbh=h[0]+"_"+h[1],c.id=h[3],c.type="powerline";break;case"G":c.gtbh=h[0]+"_"+h[1],c.id=h[3],c.type="groundline";break}}return c}}function Gi(){we.selected=[]}let fr=x.pickPosition;class ji{constructor(e){this.map=e,this._eye=void 0,this._targets=[];let t=L(this.map);this.dataSource=new B,t.dataSources.add(this.dataSource);let i=this;this.insertionsHandler=this.map.addEventListener("cancel_insertions",function(){i.destroy()}),this._selected=void 0,this.handler=new ae(de(this.map));let s=$();this.handler.setInputAction(function(r){if($()-s<1e3||!a(i.selected))return;let o=fr(t.scene,r.position);a(o)&&(i.selected==="eye"?i.eye=o:i.selected==="target"&&i.addTarget(e,o),i.selected=void 0)},F.LEFT_CLICK)}get type(){return"sightline"}get selected(){return this._selected}set selected(e){(e==="eye"||e==="target")&&(this._selected=e)}_calculate(e){this.dataSource.entities.removeAll(),a(this.eye)&&this.addEye(this.eye);let t=this;a(this._targets)&&this._targets.length>0&&(this.dataSource.entities.suspendEvents(),this._targets.forEach(i=>{t._addTargetEntity(e,i)}),this.dataSource.entities.resumeEvents())}get eye(){return this._eye}set eye(e){this._eye=e,this._calculate(this.map)}addTarget(e,t){this._targets.push(t),this._addTargetEntity(e,t)}_addTargetEntity(e,t){let i={position:t,point:{color:A.YELLOW,pixelSize:8,distanceDisplayCondition:new k(0,1e5),disableDepthTestDistance:200}};if(a(this.eye)){let r=!1;const o=ce(this.map);o.globe.depthTestAgainstTerrain||(o.globe.depthTestAgainstTerrain=!0,r=!0),pr(e,this.eye,t,o,this.dataSource),r&&(o.globe.depthTestAgainstTerrain=!1)}let s=new me(i);return this.dataSource.entities.add(s),s}addEye(e){let t=new me({name:"eye",position:e,point:{color:A.RED,pixelSize:8,distanceDisplayCondition:new k(0,1e5),disableDepthTestDistance:200}});return this.dataSource.entities.add(t)}remove(){this.destroy();let e=L(this.map);a(this.dataSource)&&e.dataSources.remove(this.dataSource),delete this.dataSource,delete this._targets,delete this._eye}destroy(){a(this.handler)&&(a(this.insertionsHandler)&&(this.insertionsHandler(),delete this.insertionsHandler),this.handler.destroy(),delete this.handler,this.selected=void 0,(!a(this.eye)||this._targets.length==0)&&this.map.scene.removeSightLine(this))}}function pr(n,e,t,i,s,r,o){r||(r=1),o||(o=10);let l=[],c=d.distance(e,t);for(let u=0;u<c;u+=r){let f=d.lerp(e,t,u/c,new d);l.push(q.fromCartesian(f))}let h=Bt(l);ki(n._viewer.terrainProvider,14,l).then(function(u){let f;for(let m=1;m<h.length-2;m++){let w=u[m].height,y=h[m].height;if(d.distance(e,d.fromRadians(h[m].longitude,h[m].latitude,h[m].height))>o&&w>y){f=h[m];break}}f?(zt(s,e,d.fromRadians(f.longitude,f.latitude,f.height),A.GREEN),zt(s,d.fromRadians(f.longitude,f.latitude,f.height),t,A.RED)):zt(s,e,t,A.GREEN)})}function zt(n,e,t,i){return n.entities.add(new me({polyline:{positions:[e,t],material:i,width:2,distanceDisplayCondition:new k(0,1e5)}}))}function Bt(n){let e;if(typeof n=="object")if(Array.isArray(n)){e=[];for(let t in n)e.push(Bt(n[t]))}else if(n===null)e=null;else if(n.constructor===RegExp)e=n;else{e={};for(let t in n)e[t]=Bt(n[t])}else e=n;return e}class $i extends ee{constructor(e){super(),M(e),this.map=e,this.addEventListener("start_inserting_sightLine",()=>{e.dispatchEvent({type:"cancel_insertions"})}),e.scene.addEventListener("sightLine_removed",t=>{t.sightLine.remove()})}start(){this.dispatchEvent({type:"start_inserting_sightLine"});let e=new ji(this.map);return this.map.scene.addSightLine(e),e}}function Nt(n,e){M(n);let t=n.toolManager.sightLineTool;return a(t)&&t instanceof $i||(t=new $i(n,e),n.toolManager.sightLineTool=t),t}function ue(n,e){if(n<=0)return"";let t="m";e?n>99999&&(t="km",n=n/1e6):n>999&&(t="km",n=n/1e3),n=n.toFixed(2),n=n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");let i=n+" "+t;return e&&(i+="²"),i}function Fe(n){return n=n.toFixed(1),n+"°"}function mr(n,e,t,i,s,r){n.beginPath(),n.moveTo(e+r,t),n.lineTo(e+i-r,t),n.quadraticCurveTo(e+i,t,e+i,t+r),n.lineTo(e+i,t+s-r),n.quadraticCurveTo(e+i,t+s,e+i-r,t+s),n.lineTo(e+r,t+s),n.quadraticCurveTo(e,t+s,e,t+s-r),n.lineTo(e,t+r),n.quadraticCurveTo(e,t,e+r,t),n.closePath(),n.fill(),n.stroke()}function je(n,e={}){e=p(e,{});let t=p(e.fontSize,20),i=p(e.margin,5),s=p(e.top,5),r=p(e.bottom,0),o=a(e.font)?`${t}px ${e.font}`:`${t}px Arial`,l=p(e.borderWidth,3),c=p(e.fill,!0),h=p(e.stroke,!1),u=p(e.strokeColor,"rgba(0,0,0,1.0)"),f=p(e.backgroundColor,"rgba(0,0,0,0.5)"),m=p(e.borderColor,"rgba(0,0,0,0.8)"),w=p(e.textColor,"rgba(255,255,255,1.0)"),y=document.createElement("canvas"),v=y.getContext("2d");v.font=o;let C=n.split(`
`),_=0;for(let P=0;P<C.length;P++){const H=C[P];let X=v.measureText(H).width;X>_&&(_=X)}if(v.canvas.width=2*i+_+2*l,v.canvas.height=s+r+t*C.length+2*l+i*(C.length-1),v.font=o,v.textBaseline="bottom",v.fillStyle=f,v.strokeStyle=m,v.lineWidth=l,mr(v,l/2,l/2,v.canvas.width-l,v.canvas.height-l,6),h){v.strokeStyle=u;for(let P=0;P<C.length;P++){const H=C[P];v.strokeText(H,l+i,s+t*(P+1)+i*P+l)}}if(!h||c){v.fillStyle=w;for(let P=0;P<C.length;P++){const H=C[P];v.fillText(H,l+i,s+t*(P+1)+i*P+l)}}return y}class Wt extends ee{constructor(e){super(),this.map=e,this.distances=[];let t=L(this.map),i=ce(this.map);this.dataSource=new B,this.markers=[],this.totalLength=0,this.level=14,t.dataSources.add(this.dataSource);let s=this,r=function(o){let l,c=i.camera.getPickRay(o);return l=i.globe.pick(c,i),l};this.insertionsHandler=this.map.addEventListener("cancel_insertions",function(){s.destroy()}),this.handler=new ae(de(this.map)),this.handler.setInputAction(function(o){let l=r(o.position);if(!a(l))return;s.markers.push(l);let c={position:l,point:{color:A.RED,pixelSize:8,distanceDisplayCondition:new k(0,1e6),disableDepthTestDistance:0}};if(s.markers.length>1){s.totalLength=x.getDistance(s.markers);let u=ue(s.totalLength);c.billboard={image:je(u),horizontalOrigin:Qe.CENTER,verticalOrigin:tt.BOTTOM,pixelOffset:new E(0,-10),disableDepthTestDistance:Number.POSITIVE_INFINITY,distanceDisplayCondition:new k(0,1e5)};let f=s.markers[s.markers.length-2];c.polyline={positions:[f,l],material:A.YELLOW,clampToGround:!0,width:2,distanceDisplayCondition:new k(0,1e6)},s.distances.push(u)}let h=new me(c);s.dataSource.entities.add(h)},F.LEFT_CLICK),this.handler.setInputAction(function(){let o=s.dataSource.entities._entities._array,l="直线距离:"+s.distances[s.distances.length-1];o[o.length-1].billboard.image=je(l),s.destroy(),Re(s.map).calculate(s,function(){s.fireChart()})},F.RIGHT_CLICK)}get type(){return"terrain_profile"}fireChart(){a(this.markers)&&this.markers.length>1&&Re(this.map).dispatchEvent({type:"profile-chart-show",sender:this})}destroy(){a(this.handler)&&(a(this.insertionsHandler)&&(this.insertionsHandler(),delete this.insertionsHandler),this.handler.destroy(),delete this.handler,(!a(this.markers)||this.markers.length<2)&&this.map.scene.removeTerrainProfile(this))}remove(){Re(this.map).dispatchEvent({type:"profile-chart-hide",sender:this}),this.destroy();let e=L(this.map);a(this.dataSource)&&e.dataSources.remove(this.dataSource),delete this.dataSource,delete this.markers,delete this.totalLength,delete this.info}}let gr=x.lngLatToCartesian,Oe=ge.createElement,vr=0;class wr extends ee{constructor(e){super(),this.terrainProfile=void 0,this.chartId="liglobe-profile-chart"+vr++;let t=this,i=Oe("div",{container:e,id:this.id,style:"display:none",disablecontextmenu:!0,className:"liglobe-profile"}),s=Oe("div",{className:"liglobe-profile-drag",container:i});Oe("span",{className:"minSmall user-select",container:s,style:"position: absolute; right: 30px; line-height: 25px; font-size: 30px; cursor: pointer;",click:function(){let o=document.getElementById("maxLarge");o?(o.style.display="",i.style.display="none"):(Oe("span",{className:"maxLarge user-select",container:e,style:"position: absolute; left: 150px; bottom: 20px; padding: 3px 8px; color: #000; font-size: 14px; cursor: pointer; background: #ccc; border-radius: 5px;",innerText:"最大化",id:"maxLarge",click:function(){this.style.display="none",i.style.display="";var l=new Event("resize");window.dispatchEvent(l)}}),i.style.display="none")},innerText:"-",title:"最小化"}),Oe("div",{className:"liglobe-profile-close user-select",click:function(){t.hideChart()},innerText:"x",title:"关闭",disablecontextmenu:!0,container:s}),Oe("div",{className:"liglobe-profile-chart",disablecontextmenu:!0,id:this.chartId,container:i}),this.elementDom=i;let r=!1;s.onmousedown=function(o){let l=o.clientX-i.offsetLeft,c=o.clientY-i.offsetTop;r=!0,i.style.cursor="move";let h=function(u){if(r==!1)return;let f=u.clientX-l,m=u.clientY-c;i.style.left=f+"px",i.style.top=m+"px"};window.addEventListener("mousemove",h),s.onmouseup=function(){r=!1,i.style.cursor="default",window.removeEventListener("mousemove",h)}}}hideChart(){this.terrainProfile=void 0,this.elementDom.style.display="none"}showChart(e){if(!a(e)||!(e instanceof Wt))return;let t=e.info;if(!a(t)||!a(t.detail)||(this.elementDom.style.display="",this.terrainProfile===e))return;this.terrainProfile=e,a(this.chart)||(this.chart=echarts.init(Xe(this.chartId)),window.addEventListener("resize",()=>{this.chart&&this.chart.resize()})),this.chart.resize();let i=t.detail,s=t.xData,r=t.yData,o=[],l=[];for(let u=0;u<s.length;u++){o.push([s[u],r[u]]);let f=gr(L(e.map),i[u].lng,i[u].lat,i[u].height);l.push(f)}let c=x.getDistance(l);c<e.totalLength&&(c=e.totalLength);var h={backgroundColor:"#fff",title:{left:"center",text:"地形剖面示意图"},graphic:[{type:"group",left:"center",bottom:5,children:[{type:"text",z:100,left:"center",top:"middle",style:{fill:"#333",text:["直线距离："+ue(e.totalLength)+"           地表距离："+ue(c)].join(`
`),font:"14px Microsoft YaHei"}}]}],tooltip:{trigger:"axis",formatter:function(u){let f=u[0].dataIndex,m=i[f],w="";return w+="经度: "+m.lng.toFixed(7)+"<br>",w+="纬度: "+m.lat.toFixed(7)+"<br>",w+="高程: "+m.height.toFixed(2),w}},toolbox:{show:!0,feature:{dataZoom:{yAxisIndex:"none"},restore:{},saveAsImage:{}}},xAxis:{type:"value",name:"长度（米）"},yAxis:{type:"value",name:"高程（米）"},series:[{name:"高程",type:"line",smooth:!0,symbol:"none",itemStyle:{color:"rgb(255, 70, 131)"},areaStyle:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:"rgb(255, 158, 68)"},{offset:1,color:"rgb(255, 70, 131)"}])},data:o}]};this.chart.clear(),this.chart.dispatchAction({type:"restore"}),this.chart.setOption(h)}}let Yi=!1;function yr(n,e,t){return ds.generateArc({positions:n,height:t,granularity:e})}function Cr(n,e){let t=p(e,1),i=1e-4;return n<1e3?i=1e-6:n<1e5?i=1e-5:(i=1e-4,t=1),{level:t,granularity:i}}function Zi(n,e,t){if(e.markers.length-e.currentIndex<2)return;let i=e.markers[e.currentIndex++],s=e.markers[e.currentIndex],r=[];function o(u,f){let m=e.ellipsoid.cartesianToCartographic(u);return a(f)&&(m.height=f),m}let l=o(i),c=o(s),h=yr([i,s],e.granularity,[l.height,c.height]);for(let u=0;u<h.length;u+=3){let f=d.unpack(h,u);e.xData.push(d.distance(i,f)+e.currentLength),r.push(o(f,0))}r.push(o(s,0)),e.currentLength+=x.getDistance([i,s]),e.xData.push(e.currentLength),ki(n.terrainProvider,e.level,r).then(function(u){for(let f=0;f<u.length;f++){let m=u[f];e.detail.push({lng:T.toDegrees(m.longitude),lat:T.toDegrees(m.latitude),height:m.height}),e.yData.push(m.height)}if(e.currentIndex<e.markers.length-1)Zi(n,e,t);else{let f={xData:e.xData,yData:e.yData,detail:e.detail},m=e.sender;m.info=f,t()}})}class Ji extends ee{constructor(e,t){super(),M(e),this.map=e,this.addEventListener("start_inserting_terrainProfile",()=>{e.dispatchEvent({type:"cancel_insertions"})}),e.scene.addEventListener("terrainProfile_removed",s=>{s.terrainProfile.remove()}),a(window.echarts)||co(R()+"/Assets/lib/echarts/echarts.min.js"),Yi||xt(R()+"/Assets/css/terrainprofile.css",function(){Yi=!0});let i=new wr(L(this.map,!0).container);this.addEventListener("profile-chart-show",s=>{i.showChart(s.sender)}),this.addEventListener("profile-chart-hide",()=>{i.hideChart()})}start(){this.dispatchEvent({type:"start_inserting_terrainProfile"});let e=new Wt(this.map);return this.map.scene.addTerrainProfile(e),e}calculate(e,t){if(!a(e)||e.markers.length<2)return;let i=e.totalLength,s=Gs(this.map),r=L(this.map),o=e.markers,l=Cr(i,e.level);Zi(r,{ellipsoid:s,markers:o,sender:e,currentIndex:0,currentLength:0,level:l.level,granularity:l.granularity,xData:[],yData:[],detail:[]},t)}}function Re(n,e){M(n);let t=n.toolManager.terrainProfileTool;return a(t)&&t instanceof Ji||(t=new Ji(n,e),n.toolManager.terrainProfileTool=t),t}function Vt(n){var e='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">',t=e+n;return"data:image/svg+xml;base64,"+window.btoa(t)}function _r(n="#FF3D00",e=32,t=32){let i=`<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${e}" height="${t}">
  <path d="M512 85.333333c-164.949333 0-298.666667 133.738667-298.666667 298.666667 0 164.949333 298.666667 554.666667 
  298.666667 554.666667s298.666667-389.717333 298.666667-554.666667c0-164.928-133.717333-298.666667-298.666667-298.666667z 
  m0 448a149.333333 149.333333 0 1 1 0-298.666666 149.333333 149.333333 0 0 1 0 298.666666z" fill="${n}"></path></svg>`;return Vt(i)}function $e(n,e){var t;return typeof n=="string"&&(t=S.fromCssColorString(n)),t instanceof S&&a(e)&&(t=t.withAlpha(e)),t}function br(n){let e;return n instanceof ne&&(e=n),n instanceof Array&&(n[1]<-85&&(n[1]=-85),n[3]>85&&(n[3]=85),e=ne.fromDegrees(...n)),e}function Sr(n){var e=document.createElement("canvas");return e.width=n.width,e.height=n.height,e.getContext("2d").drawImage(n,0,0),e}function Tr(n,e,t,i=.6){let s=document.createElement("canvas");s.width=t,s.height=t;let r=s.getContext("2d");return new Resource.fetchImage(n).then(l=>{try{r.drawImage(l,0,0,l.width*i,l.height*i)}catch(c){console.log(c)}return r.fillStyle=_Color.WHITE.toCssColorString(),r.font="bold 12px Microsoft YaHei",r.textAlign="center",r.textBaseline="middle",r.fillText(e,t/3-55,t/3-58),s})}let Y={exportSvgImg:Vt,marker:_r,getColor:$e,getRectangle:br,convertImageToCanvas:Sr,combineIconAndLabel:Tr},Ut=0;class He{constructor(e,t){this.option=p(t,{}),this._markers=0,Ut++,this.map=e;let i=L(this.map);this._tempPoint=null,this._markerPoints=[];let s=this;this.measureHandler=new ae(de(this.map)),de(this.map).setAttribute("style","cursor: crosshair"),ri(this.map).cursor="crosshair",this.pointsCollection=new B("point data "+Ut),this.otherCollection=new B("other data "+Ut),i.dataSources.add(this.pointsCollection),i.dataSources.add(this.otherCollection),this.insertionsHandler=this.map.addEventListener("cancel_insertions",function(){s.destroy()})}get markers(){return this._markers}remove(){a(this.measureHandler)&&this.destroy();let e=L(this.map);a(this.pointsCollection)&&e.dataSources.remove(this.pointsCollection),delete this.pointsCollection,a(this.otherCollection)&&e.dataSources.remove(this.otherCollection),delete this.otherCollection,delete this._markerPoints,delete this._tempPoint}destroy(){a(this.measureHandler)&&(a(this.insertionsHandler)&&(this.insertionsHandler(),delete this.insertionsHandler),this.measureHandler.destroy(),delete this.measureHandler,de(this.map).setAttribute("style","cursor: auto"),ri(this.map).cursor=null,this._internalDestroy&&this._internalDestroy())}_addPointToPointEntities(e,t,i={}){let s=p(i.pointColor,"yellow"),r=p(i.max,1e6),o=i.pointSize||8,l=new me({name:e,position:t,point:{color:Y.getColor(s),pixelSize:o,distanceDisplayCondition:new k(0,r),disableDepthTestDistance:200}});this.pointsCollection.entities.add(l)}_addLabelEntities(e,t,i={}){let s=p(i.maxDistance,5e5),r=new me({name:"label",position:t,billboard:{image:je(e,i),horizontalOrigin:Qe.CENTER,verticalOrigin:tt.BOTTOM,pixelOffset:new E(0,-10),disableDepthTestDistance:Number.POSITIVE_INFINITY,distanceDisplayCondition:new k(0,s)}});return this.otherCollection.entities.add(r)}_removeOtherCollectionEntity(e){Pt(this.otherCollection,e)}_pointsCollectionEntity(e){Pt(this.pointsCollection,e)}_getOtherCollectionEntity(e){let t=this.otherCollection.entities.values;for(let i=0;i<t.length;i++){let s=t[i];if(s.name==e)return s}}pickPosition(e){return x.pickPosition(ce(this.map),e)}}let Gt=x.getAngle;class Lr extends He{constructor(e,t){super(e,t);let i=p(this.option.lineWidth,2),s=p(this.option.lineColor,"red"),r=p(this.option.lineColorTemp,s),o=p(this.option.maxDistance,1e7),l={pointSize:p(this.option.pointSize,8),pointColor:p(this.option.pointColor,"yellow"),max:o},c=p(this.option.labelOpt,{}),h=this;this.measureHandler.setInputAction(function(u){if(h.markers<2)return;let f=h.pickPosition(u.endPosition);a(f)&&(h._tempPoint=f)},F.MOUSE_MOVE),this.measureHandler.setInputAction(function(u){let f=h.pickPosition(u.position);if(a(f)){if(f.equals(h._markerPoints[h._markerPoints.length-1])){h.destroy(),alert("选择点无效，请重新选择");return}if(h._addPointToPointEntities("point"+ ++h._markers,f,l),h._markerPoints.push(f),h._tempPoint=null,h.markers==2){let m=Y.getColor(r);h.otherCollection.entities.add({name:"temp polyline",polyline:{positions:new W(function(){return h._getTempShape()},!1),material:new U({color:m}),width:i,distanceDisplayCondition:new k(0,o)}}),h.otherCollection.entities.add({name:"polyline",polyline:{positions:new W(function(){return h._getPointsForShape()},!1),material:Y.getColor(s),width:i,distanceDisplayCondition:new k(0,o)}})}else if(h.markers>2){let m=Fe(Gt(h._markerPoints,1)),w=Fe(Gt(h._markerPoints,2)),y=Fe(Gt(h._markerPoints,3)),v=h.option.textInfo||"";h._addLabelEntities(v+m,h._markerPoints[0],c),h._addLabelEntities(v+w,h._markerPoints[1],c),h._addLabelEntities(v+y,h._markerPoints[2],c),h.destroy()}}},F.LEFT_CLICK),this.measureHandler.setInputAction(function(){a(e.isTooling)&&(e.isTooling=!1),h.destroy()},F.RIGHT_CLICK)}get type(){return"angle_measure"}_internalDestroy(){if(a(this._tempPoint)&&delete this._tempPoint,this.markers!=3)this.map.scene.removeMeasurement(this);else{this._removeOtherCollectionEntity("temp polyline");const e=this._getOtherCollectionEntity("polyline");a(e)&&(e.polyline.positions=this._getPointsForShape())}}_getPointsForShape(){let e=[];for(let t=0;t<this._markerPoints.length;t++)e.push(N(this._markerPoints[t]));return e.length>2&&e.push(e[0]),e}_getTempShape(){let e=[];return!a(this._tempPoint)||this.markers!=2||(e.push(N(this._markerPoints[0])),e.push(N(this._tempPoint)),e.push(N(this._markerPoints[1]))),e}}let jt=Y.getColor;class Er extends He{constructor(e,t){super(e,t);let i=p(this.option.lineWidth,2),s=p(this.option.lineColor,"red"),r=p(this.option.lineColorTemp,s),o=p(this.option.maxDistance,1e7),l={pointSize:p(this.option.pointSize,8),pointColor:p(this.option.pointColor,"yellow"),max:o},c=this;this.measureHandler.setInputAction(function(h){if(c.markers<2)return;let u=c.pickPosition(h.endPosition);a(u)&&(c._tempPoint=u)},F.MOUSE_MOVE),this.measureHandler.setInputAction(function(h){let u=c.pickPosition(h.position);if(a(u)){if(u.equals(c._markerPoints[c._markerPoints.length-1])){c.destroy(),alert("选择点无效，请重新选择");return}if(c._addPointToPointEntities("point"+ ++c._markers,u,l),c._markerPoints.push(u),c._tempPoint=null,c.markers==2){let f=jt(r);c.otherCollection.entities.add({name:"temp polyline",polyline:{positions:new W(function(){return c._getTempShape()},!1),material:new U({color:f}),width:i,distanceDisplayCondition:new k(0,o)}}),c.otherCollection.entities.add({name:"polyline and polygon",polyline:{positions:new W(function(){return c._getPointsForShape(!0)},!1),material:jt(s),width:i,distanceDisplayCondition:new k(0,o)}})}}},F.LEFT_CLICK),this.measureHandler.setInputAction(function(){a(e.isTooling)&&(e.isTooling=!1),c.destroy()},F.RIGHT_CLICK)}get type(){return"area_measure"}_internalDestroy(){if(a(this._tempPoint)&&delete this._tempPoint,this.markers<3)this.map.scene.removeMeasurement(this);else{this._removeOtherCollectionEntity("temp polyline");const e=this._getOtherCollectionEntity("polyline and polygon");if(a(e)){let t=this._getPointsForShape(),i=new et(t);if(this.option.callback){let o=[];t.forEach(l=>{let c=x.cartesianToLngLat(this.map._viewer,l);o.push(parseFloat(c.x.toFixed(7)),parseFloat(c.y.toFixed(7)),parseFloat(c.z.toFixed(3)))}),this.option.callback(o)}let s=p(this.option.polygonColor,"rgba(61, 128, 178, 0.5)"),r=p(this.option.maxDistance,1e7);if(e.polygon=new is({hierarchy:i,perPositionHeight:!0,material:jt(s),distanceDisplayCondition:new k(0,r),classificationType:yi.BOTH}),e.polyline.positions=this._getPointsForShape(!0),a(this.option.calculateArea)||(this.option.calculateArea=!0),this.option.calculateArea){let o=x.getCentroid(this._markerPoints),l=x.getArea(i),c=ue(l,!0),h=p(this.option.labelOpt,{}),u=this.option.textInfo||"面积：";this._addLabelEntities(`${u}${c}`,o,h)}}}}_getPointsForShape(e){let t=[];for(let i=0;i<this._markerPoints.length;i++)t.push(N(this._markerPoints[i]));return t.push(N(this._markerPoints[0])),e&&!a(this._tempPoint)&&t.push(t[0]),t}_getTempShape(){let e=[];return!a(this._tempPoint)||this.markers<2||(e.push(N(this._markerPoints[0])),e.push(N(this._tempPoint)),e.push(N(this._markerPoints[this._markerPoints.length-1]))),e}}class Ki extends He{constructor(e,t){super(e,t);let i=p(this.option.lineWidth,2),s=p(this.option.lineColor,"red"),r=p(this.option.lineColorTemp,s),o=p(this.option.maxDistance,1e7),l={pointSize:p(this.option.pointSize,8),pointColor:p(this.option.pointColor,"yellow"),max:o},c=p(this.option.labelOpt,{}),h=this;this.measureHandler.setInputAction(function(u){if(h.markers<1)return;let f=h.pickPosition(u.endPosition);a(f)&&(h._tempPoint=f)},F.MOUSE_MOVE),this.measureHandler.setInputAction(function(u){let f=h.pickPosition(u.position);if(a(f)){if(h._addPointToPointEntities("point"+ ++h._markers,f,l),h._markerPoints.push(f),h._tempPoint=null,h.markers==1){let m=Y.getColor(r);h.otherCollection.entities.add({name:"temp polyline",polyline:{positions:new W(function(){return h._getTempShape()},!1),material:new U({color:m}),width:i,distanceDisplayCondition:new k(0,o)}})}else h.markers==2&&h.otherCollection.entities.add({name:"polyline",polyline:{positions:new W(function(){return h._getPointsForShape()},!1),material:Y.getColor(s),width:i,distanceDisplayCondition:new k(0,o)}});if(h.markers>1){let m=h._markerPoints[h._markerPoints.length-2],w=x.getDistance([m,f]),y=ue(w),v=x.getCenter(m,f);h._addLabelEntities(y,v,c)}}},F.LEFT_CLICK),this.measureHandler.setInputAction(function(){a(e.isTooling)&&(e.isTooling=!1),h.destroy()},F.RIGHT_CLICK)}_internalDestroy(){if(a(this._tempPoint)&&delete this._tempPoint,this.markers<2)this.map.scene.removeMeasurement(this);else{this._removeOtherCollectionEntity("temp polyline");const e=this._getOtherCollectionEntity("polyline");a(e)&&(e.polyline.positions=this._getPointsForShape());let t=this._markerPoints[this._markerPoints.length-1],i=x.getDistance(this._markerPoints),r=(this.option.textInfo||"总距离：")+ue(i),o=p(this.option.labelOpt,{});this._addLabelEntities(r,t,o)}}get type(){return"distance_measure"}_getPointsForShape(){let e=[];for(let t=0;t<this._markerPoints.length;t++)e.push(N(this._markerPoints[t]));return e}_getTempShape(){let e=[];return a(this._tempPoint)&&(e.push(N(this._markerPoints[this._markerPoints.length-1])),e.push(N(this._tempPoint))),e}}function $t(n,e,t,i="",s={},r=[0,0],o){let l=t[0],c=t[1];r=p(r,[0,0]);let h=p(s.maxDistance,1e5),u=x.getCenter(l,c),f=x.getDistance([l,c]),m=ue(f);if(o!=null&&(m=o),e+=m,a(n)){let w=new me({name:i,position:u,billboard:{image:je(e,s),pixelOffset:new E(...r),disableDepthTestDistance:Number.POSITIVE_INFINITY,distanceDisplayCondition:new k(0,h),pixelOffsetScaleByDistance:new Ss(1e5,3,1e5,0)}});n.entities.add(w)}return{position:u,distance:f}}function Ye(n,e,t,i={}){if(a(n)){let s=p(i.maxDistance,1e5),r=new me({position:t,billboard:{image:je(e,i),disableDepthTestDistance:Number.POSITIVE_INFINITY,distanceDisplayCondition:new k(0,s)}});n.entities.add(r)}}function qi(n,e,t,i,s={}){let r=p(s.textInfo,{}),o=p(s.labelOpt,{}),l=$t(n,r.v||"垂直距离：",[e,i],"vertical distance label",o,[0,0],r.vd),c=$t(n,r.h||"水平距离：",[t,i],"horizontal distance label",o,[0,-15],r.hd),h=$t(n,r.s||"空间距离：",[e,t],"spatial distance label",o,[0,15],r.sd);return{verticalDistance:l.distance,horizontalDistance:c.distance,spatialDistance:h.distance}}class Dr extends He{constructor(e,t){super(e,t);let i=p(this.option.lineWidth,2),s=p(this.option.lineColor,"red"),r=p(this.option.lineColorTemp,s),o=p(this.option.maxDistance,1e7),l={pointSize:p(this.option.pointSize,8),pointColor:p(this.option.pointColor,"yellow"),max:o},c=this,h=L(e);this.measureHandler.setInputAction(function(u){if(c.markers<1)return;let f=c.pickPosition(u.endPosition);a(f)&&(c._tempPoint=f)},F.MOUSE_MOVE),this.measureHandler.setInputAction(function(u){let f=c.pickPosition(u.position);if(a(f))if(c._addPointToPointEntities("point"+ ++c._markers,f,l),c._markerPoints.push(f),c._tempPoint=null,c.markers==1){c._lnglat1=x.cartesianToLngLat(h,f);let m=Y.getColor(r);c.otherCollection.entities.add({name:"temp polyline",polyline:{positions:new W(function(){return c._getTempShape()},!1),material:new U({color:m}),width:i,distanceDisplayCondition:new k(0,o)}}),c.otherCollection.entities.add({name:"polyline",polyline:{positions:new W(function(){return c._getPointsForShape()},!1),material:Y.getColor(s),width:i,distanceDisplayCondition:new k(0,o)}})}else c.markers>1&&c.destroy()},F.LEFT_CLICK),this.measureHandler.setInputAction(function(){a(e.isTooling)&&(e.isTooling=!1),c.destroy()},F.RIGHT_CLICK)}_internalDestroy(){if(a(this._tempPoint)&&delete this._tempPoint,this.markers!=2)this.map.scene.removeMeasurement(this);else{let e=this._getTempShape();const t=this._getOtherCollectionEntity("temp polyline");a(t)&&(t.polyline.positions=e);const i=this._getOtherCollectionEntity("polyline");a(i)&&(i.polyline.positions=this._getPointsForShape());let s=e[0],r=e[2],o=e[1],l=p(this.option.labelOpt,{});qi(this.otherCollection,s,r,o,{textInfo:p(this.option.textInfo,{}),labelOpt:l})}}get type(){return"height_measure"}_getPointsForShape(){let e=[];if(this.markers==1)a(this._tempPoint)&&(e.push(N(this._markerPoints[0])),e.push(N(this._tempPoint)));else if(this.markers==2)for(let t=0;t<this._markerPoints.length;t++)e.push(N(this._markerPoints[t]));return e}_getTempShape(){let e=[],t=N(this._markerPoints[0]),i=this._tempPoint||this._markerPoints[1];if(!i)return e;i=N(i);let s=L(this.map);return x.getRightTriangle(s,t,i,this._lnglat1,x.cartesianToLngLat(s,i))}}let Yt=ge.createElement,Xi=!1;function Pr(n){Xi||xt(R()+"/Assets/css/measure.css",function(){Xi=!0});let e=Yt("div",{className:"liglobe-measure user-select"}),t=Yt("div");const i=function(s,r,o){let l=nt(r),c="liglobe-measure-item liglobe-measure-"+r;Yt("img",{src:l,title:s,className:c,click:o,container:t})};i("测量角度","angle",function(){n.startInsertion("angle")}),i("测量长度","distance",function(){n.startInsertion("distance")}),i("测量高度","height",function(){n.startInsertion("height")}),i("测量面积","area",function(){n.startInsertion("area")}),i("清除","remove",function(){n.map.scene.removeAllMeasurements()}),e.appendChild(t),L(n.map,!0).container.appendChild(e)}class ot{constructor(e){this.map=e}}let Qi=Y.getColor;class xr extends ot{constructor(e,t){super(e);let i=L(this.map);this.start=x.formatLngLatAlt(t.start,!0),this.end=x.formatLngLatAlt(t.end,!0);let s=x.lngLatToCartesian(i,...this.start),r=x.lngLatToCartesian(i,...this.end),o=x.getRightTriangle(i,s,r,x.formatLngLatAlt(this.start),x.formatLngLatAlt(this.end)),l=o[0],c=o[2],h=o[1],u=p(t.visible,!0),f={};if(u){this.collection=new B;let m=p(t.lineWidth,2),w=p(t.lineColor,"red"),y=p(t.lineColorTemp,w),v=p(t.maxDistance,1e6);f.labelOpt=p(t.labelOpt,{}),i.dataSources.add(this.collection),this.collection.entities.add({polyline:{positions:o,material:new U({color:Qi(y)}),width:m,distanceDisplayCondition:new k(0,v)}}),this.collection.entities.add({polyline:{positions:[l,c],material:Qi(w),width:m,distanceDisplayCondition:new k(0,v)}})}f.textInfo=p(t.textInfo,{}),this.info=qi(this.collection,l,c,h,f)}set show(e){a(this.collection)&&(this.collection.show=e)}get type(){return"height_measure_ex"}remove(){let e=L(this.map);a(this.collection)&&(e.dataSources.remove(this.collection),delete this.collection)}}let Zt=x.getAngle,Jt=x.lngLatToCartesian,Kt=x.formatLngLatAlt;class kr extends ot{constructor(e,t){super(e),this.p1=Kt(t.p1,!0),this.p2=Kt(t.p2,!0),this.p3=Kt(t.p3,!0);let i=L(this.map),s=Jt(i,...this.p1),r=Jt(i,...this.p2),o=Jt(i,...this.p3),l=[s,r,o],c=Zt(l,1),h=Zt(l,2),u=Zt(l,3);if(p(t.visible,!0)){this.collection=new B,L(this.map).dataSources.add(this.collection);let w=p(t.lineWidth,2),y=p(t.lineColor,"red"),v=p(t.labelOpt,{}),C=p(t.maxDistance,1e6);this.collection.entities.add({polyline:{positions:[s,r,o,s],material:Y.getColor(y),width:w,distanceDisplayCondition:new k(0,C)}});let _=t.textInfo||"";Ye(this.collection,_+Fe(c),l[0],v),Ye(this.collection,_+Fe(h),l[1],v),Ye(this.collection,_+Fe(u),l[2],v)}this.info={angle1:c,angle2:h,angle3:u}}set show(e){a(this.collection)&&(this.collection.show=e)}get type(){return"angle_measure_ex"}remove(){let e=L(this.map);a(this.collection)&&(e.dataSources.remove(this.collection),delete this.collection)}}let en=x.getDistance;class Ir extends ot{constructor(e,t){super(e);let i=[],s=[],r=[];this.positions=[];for(let l=0;l<t.positions.length;l++){let c=t.positions[l],h=x.formatLngLatAlt(c,!0),u=x.lngLatToCartesian(L(this.map),...h);i.push(u),this.positions.push(h),l>0&&s.push(en([i[l-1],u]))}if(r=en(i),p(t.visible,!0)){this.collection=new B;let l=p(t.lineWidth,2),c=p(t.lineColor,"red"),h=p(t.textInfo,"总距离："),u=p(t.showSegmentLength,!0),f=p(t.labelOpt,{}),m=p(t.maxDistance,1e6);if(L(this.map).dataSources.add(this.collection),this.collection.entities.add({polyline:{positions:i,material:Y.getColor(c),width:l,distanceDisplayCondition:new k(0,m)}}),Ye(this.collection,h+ue(r),i[i.length-1],f),u&&i.length>2)for(let y=1;y<i.length;y++)Ye(this.collection,ue(s[y-1]),x.getCenter(i[y-1],i[y]),f)}this.info={distances:s,totalDistance:r}}set show(e){a(this.collection)&&(this.collection.show=e)}get type(){return"distance_measure_ex"}remove(){let e=L(this.map);a(this.collection)&&(e.dataSources.remove(this.collection),delete this.collection)}}class qt extends He{constructor(e,t){super(e,t);let i=p(this.option.labelOpt,{}),s=this;this.measureHandler.setInputAction(function(r){let o=s.map.pickPosition(r.position);if(!a(o))return;let l=`经度: ${Math.round(o.x*1e7)/1e7}
纬度：${Math.round(o.y*1e7)/1e7}
高度：${ue(o.z)}`;t.callback&&t.callback([Math.round(o.x*1e7)/1e7,Math.round(o.y*1e7)/1e7,o.z]),s._removeOtherCollectionEntity("label"),s._pointsCollectionEntity("pickUpPoint"),s._addLabelEntities(l,x.lngLatToCartesian(L(s.map),o.x,o.y,o.z),i),s._addPointToPointEntities("pickUpPoint",x.lngLatToCartesian(L(s.map),o.x,o.y,o.z))},F.LEFT_CLICK),this.measureHandler.setInputAction(function(){s.destroy()},F.RIGHT_CLICK)}_internalDestroy(){a(this._tempPoint)&&delete this._tempPoint}}class tn extends ee{constructor(e,t){super(),M(e),this.map=e,this.addEventListener("start_inserting_measurement",()=>{e.dispatchEvent({type:"cancel_insertions"})}),e.scene.addEventListener("measurement_removed",i=>{i.measurement.remove()}),!(t===!0||re(t)&&t.custom==!0)&&Pr(this)}startInsertion(e,t={}){this.dispatchEvent({type:"start_inserting_measurement"}),this.map.isTooling=!0;let i;switch(e){case"angle":i=new Lr(this.map,t);break;case"distance":i=new Ki(this.map,t);break;case"area":i=new Er(this.map,t);break;case"height":i=new Dr(this.map,t);break;case"pickup":i=new qt(this.map,t);break;default:i=new Ki(this.map,t);break}return this.map.scene.addMeasurement(i),i}triangulation(e){if(!a(e)||!a(e.start)||!a(e.end))return null;let t=new xr(this.map,e);return e.visible!=!1&&this.map.scene.addMeasurement(t),t}angle(e){if(!a(e)||!a(e.p1)||!a(e.p2)||!a(e.p3))return null;let t=new kr(this.map,e);return e.visible!=!1&&this.map.scene.addMeasurement(t),t}distance(e){if(!a(e)||!G(e.positions)||e.positions.length<2)return null;let t=new Ir(this.map,e);return e.visible!=!1&&this.map.scene.addMeasurement(t),t}getPositionMeasure(){let e=new qt(this.map);return this.map.scene.addMeasurement(e),e}}function Xt(n,e){M(n);let t=n.toolManager.measuringTool;return a(t)&&t instanceof tn||(t=new tn(n,e),n.toolManager.measuringTool=t),t}class nn{constructor(e){M(e),this.map=e}set strength(e){ce(this.map)._terrainExaggeration=e}get strength(){return ce(this.map)._terrainExaggeration}get enableDepth(){return ce(this.map).globe.depthTestAgainstTerrain}set enableDepth(e){ce(this.map).globe.depthTestAgainstTerrain=e}}function sn(n){M(n);let e=n.toolManager.terrainUtil;return a(e)&&e instanceof nn||(e=new nn(n),n.toolManager.terrainUtil=e),e}function rn(n){M(n);let e=n.toolManager.autoRotate;return a(e)&&e instanceof Ii||(e=new Ii(L(n)),n.toolManager.autoRotate=e),e}class Ar{constructor(e,t){this.powerLine=e,this.ttId=t.ttId,this.position=d.fromDegrees(...t.position),this.ttName=t.ttName,this._cx=void 0,this._cy=void 0,this._active=!0,this._offset=[0,0],this.showBubble=!1,Ti.track(this,["_cx","_cy","showBubble"])}get active(){return this._active}set active(e){this._active!=e&&(this._active=e,this.update(),this._active||(this.showBubble=!1))}get offset(){return this._offset}set offset(e){G(e)&&e.length>1&&De(e[0])&&De(e[1])&&(this._offset=e.splice(0,2),this.update())}update(){if(!this._active)return;let e=this.powerLine.map,t=e.canvasPos(this.position);if(!a(t)){this.showBubble=!1;return}const i=it(e);let s=x.getDistance([this.position,i.position]);if(this.showBubble=s<this.powerLine.dynamicDistance,!this.showBubble)return;let r=Math.round(t.x)+this.offset[0],o=Math.round(t.y)+this.offset[1];if(r<0||o<0){this.showBubble=!1;return}this._cx=r+"px",this._cy=o+"px"}show(){let e=`<div class="bubble user-select" data-bind="visible:showBubble,style:{left: _cx,top: _cy}">
        <span class="bubble-item bubble-item-annotation">${this.ttName}</span>
        <img data-bind="click:a"  title="精细化" class="bubble-item bubble-item-detail" src="${nt("ttdetail")}">
        <img data-bind="click:b" title="全景展示" class="bubble-item bubble-item-panorama" src="${nt("ttpanorama")}">
        <img data-bind="click:c" title="红外图片" class="bubble-item bubble-item-red" src="${nt("ttred")}"></div>`;this.domElemnt=ge.loadView(e,this.powerLine.container,this)[0]}fireEvent(e){this.powerLine.map.dispatchEvent({type:"bubble_click",ttId:this.ttId,name:e})}a(){this.fireEvent("detail")}b(){this.fireEvent("panorama")}c(){this.fireEvent("red")}}class Mr{constructor(e,t){this.powerLine=e,this.ttId=t.ttId,this.position=d.fromDegrees(...t.position),this.htmlTemplate=p(t.htmlTemplate,""),this.ttName=t.ttName,this._cx=void 0,this._cy=void 0,this._active=!0,this._offset=[0,0],this.showBubble=!1,Ti.track(this,["_cx","_cy","showBubble"])}get active(){return this._active}set active(e){this._active!=e&&(this._active=e,this.update(),this._active||(this.showBubble=!1))}get offset(){return this._offset}set offset(e){G(e)&&e.length>1&&De(e[0])&&De(e[1])&&(this._offset=e.splice(0,2),this.update())}update(){if(!this._active)return;let e=this.powerLine.map,t=e.canvasPos(this.position);if(!a(t)){this.showBubble=!1;return}const i=it(e);let s=x.getDistance([this.position,i.positionWC]);if(this.showBubble=s<this.powerLine.dynamicDistance,!this.showBubble)return;let r=Math.round(t.x)+this.offset[0],o=Math.round(t.y)+this.offset[1];if(r<0||o<0){this.showBubble=!1;return}this._cx=r+"px",this._cy=o+"px"}show(){let e=`<div class="bufferPosition"  data-bind="visible:showBubble,style:{left: _cx,top: _cy}">${this.htmlTemplate}</div>`;this.domElement=ge.loadView(e,this.powerLine.container,this)[0]}}function Fr(n,e){if(re(e))return ai(e.htmlTemplate)?new Mr(n,e):new Ar(n,e)}class ze{constructor(e,t){M(e),this.map=e,this.pd=30,this.distance=2e4,this.id=t.id,this.name=t.name,this.bubbles=[],this.tilesets=[],this._active=!1,this.container=ge.createElement("div",{className:"bubble-collection",style:"display:none",disablecontextmenu:!0});let i=t.bubbles;G(i)&&i.forEach(s=>{let r=s.position||[s.x,s.y,s.z];s.position=r;const o=Fr(this,s);o.show(),this.bubbles.push(o)}),this.timeout=null}set active(e){if(!a(this.container)){console.warn("the powerLine doesn't exist");return}if(this._active!=e){this._active=e,this.container.style.display=e?"":"none";let t=L(this.map).cesiumWidget.options.pixelDistance;this.update(this,{pd:t})}}get active(){return this._active}static create(e,t){return new ze(e,t)}get dynamicDistance(){return this._dynamicDistance||this.distance||200}update(e,t){let i=p(this.pd,e.pd),s=this.active&&a(t.pd)&&t.pd<i;if(this.container.style.display=s?"":"none",s){let r=it(this.map).pitch,o=.15;if(r<0&&(o=Math.round(Math.abs(r)*1e3)/1e3),o<.5){o<.15&&(o=.15);let l=o*o*this.distance;l<100&&(l=100),this._dynamicDistance=l}else this._dynamicDistance=this.distance;this.bubbles.forEach(l=>{l.update()})}}destroy(){if(this.active=!1,a(this.bubbles)&&this.bubbles.length>0&&this.bubbles.splice(0,this.bubbles.length),a(this.tilesets))for(;this.tilesets.length>0;){let e=this.tilesets.splice(0,1)[0];e&&e.destroy()}a(this.container)&&this.container.parentNode.removeChild(this.container),delete this.container}}class Qt{constructor(e){this.map=e;let t=L(this.map);this._showDraw=!0,this._showBuffer=!0,this.bufferHandler=new ae(de(this.map)),this.dataCollection=new B,t.dataSources.add(this.dataCollection);let i=this;this.insertionsHandler=this.map.addEventListener("cancel_insertions",function(){i.destroy()})}remove(){a(this.bufferHandler)&&this.destroy();let e=L(this.map);a(this.dataCollection)&&(e.dataSources.remove(this.dataCollection),delete this.dataCollection)}get showBuffer(){return this._showBuffer}get showDraw(){return this._showDraw}set showDraw(e){}set showBuffer(e){this._showEntity(this.type,2,e)}_showEntity(e,t,i){if((t==1?this._showDraw:this._showBuffer)!==i&&a(this.dataCollection)&&a(this.dataCollection.entities)){const r=Se(this.dataCollection,e);a(r)&&(t==1?this._showDraw=i:this._showBuffer=i,r.show=i)}}update(){this._update&&this._update()}destroy(){a(this.bufferHandler)&&(a(this.insertionsHandler)&&(this.insertionsHandler(),delete this.insertionsHandler),this.bufferHandler.destroy(),delete this.bufferHandler,this._internalDestroy&&this._internalDestroy(),this.map.dispatchEvent({type:"bufferAnalysis",sender:this,object:Se(this.dataCollection,this.type)}))}get type(){throw new Error("")}}class on extends Qt{constructor(e){super(e);let t=2,i=this;this._tempPoint=null,this.markers=[];let s=ce(this.map);this.bufferHandler.setInputAction(function(r){if(i.markers.length<1)return;let o=x.pickPosition(s,r.endPosition);a(o)&&(i._tempPoint=o)},F.MOUSE_MOVE),this.bufferHandler.setInputAction(function(r){let o=x.pickPosition(s,r.position);a(o)&&(i.markers.push(o),i._tempPoint=null,i.markers.length==1?i.dataCollection.entities.add({name:"temp polyline",polyline:{positions:new W(function(){return i._getTempShape()},!1),material:new U({color:A.RED}),width:t,distanceDisplayCondition:new k(0,1e6)}}):i.markers.length==2&&i.dataCollection.entities.add({name:"polyline",polyline:{positions:new W(function(){return i._getPointsForShape()},!1),material:A.RED,width:t,distanceDisplayCondition:new k(0,1e6)}}))},F.LEFT_CLICK),this.bufferHandler.setInputAction(function(){i.map.isTooling=!1,i.destroy()},F.RIGHT_CLICK)}set showDraw(e){this._showEntity("polyline",1,e)}_internalDestroy(){if(a(this._tempPoint)&&delete this._tempPoint,this.markers<2)this.map.scene.removeBufferAnalysis(this);else{Pt(this.dataCollection,"temp polyline");let e=Se(this.dataCollection,"polyline");a(e)?e.polyline.positions=this._getPointsForShape():e=this.dataCollection.entities.add({name:"polyline",polyline:{positions:this._getPointsForShape(),material:A.RED,width:2,distanceDisplayCondition:new k(0,1e6)}}),this._showDraw||(e.show=!1),this.drawPath&&this.drawPath()}}_getPointsForShape(){let e=[];for(let t=0;t<this.markers.length;t++)e.push(N(this.markers[t]));return e}_getTempShape(){let e=[];return a(this._tempPoint)&&(e.push(N(this.markers[this.markers.length-1])),e.push(N(this._tempPoint))),e}}function an(n){let e=[];for(let t=0;t<360;t+=10){let i=T.toRadians(t);e.push(new E(n*Math.cos(i),n*Math.sin(i)))}return e}function ln(n,e){let t=n,i=e;return[new E(-1*t,-1*i),new E(t,-1*i),new E(t,i),new E(-1*t,i)]}function at(n,e=0){let t=[];return n.forEach(i=>{let s=q.fromCartesian(i),r=s.height-e;t.push(d.fromRadiansArrayHeights([s.longitude,s.latitude,r])[0])}),t}let hn=Y.getColor,Or=x.formatLngLatAlt,Rr=x.lngLatToCartesian;class Hr extends on{constructor(e,t){super(e),t=p(t,{}),this.inputPosition=p(t.inputPosition,void 0),this.width=p(t.width,100),this.height=p(t.height,100),this.cornerType=p(t.cornerType,1),this.color=p(t.color,"yellow"),this.alpha=p(t.alpha,.5);let i=L(e);G(this.inputPosition)&&(this.inputPosition.forEach(s=>{let r=Rr(i,...Or(s,!0));this.markers.push(r)}),this.destroy())}drawPath(){this.dataCollection.entities.add({name:this.type,polylineVolume:{positions:at(this._getPointsForShape(),this.height),shape:ln(this.width,this.height),cornerType:this.cornerType,material:hn(this.color,this.alpha)}})}_update(){const e=Se(this.dataCollection,this.type);a(e)&&a(e.polylineVolume)&&(e.polylineVolume.positions=at(this._getPointsForShape(),this.height),e.polylineVolume.shape=ln(this.width,this.height),e.polylineVolume.material=hn(this.color,this.alpha))}get type(){return"box_buffer_analysis"}}let cn=Y.getColor,zr=x.pickPosition,Br=x.formatLngLatAlt,Nr=x.lngLatToCartesian;class Wr extends Qt{constructor(e,t){super(e);let i=ce(this.map);t=p(t,{}),this.inputPosition=p(t.inputPosition,void 0),this.radius=p(t.radius,100),this.color=p(t.color,"red"),this.alpha=p(t.alpha,.5),this.outline=p(t.outline,!1),this.outlineColor=p(t.outlineColor,"black"),this.markers=[];let s=this,r=function(c){s.dataCollection.entities.add({name:s.type,position:c,ellipsoid:{radii:new d(s.radius,s.radius,s.radius),material:cn(s.color,s.alpha),outline:s.outline,outlineColor:s.outlineColor}})},o=function(c){s.dataCollection.entities.add({name:"point",position:c,point:{color:A.YELLOW,pixelSize:8,distanceDisplayCondition:new k(0,1e6),disableDepthTestDistance:200}})},l=function(c){s.markers.push(c),o(c),r(c),s.destroy()};if(a(this.inputPosition)){let c=Nr(L(this.map),...Br(this.inputPosition,!0));l(c)}else this.bufferHandler.setInputAction(function(c){let h=zr(i,c.position);a(h)&&l(h)},F.LEFT_CLICK)}_internalDestroy(){if(this.markers<1)this.map.scene.removeBufferAnalysis(this);else{const e=Se(this.dataCollection,"point");a(e)&&(this._showDraw||(e.show=!1))}}_update(){const e=Se(this.dataCollection,this.type);a(e)&&a(e.ellipsoid)&&(e.ellipsoid.radii=new d(this.radius,this.radius,this.radius),e.ellipsoid.material=cn(this.color,this.alpha),e.ellipsoid.outline=this.outline,e.ellipsoid.outlineColor=this.outlineColor)}set showDraw(e){this._showEntity("point",1,e)}get type(){return"sphere_buffer_analysis"}}let dn=Y.getColor,Vr=x.formatLngLatAlt,Ur=x.lngLatToCartesian;class un extends on{constructor(e,t){super(e),t=p(t,{}),this.inputPosition=p(t.inputPosition,void 0),this.radius=p(t.radius,100),this.cornerType=p(t.cornerType,1),this.color=p(t.color,"yellow"),this.alpha=p(t.alpha,.5),G(this.inputPosition)&&(this.inputPosition.forEach(i=>{let s=Ur(L(e),...Vr(i,!0));this.markers.push(s)}),this.destroy())}drawPath(){this.dataCollection.entities.add({name:this.type,polylineVolume:{positions:at(this._getPointsForShape(),this.radius),shape:an(this.radius),cornerType:this.cornerType,material:dn(this.color,this.alpha)}})}_update(){const e=Se(this.dataCollection,this.type);a(e)&&a(e.polylineVolume)&&(e.polylineVolume.positions=at(this._getPointsForShape(),this.radius),e.polylineVolume.shape=an(this.radius),e.polylineVolume.material=dn(this.color,this.alpha))}get type(){return"tube_buffer_analysis"}}class fn extends ee{constructor(e,t){super(),M(e),this.map=e,this.addEventListener("start_inserting_bufferAnalysis",i=>{e.dispatchEvent({type:"cancel_insertions"})}),e.scene.addEventListener("bufferAnalysis_removed",i=>{i.bufferAnalysis.remove()})}start(e,t){this.dispatchEvent({type:"start_inserting_bufferAnalysis"});let i;switch(e){case"boxbuffer":i=new Hr(this.map,t);break;case"spherebuffer":i=new Wr(this.map,t);break;case"tubebuffer":i=new un(this.map,t);break;default:i=new un(this.map,t);break}return this.map.scene.addBufferAnalysis(i),i}}function ei(n,e){M(n);let t=n.toolManager.bufferAnalysisTool;return a(t)&&t instanceof fn||(t=new fn(n,e),n.toolManager.bufferAnalysisTool=t),t}function Ze(n,e,t,i,s,r){this.viewer=n;let o=new d(0,0,0);d.normalize(t,o);let l=new d(0,0,0);d.normalize(e,l);let c=new d(0,0,0);d.cross(l,o,c),d.normalize(c,c),d.cross(o,c,l),d.normalize(l,l);let h=new d(0,0,0),u=d.multiplyByScalar(t,i,h),f=new Ue,m=new Q,w=new d;Ue.fromAxisAngle(l,r*.5,f),Q.fromQuaternion(f,m),Q.multiplyByVector(m,u,w),d.normalize(w,o),d.cross(l,o,c),d.normalize(c,c),Ue.fromAxisAngle(c,s*.5,f),Q.fromQuaternion(f,m),Q.multiplyByVector(m,w,w);let y=[],v=[],C=T.toRadians(10),_=Math.ceil(s/C)+1,P=Math.ceil(r/C)+1,H=s/(_-1),X=r/(P-1);for(let j=0;j<_;j++){Ue.fromAxisAngle(c,-j*H,f),Q.fromQuaternion(f,m);let Ce=new d;Q.multiplyByVector(m,w,Ce);let fe=[];for(let Je=0;Je<P;Je++){Ue.fromAxisAngle(l,-Je*X,f),Q.fromQuaternion(f,m);let oe=new d;Q.multiplyByVector(m,Ce,oe),d.add(e,oe,oe),fe.push(oe)}y.push(new _e({geometry:new Ie({positions:fe,width:1,vertexFormat:be.VERTEX_FORMAT}),attributes:{color:se.fromColor(S.WHITE)}})),v.push(fe)}for(let j=0;j<P;j++){let Ce=[];for(let fe=0;fe<_;fe++)Ce.push(v[fe][j]);y.push(new _e({geometry:new Ie({positions:Ce,width:1,vertexFormat:be.VERTEX_FORMAT}),attributes:{color:se.fromColor(S.WHITE)}}))}y.push(new _e({geometry:new Ie({positions:[e,v[0][0]],width:1,vertexFormat:be.VERTEX_FORMAT}),attributes:{color:se.fromColor(S.WHITE)}})),y.push(new _e({geometry:new Ie({positions:[e,v[0][P-1]],width:1,vertexFormat:be.VERTEX_FORMAT}),attributes:{color:se.fromColor(S.WHITE)}})),y.push(new _e({geometry:new Ie({positions:[e,v[_-1][0]],width:1,vertexFormat:be.VERTEX_FORMAT}),attributes:{color:se.fromColor(S.WHITE)}})),y.push(new _e({geometry:new Ie({positions:[e,v[_-1][P-1]],width:1,vertexFormat:be.VERTEX_FORMAT}),attributes:{color:se.fromColor(S.WHITE)}})),this.lines=this.viewer.scene.primitives.add(new ws({geometryInstances:y,appearance:new be({renderState:{depthTest:{enabled:!0}}})})),this.destroy=function(){this.viewer.scene.primitives.remove(this.lines),delete this.lines,delete this.viewer}}const Gr=`uniform float czzj;
    uniform float dis;
    uniform float spzj;
    uniform float show;
    uniform vec3 visibleColor;
    uniform vec3 disVisibleColor;
    uniform float mixNum;
    uniform sampler2D colorTexture;
    uniform sampler2D stcshadow;
    uniform sampler2D depthTexture;
    uniform mat4 _shadowMap_matrix;
    uniform vec4 shadowMap_lightPositionEC;
    uniform vec4 shadowMap_lightDirectionEC;
    uniform vec3 shadowMap_lightUp;
    uniform vec3 shadowMap_lightDir;
    uniform vec3 shadowMap_lightRight;
    uniform vec4 shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness;
    uniform vec4 shadowMap_texelSizeDepthBiasAndNormalShadingSmooth;
    in vec2 v_textureCoordinates;
    out vec4 FragColor;
    vec4 toEye(in vec2 uv, in float depth)
    {
      vec2 xy = vec2((uv.x * 2.0 - 1.0),(uv.y * 2.0 - 1.0));
      vec4 posInCamera =czm_inverseProjection * vec4(xy, depth, 1.0);
      posInCamera =posInCamera / posInCamera.w;
      return posInCamera;
    }
    float getDepth(in vec4 depth)
    {
      float z_window = czm_unpackDepth(depth);
      z_window = czm_reverseLogDepth(z_window);
      float n_range = czm_depthRange.near;
      float f_range = czm_depthRange.far;
      return (2.0 * z_window - n_range - f_range) / (f_range - n_range);
    }
    float _czm_sampleShadowMap(sampler2D shadowMap, vec2 uv)
    {
      return texture(shadowMap, uv).r;
    }
    float _czm_shadowDepthCompare(sampler2D shadowMap, vec2 uv, float depth)
    {
      return step(depth, _czm_sampleShadowMap(shadowMap, uv));
    }
    float _czm_shadowVisibility(sampler2D shadowMap, czm_shadowParameters shadowParameters)
    {
      float depthBias = shadowParameters.depthBias;
      float depth = shadowParameters.depth;
      float nDotL = shadowParameters.nDotL;
      float normalShadingSmooth = shadowParameters.normalShadingSmooth;
      float darkness = shadowParameters.darkness;
      vec2 uv = shadowParameters.texCoords;
      depth -= depthBias;
      vec2 texelStepSize = shadowParameters.texelStepSize;
      float radius = 1.0;
      float dx0 = -texelStepSize.x * radius;
      float dy0 = -texelStepSize.y * radius;
      float dx1 = texelStepSize.x * radius;
      float dy1 = texelStepSize.y * radius;
      float visibility = (
      _czm_shadowDepthCompare(shadowMap, uv, depth)+
      _czm_shadowDepthCompare(shadowMap, uv + vec2(dx0, dy0), depth) +
      _czm_shadowDepthCompare(shadowMap, uv + vec2(0.0, dy0), depth) +
      _czm_shadowDepthCompare(shadowMap, uv + vec2(dx1, dy0), depth) +
      _czm_shadowDepthCompare(shadowMap, uv + vec2(dx0, 0.0), depth) +
      _czm_shadowDepthCompare(shadowMap, uv + vec2(dx1, 0.0), depth) +
      _czm_shadowDepthCompare(shadowMap, uv + vec2(dx0, dy1), depth) +
      _czm_shadowDepthCompare(shadowMap, uv + vec2(0.0, dy1), depth) +
      _czm_shadowDepthCompare(shadowMap, uv + vec2(dx1, dy1), depth)) * (1.0 / 9.0);
      return visibility;
    }
    vec3 pointProjectOnPlane(in vec3 planeNormal, in vec3 planeOrigin, in vec3 point)
    {
      vec3 v01 = point -planeOrigin;
      float d = dot(planeNormal, v01) ;
      return (point - planeNormal * d);
    }
    float ptm(vec3 pt)
    {
      return sqrt(pt.x*pt.x + pt.y*pt.y + pt.z*pt.z);
    }
    void main()
    {
      const float PI = 3.141592653589793;
      vec4 color = texture(colorTexture, v_textureCoordinates);
      vec4 currD = texture(depthTexture, v_textureCoordinates);
      if(currD.r>=1.0 || show < 0.5)
      {
      FragColor = color;
      return;
    }
    float depth = getDepth(currD);
    vec4 positionEC = toEye(v_textureCoordinates, depth);
    vec3 normalEC = vec3(1.0);
    czm_shadowParameters shadowParameters;
    shadowParameters.texelStepSize = shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.xy;
    shadowParameters.depthBias = shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.z;
    shadowParameters.normalShadingSmooth = shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.w;
    shadowParameters.darkness = shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness.w;
    shadowParameters.depthBias *= max(depth * 0.01, 1.0);
    vec3 directionEC = normalize(positionEC.xyz - shadowMap_lightPositionEC.xyz);
    float nDotL = clamp(dot(normalEC, -directionEC), 0.0, 1.0);
    vec4 shadowPosition = _shadowMap_matrix * positionEC;
    shadowPosition /= shadowPosition.w;
    if (any(lessThan(shadowPosition.xyz, vec3(0.0))) || any(greaterThan(shadowPosition.xyz, vec3(1.0))))
    {
      FragColor = color;
      return;
     }
    vec4 lw = czm_inverseView*  vec4(shadowMap_lightPositionEC.xyz, 1.0);
    vec4 vw = czm_inverseView* vec4(positionEC.xyz, 1.0);
    if(distance(lw.xyz,vw.xyz)>dis)
    {
      FragColor = color;
      return;
     }
    vec3 ptOnSP = pointProjectOnPlane(shadowMap_lightUp,lw.xyz,vw.xyz);
    directionEC = ptOnSP - lw.xyz;
    float directionECMO = ptm(directionEC.xyz);
    float shadowMap_lightDirMO = ptm(shadowMap_lightDir.xyz);
    float cosJJ = dot(directionEC,shadowMap_lightDir)/(directionECMO*shadowMap_lightDirMO);
    float degJJ = acos(cosJJ)*(180.0 / PI);
    degJJ = abs(degJJ);
    if(degJJ>spzj/2.0)
    {
      FragColor = color;
      return;
     }
    vec3 ptOnCZ = pointProjectOnPlane(shadowMap_lightRight,lw.xyz,vw.xyz);
    vec3 dirOnCZ = ptOnCZ - lw.xyz;
    float dirOnCZMO = ptm(dirOnCZ);
    float cosJJCZ = dot(dirOnCZ,shadowMap_lightDir)/(dirOnCZMO*shadowMap_lightDirMO);
    float degJJCZ = acos(cosJJCZ)*(180.0 / PI);
    degJJCZ = abs(degJJCZ);
    if(degJJCZ>czzj/2.0)
    {
      FragColor = color;
      return;
     }
    shadowParameters.texCoords = shadowPosition.xy;
    shadowParameters.depth = shadowPosition.z;
    shadowParameters.nDotL = nDotL;
    float visibility = _czm_shadowVisibility(stcshadow, shadowParameters);
    if(visibility==1.0)
    {
      FragColor = mix(color,vec4(visibleColor,1.0),mixNum);
    }
    else
    {
      if(abs(shadowPosition.z-0.0)<0.01)
      {
      return;
     }
    FragColor = mix(color,vec4(disVisibleColor,1.0),mixNum);
  }
   }`;class pn{constructor(e,t){this.viewer=e,this.viewer.scene.globe.depthTestAgainstTerrain=!0;var i=this;this.handler=new ae(this.viewer.canvas);var s=$();this.handler.setInputAction(function(r){var o=$();if(!(o-s<100)){s=o;var l=ve(i.viewer.scene,r.position);a(l)&&(a(i._origin)?(i.updateTarget(l),i.destroy()):i._origin=l)}},F.LEFT_CLICK),this.handler.setInputAction(function(r){var o=ve(i.viewer.scene,r.endPosition);if(a(o)&&a(i._origin)){var l=d.distance(i._origin,o);l>=.1&&l<1e4&&i.updateTarget(o)}},F.MOUSE_MOVE),t=p(t,{}),this._origin=t.origin,this._direction=t.direction,this._distance=T.clamp(p(t.distance,10),.1,1e4),this._horizontalFov=T.clamp(p(t.horizontalFov,120),1,120),this._verticalFov=T.clamp(p(t.verticalFov,60),1,90),this._alpha=T.clamp(p(t.alpha,.5),0,1),this._visibleColor=p($e(t.visibleColor),S.GREEN.withAlpha(this._alpha)),this._hiddenColor=p($e(t.hiddenColor),S.RED.withAlpha(this._alpha)),this.show=!0,this._outRange=!1,this._range=2e5,this._direction&&d.normalize(this._direction,this._direction),this._direction&&(d.normalize(this._direction,this._direction),this.radar=new Ze(this.viewer,this._origin,this._direction,this._distance,T.toRadians(this._verticalFov),T.toRadians(this._horizontalFov)),this.render())}get type(){return"viewshed"}get hiddenColor(){return this._hiddenColor}set hiddenColor(e){this._hiddenColor=$e(e)}get visibleColor(){return this._visibleColor}set visibleColor(e){this._visibleColor=$e(e)}get alpha(){return this._alpha}set alpha(e){this._alpha=T.clamp(e===void 0?.5:e,0,1)}get horizontalFov(){return this._horizontalFov}set horizontalFov(e){this._horizontalFov=T.clamp(e===void 0?120:e,1,120),this.radar&&(this.radar.destroy(),this.radar=new Ze(this.viewer,this._origin,this._direction,this._distance,T.toRadians(this._verticalFov),T.toRadians(this._horizontalFov)))}get verticalFov(){return this._verticalFov}set verticalFov(e){this._verticalFov=T.clamp(e===void 0?60:e,1,90),this.radar&&(this.radar.destroy(),this.radar=new Ze(this.viewer,this._origin,this._direction,this._distance,T.toRadians(this._verticalFov),T.toRadians(this._horizontalFov)))}get distance(){return this._distance}set distance(e){this._distance=T.clamp(e===void 0?10:e,.1,1e3),this.radar&&(this.radar.destroy(),this.radar=new Ze(this.viewer,this._origin,this._direction,this._distance,T.toRadians(this._verticalFov),T.toRadians(this._horizontalFov)))}update(e){this.viewShadowMap&&e.shadowMaps.push(this.viewShadowMap);var t=d.distance(this.viewer.camera.position,this._origin);t>=this._range?this._outRange=!0:this._outRange=!1,this.radar&&(this.radar.lines.show=this.show)}render(){var e=this,t=new d(0,0,0);d.normalize(e._direction,t);var i=new d(0,0,0);d.normalize(e._origin,i);var s=new d(0,0,0);d.cross(i,t,s),d.normalize(s,s),d.cross(t,s,i),d.normalize(i,i);var r=new gt(e.viewer.scene);r.position=e._origin,r.direction=t,r.up=i,r.frustum=new Zn({fov:T.toRadians(120),aspectRatio:e.viewer.scene.canvas.clientWidth/e.viewer.scene.canvas.clientHeight,near:.1,far:5e3}),e.camera=r,this.viewShadowMap=new Jn({lightCamera:r,enabled:!1,isPointLight:!1,isSpotLight:!0,cascadesEnabled:!1,context:e.viewer.scene.context,pointLightRadius:e._distance}),e.viewer.scene.primitives.add(e),e.bias=e.viewShadowMap._isPointLight?e.viewShadowMap._pointBias:e.viewShadowMap._primitiveBias,this.postProcess=new Ei({fragmentShader:Gr,uniforms:{czzj:function(){return e._verticalFov},dis:function(){return e._distance},show:function(){return e.show&&!e._outRange?1:0},spzj:function(){return e._horizontalFov},visibleColor:function(){return e._visibleColor},disVisibleColor:function(){return e._hiddenColor},mixNum:function(){return e._alpha},stcshadow:function(){return e.viewShadowMap._shadowMapTexture},_shadowMap_matrix:function(){return e.viewShadowMap._shadowMapMatrix},shadowMap_lightPositionEC:function(){return e.viewShadowMap._lightPositionEC},shadowMap_lightDirectionEC:function(){return e.viewShadowMap._lightDirectionEC},shadowMap_lightUp:function(){return e.viewShadowMap._lightCamera.up},shadowMap_lightDir:function(){return e.viewShadowMap._lightCamera.direction},shadowMap_lightRight:function(){return e.viewShadowMap._lightCamera.right},shadowMap_texelSizeDepthBiasAndNormalShadingSmooth:function(){var o=new E;return o.x=1/e.viewShadowMap._textureSize.x,o.y=1/e.viewShadowMap._textureSize.y,Ke.fromElements(o.x,o.y,e.bias.depthBias,e.bias.normalShadingSmooth,new Ke)},shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness:function(){return Ke.fromElements(e.bias.normalOffsetScale,e.viewShadowMap._distance,e.viewShadowMap.maximumDistance,e.viewShadowMap._darkness,new Ke)},depthTexture1:function(){var o=e.viewer.scene._view,l=e.viewer.scene._environmentState.useGlobeDepthFramebuffer,c=l?o.globeDepth.framebuffer:void 0;return p(c,o.sceneFramebuffer.getFramebuffer()).depthStencilTexture}}}),e.viewer.scene.postProcessStages.add(this.postProcess)}updateTarget(e){this._direction=d.subtract(e,this._origin,new d),d.normalize(this._direction,this._direction),this._distance=d.distance(e,this._origin);var t=new d(0,0,0);d.normalize(this._direction,t);var i=new d(0,0,0);d.normalize(this._origin,i);var s=new d(0,0,0);d.cross(i,t,s),d.normalize(s,s),d.cross(t,s,i),d.normalize(i,i),this.camera?(this.camera.direction=t,this.camera.up=i):this.render(),this.radar&&this.radar.destroy(),this.radar=new Ze(this.viewer,this._origin,this._direction,this._distance,T.toRadians(this._verticalFov),T.toRadians(this._horizontalFov))}remove(){this.viewer.scene.primitives.remove(this),this.viewer.scene.postProcessStages.remove(this.postProcess),this.radar&&(this.radar.destroy(),delete this.radar),a(this.postProcess)&&delete this.postProcess,a(this.viewShadowMap)&&delete this.viewShadowMap,a(this.camera)&&delete this.camera,a(this.viewer)&&delete this.viewer}destroy(){a(this.handler)&&(this.handler.destroy(),delete this.handler)}}class mn extends ee{constructor(e,t){super(),M(e),this.map=e,this.addEventListener("start_inserting_viewshed",i=>{e.dispatchEvent({type:"cancel_insertions"})}),e.scene.addEventListener("viewshed_removed",i=>{i.viewshed.remove()})}start(e){this.dispatchEvent({type:"start_inserting_viewshed"});let t=this,i=new pn(L(this.map),e),s=this.map.addEventListener("cancel_insertions",function(){i.destroy(),s()}),r=0,o=new ae(de(this.map));return o.setInputAction(function(l){let c=x.pickPosition(L(t.map).scene,l.position);a(c)&&(r>0&&(o.destroy(),setTimeout(()=>{t.map.isTooling=!1},500)),r++)},F.LEFT_CLICK),this.map.scene.addViewshed(i),i}}function gn(n,e){M(n);let t=n.toolManager.viewshedAnalysis;return a(t)&&t instanceof mn||(t=new mn(n,e),n.toolManager.viewshedAnalysis=t),t}function Be(n,e,t){if(ho(e)){if(n.flying)return;e(t)}}class te{constructor(e){M(e),this.map=e,this.enable=!0,this.handler=new ae(de(this.map)),this.timer=null}leftClick(e){let t=this;this.handler.setInputAction(function(i){clearTimeout(t.timer),t.timer=window.setTimeout(function(){Be(t.map,e,i)},20)},F.LEFT_CLICK)}leftDoubleClick(e){let t=this;this.handler.setInputAction(function(i){clearTimeout(t.timer),Be(t.map,e,i)},F.LEFT_DOUBLE_CLICK)}mouseMove(e,t=10){let i=this;this.handler.setInputAction(function(s){clearTimeout(i.timer),i.timer=window.setTimeout(function(){Be(i.map,e,s)},t)},F.MOUSE_MOVE)}rightClick(e){let t=this;this.handler.setInputAction(function(i){Be(t.map,e,i)},F.RIGHT_CLICK)}wheel(e){let t=this;this.handler.setInputAction(function(i){clearTimeout(t.timer),t.timer=window.setTimeout(function(){Be(t.map,e,i)},200)},F.WHEEL)}other(e,t){let i=this;this.handler.setInputAction(function(s){Be(i.map,t,s)},e)}remove(e){this.handler.removeInputAction(e)}destroy(){a(this.handler)&&(this.handler.destroy(),delete this.handler)}}function jr(n={}){let e={transparent:!0};n.repeat&&(e.repeat=new E(n.repeat||1,1));let t=n.width||200,i=n.height||10,s=n.colorLine||"red",r=n.colorArrow||"#00ff00",o=`<svg viewBox="0 0 800 40" width="${t}" height="${i}" version="1.1" xmlns="http://www.w3.org/2000/svg">
<defs><marker id="arrow" markerUnits="strokeWidth" markerWidth="6" markerHeight="6" viewBox="0 0 6 6" refX="3" refY="3" orient="auto"><path d="M1,1 L5,3 L1,5 L1,1" style="fill: ${r};" /></marker></defs><g><path d="M0,20 L400,20"  stroke="${s}" 
stroke-width="10"/><path d="M400,20 L800,20"  stroke="${s}" stroke-width="10"  marker-start="url(#arrow)"/></g></svg>`;return e.image=Vt(o),new Si(e)}function $r(n,e,t){let i=e.mRecordPointList;if(a(i))i instanceof Array||(i=[i],e.mRecordPointList=[i]),n.mRecordPoint=i[0],n.id=n.mRecordPoint.Obj_id;else throw new Error("航迹格式有误");let s=n.mRecordPoint.TowerPointList,r=[];s.forEach((l,c)=>{let h=d.fromDegrees(l.aircraftLongitude,l.aircraftLatitude,l.aircraftAltitude);r.push(h),l.isShoot!==!1&&n.pointDataSource.entities.add({position:h,point:{color:S.fromCssColorString(t.lineOptions.colorPoint||"yellow"),pixelSize:t.lineOptions.pointSize||8,distanceDisplayCondition:new k(0,1e3),disableDepthTestDistance:200},type:"flight_shoot_point",info:c})});let o=Yr(n,s,t);n.lineEntity=n.dataSource.entities.add({polyline:{positions:r,material:jr({repeat:t.repeat||s.length-1,colorLine:t.lineOptions.colorLine,colorArrow:t.lineOptions.colorArrow}),width:t.lineOptions.lineWidth||6,distanceDisplayCondition:new k(0,1e4)}}),n.entity=n.dataSource.entities.add({id:n.id,position:o,model:{uri:R()+"/Assets/models/uav/dji.gltf",scale:t.modelSize||.1,minimumPixelSize:10}})}function Yr(n,e,t){let i=t.stayTime||1,s=t.speed||8,r=new Ae,o=new Ct(Number),l=t.refineTime||b.now(),c=b.addSeconds(b.clone(l),-2,new b);n.viewer.clock.currentTime=c,n.flightStartTime=l;let h=0,u=[];for(let m=0;m<e.length;m++){let w,y=d.fromDegrees(e[m].aircraftLongitude,e[m].aircraftLatitude,e[m].aircraftAltitude);if(m>0){let C=d.distance(d.fromDegrees(e[m-1].aircraftLongitude,e[m-1].aircraftLatitude,e[m-1].aircraftAltitude),d.fromDegrees(e[m].aircraftLongitude,e[m].aircraftLatitude,e[m].aircraftAltitude));h+=C/s,w=b.addSeconds(l,h,new b),o.addSample(b.addSeconds(l,h,new b),m),r.addSample(w,y)}else w=c,o.addSample(c,m),r.addSample(w,y);e[m].isShoot&&(h+=i);let v=b.addSeconds(l,h,new b);r.addSample(v,y),m===e.length-1&&(r.addSample(b.addDays(l,36500,new b),y),o.addSample(b.addSeconds(l,h,new b),m)),u[m]=w}n.event.leftClick(m=>{let w=n.viewer.scene.pick(m.position);w&&w.id&&w.id.type==="flight_shoot_point"&&(n.viewer.clock.currentTime=u[w.id.info])});let f;return n.listener=n.viewer.clock.onTick.addEventListener(function(m){let w=o.getValue(m.currentTime);if(a(w)){if(w=Math.floor(w),f===w)return;f=w,e[f]&&e[f].isShoot&&(n.dispatchEvent({type:"fly-orientation",data:e[f]}),a(t.towerEvent)&&t.towerEvent(e[f])),w===e.length-1&&(n.dispatchEvent({type:"fly-end",data:n}),n.option.stopWhenEnd?n.viewer.clock.currentTime=n.flightStartTime:n.viewer.clock.shouldAnimate=!1)}}),r}class lt extends ee{constructor(e,t,i){super();let s=e._viewer;this.viewer=s,this.event=new te(e),this.dataSource=new B,s.dataSources.add(this.dataSource),this.pointDataSource=new B,s.dataSources.add(this.pointDataSource),this.viewer.clock.multiplier=i.fastForwardSpeed,this.entity=void 0,this.lineEntity=void 0,this.option=i,$r(this,t,i),this.viewer.clock.shouldAnimate=!0}destroy(){this.viewer.dataSources.remove(this.pointDataSource),this.viewer.dataSources.remove(this.dataSource),this.entity=void 0,this.lineEntity=void 0,this.viewer.clock.multiplier=1,this.listener(),this.listener=void 0,this.event.destroy()}}function vn(n,e,t,i=!0){if(e=e.missionRoute,!e)throw new Error("传递数据有误");let s=[],r=[],o=!0,l=t.stayTime||1,c=t.speed||8,h=new Ae,u=new Ct(Number),f=t.refineTime||b.now(),m=b.addSeconds(b.clone(f),-2,new b);n.viewer.clock.currentTime=m,n.flightStartTime=f;let w=0,y=[],v={};for(let C=0;C<e.length;C++){let _=d.fromDegrees(e[C].airCraftLongitude,e[C].airCraftLatitude,e[C].airCraftAltitude);if(o){v[e[C].airCraftLongitude]?v[e[C].airCraftLongitude].airCraftLatitude===e[C].airCraftLatitude&&v[e[C].airCraftLongitude].airCraftAltitude===e[C].airCraftAltitude&&(v[e[C].airCraftLongitude].y1-=40,v[e[C].airCraftLongitude].y2-=40):v[e[C].airCraftLongitude]={airCraftLatitude:e[C].airCraftLatitude,airCraftAltitude:e[C].airCraftAltitude,x1:0,y1:0,x2:-6,y2:6},n.billboardDataSource.add({position:_,image:R()+"/Assets/Images/img/fixed_line_point1.png",scale:.3,distanceDisplayCondition:new k(0,5e3),pixelOffset:new E(v[e[C].airCraftLongitude].x1,v[e[C].airCraftLongitude].y1)});let P;if(C<9?P=new E(v[e[C].airCraftLongitude].x2,v[e[C].airCraftLongitude].y2):P=new E(v[e[C].airCraftLongitude].x2-4,v[e[C].airCraftLongitude].y2),n.labelDataSource.add({text:C+1+"",position:_,font:"600 24px Helvetica",scale:.8,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,distanceDisplayCondition:new k(0,5e3),pixelOffset:P}),n.labelDataSource.add({text:"海拔:"+e[C].airCraftAltitude.toFixed(2)+"m",position:_,font:"600 24px Helvetica",scale:.6,fillColor:S.WHITE,outlineColor:S.BLACK,outlineWidth:3,showBackground:!0,style:J.FILL_AND_OUTLINE,distanceDisplayCondition:new k(0,5e3),pixelOffset:new E(20,3)}),C<e.length-1&&!e[C].isDetails&&o){let H=new d.fromDegrees(e[C+1].airCraftLongitude,e[C+1].airCraftLatitude,e[C+1].airCraftAltitude),X=d.distance(_,H),j=new d;d.midpoint(_,H,j),n.labelDataSource.add({text:"间距:"+X.toFixed(2)+"m",position:j,font:"600 24px Helvetica",scale:.6,fillColor:S.WHITE,outlineColor:S.BLACK,outlineWidth:3,showBackground:!0,style:J.FILL_AND_OUTLINE,distanceDisplayCondition:new k(0,5e3),pixelOffset:new E(5,3)})}r.push(_),y.push({heading:e[C].rtkFusionHeading,pitch:.2,isShoot:!1}),e[C].isDetails&&Zr(n,e[C].details,r,y,t)}else s.push(_),y.push({heading:e[C].rtkFusionHeading,pitch:.2});e[C].mark&&e[C].mark==="2"&&(o&&(s=Ci(r,!0)),o=!1)}if(i){s.forEach((_,P)=>{let H;if(P>0){let j=d.distance(s[P-1],_);w+=j/c,H=b.addSeconds(f,w,new b),u.addSample(b.addSeconds(f,w,new b),P),h.addSample(H,_)}else H=m,u.addSample(m,P),h.addSample(H,_);y[P].isShoot?w+=l:w+=.1;let X=b.addSeconds(f,w,new b);h.addSample(X,_),P===s.length-1&&(h.addSample(b.addDays(f,36500,new b),_),u.addSample(b.addSeconds(f,w,new b),P))});let C;n.listener=n.viewer.clock.onTick.addEventListener(function(_){let P=u.getValue(_.currentTime);if(a(P)){if(P=Math.floor(P),C===P)return;C=P,n.dispatchEvent({type:"fixedFlight-orientation",data:y[C]}),P===s.length-1&&(n.dispatchEvent({type:"fixedFlight-end",data:n}),n.option.stopWhenEnd&&(n.viewer.clock.currentTime=n.flightStartTime))}})}n.lineEntity=n.dataSource.entities.add({polyline:{positions:r,width:3,material:new U({color:S.fromCssColorString(t.colorLine||"white")})}}),n.entity=n.dataSource.entities.add({position:h,billboard:{image:t.lineOptions.uavImage,scale:.38,color:ii()}})}function Zr(n,e,t,i,s){if(!a(e))return;let r=e.mRecordPointList,o;if(a(r))r instanceof Array||(r=[r]),o=r[0];else return;let l=o.towerPointList,c=[],h={type:"1",positions:[]};l.forEach((u,f)=>{let m=d.fromDegrees(u.aircraftLongitude,u.aircraftLatitude,u.aircraftAltitude);t.push(m),i.push({heading:u.rtkFusionHeading,pitch:u.gimbalPitchValue,isShoot:u.isShoot}),u.isShoot!==!1&&n.pointDataSource.add({position:m,color:S.fromCssColorString("yellow"),pixelSize:s.pointSize||10,distanceDisplayCondition:new k(0,1e4),disableDepthTestDistance:200}),u.patrolType===h.type?h.positions.push(m):(h.positions.push(m),c.push(h),h={type:u.patrolType,positions:[m]})}),c.push(h),c.forEach(u=>{let f=S.fromCssColorString("#56E5B1");u.type=="2"?f=S.fromCssColorString("#68C0FF"):u.type=="3"&&(f=S.fromCssColorString("#FFB752")),n.dataSource.entities.add({polyline:{positions:u.positions,width:4,material:new U({color:f})}})})}let ti=class extends ee{constructor(e,t,i){super(),this.viewer=e,this.dataSource=new B,e.dataSources.add(this.dataSource),this.pointDataSource=new bt,e.scene.primitives.add(this.pointDataSource),this.labelDataSource=new Ge,e.scene.primitives.add(this.labelDataSource),this.billboardDataSource=new Le,e.scene.primitives.add(this.billboardDataSource),this.entity=void 0,this.lineEntity=void 0,this.option=i,vn(this,t,i),this.viewer.clock.multiplier=i.fastForwardSpeed,this.viewer.clock.shouldAnimate=!0}destroy(){this.viewer.scene.primitives.remove(this.pointDataSource),this.viewer.scene.primitives.remove(this.labelDataSource),this.viewer.scene.primitives.remove(this.billboardDataSource),this.viewer.dataSources.remove(this.dataSource),this.entity=void 0,this.lineEntity=void 0,this.viewer.clock.multiplier=1,this.listener(),this.listener=void 0}};function Jr(n,e){let t=new jn(n,{homeButton:!1,fullscreenButton:!1,sceneModePicker:!1,clockViewModel:e.clockViewModel,infoBox:!1,geocoder:!1,navigationHelpButton:!1,animation:!1,baseLayerPicker:!1,timeline:!1,imageryProvider:e.imageryLayers.get(0)._imageryProvider});t._cesiumWidget._creditContainer.style.display="none",t.scene.screenSpaceCameraController.enableRotate=!1,t.scene.screenSpaceCameraController.enableTranslate=!1,t.scene.screenSpaceCameraController.enableZoom=!1,t.scene.screenSpaceCameraController.enableTilt=!1,t.scene.screenSpaceCameraController.enableLook=!1;for(let i=1;i<e.imageryLayers.length;i++){const s=e.imageryLayers.get(i).imageryProvider;t.imageryLayers.addImageryProvider(s)}return t}class wn{constructor(e,t){this.viewer=e,this.dom=document.getElementById(t),this.view=Jr(this.dom,this.viewer)}destroy(){a(this.view)&&(this.view.scene.primitives.removeAll(),this.view.destroy(),this.view=null,delete this.view,a(this.viewer)&&delete this.viewer)}}let ht=new O,Kr=new d;function yn(n,e,t){let i=ie.getValueOrUndefined(n.position,e,Kr);return t=le.eastNorthUpToFixedFrame(i,void 0,t),t}function ct(n,e={}){return(!a(e)||!re(e.lineOptions))&&(e.lineOptions=n.lineOptions),a(e.stopWhenEnd)||(e.stopWhenEnd=n.stopWhenEnd),a(e.speed)||(e.speed=n.speed),a(e.stayTime)||(e.stayTime=n.stayTime),e.fastForwardSpeed=n.fastForwardSpeed,e}class Cn{constructor(e){this.map=e,this.viewer=e._viewer,this.flight=null,this.stopWhenEnd=!0,this.speed=8,this.stayTime=1,this.viewFrom=[-50,0,50],this.lineOptions={},this.fastForwardSpeed=1,this.currentType=1}add(e,t){a(this.flight)&&this.remove(this.flight),this.currentType=1;let i;if(e.mRecordPointList instanceof Array||(e.mRecordPointList=[e.mRecordPointList]),e instanceof Array&&e.length!=0){let s=e[0];for(let r=0;r<e.length-1;r++){let o=e[r],l=e[r+1],c=o.mRecordPointList[0].TowerPointList[o.mRecordPointList[0].TowerPointList.length-1];c.aircraftAltitude=o.mRecordPointList[0].TowerPointList[0].aircraftAltitude,s.mRecordPointList[0].TowerPointList.push(c),s.mRecordPointList[0].TowerPointList=s.mRecordPointList[0].TowerPointList.concat(l.mRecordPointList[0].TowerPointList)}e=s}return i=new lt(this.map,e,ct(this,t)),this.flight=i,i}addFixedFlight(e,t){a(this.flight)&&this.remove(this.flight),this.currentType=2;let i;return ct(this,t),i=new ti(L(this.map),e,ct(this,t)),this.flight=i,i}fly(e,t){a(e)&&(this.entity=e.entity,e.entity.viewFrom=new d(...this.viewFrom),this.currentType===1?this.viewer.trackedEntity=e.entity:this.viewer.flyTo(e.entity),e instanceof lt?a(t)&&this.showMiniMap(e,t):e instanceof ti&&a(t)&&this.showFixedFlightMiniMap(e,t))}showMiniMap(e,t){if(!a(e))return;this.miniViewer=new wn(this.viewer,t);let i=this,s=e.tile;s instanceof Array||(s=[s]),s.forEach(o=>{if(o instanceof pe)this.miniViewer.view.scene.primitives.add(o);else{o.url=o.url.replace(/#/g,"%23");let l=new pe(o);this.miniViewer.view.scene.primitives.add(l)}});let r;this.flyOrientationHandler=e.addEventListener("fly-orientation",function(o){r=o.data,r&&r.isShoot&&(yn(e.entity,i.viewer.clock.currentTime,ht),i.miniViewer.view.scene.camera.lookAtTransform(ht,new Ve(T.toRadians(r.airCraftYawValue),T.toRadians(r.gimbalPitchValue),.2)))})}showFixedFlightMiniMap(e,t){this.miniViewer=new wn(this.viewer,t);let i=this,s=e.tile;s&&s.forEach((o,l)=>{if(o instanceof pe)this.miniViewer.view.scene.primitives.add(o);else{o.url=o.url.replace(/#/g,"%23"),o.maximumScreenSpaceError=16;let c=new pe(o);this.miniViewer.view.scene.primitives.add(c),l===0&&this.miniViewer.view.flyTo(c,{duration:0})}});let r;this.flyOrientationHandler=e.addEventListener("fixedFlight-orientation",function(o){r=o.data,r.isShoot&&(yn(e.entity,i.viewer.clock.currentTime,ht),i.miniViewer.view.scene.camera.lookAtTransform(ht,new Ve(T.toRadians(r.heading),T.toRadians(r.pitch),.2)))})}pause(){this.viewer.clock.shouldAnimate=!1}continue(){this.viewer.clock.shouldAnimate=!0}setTrack(e){this.flight&&(e?this.viewer.trackedEntity=this.flight.entity:this.viewer.trackedEntity=void 0)}setFastForwardSpeed(e){if(e>64)throw new Error("模拟速度过快，不高于64");this.viewer.clock.multiplier=e,this.fastForwardSpeed=e,this.viewer.clock.shouldAnimate=!0}remove(e){(e instanceof lt||e instanceof ti)&&a(this.flight)&&(e.destroy(),this.viewer.trackedEntity=void 0,this.flyOrientationHandler&&this.flyOrientationHandler(),this.miniViewer&&(this.miniViewer.destroy(),this.miniViewer=null),this.flight=null)}}function qr(n){M(n);let e=n.flightLineManager;return a(e)&&e instanceof Cn||(e=new Cn(n),n.flightLineManager=e),e}function ii(){let n=.8,e=!0;return new W(function(){return e?(n=n-.02,n<=0&&(e=!1)):(n=n+.02,n>=1&&(e=!0)),S.fromCssColorString("cyan").withAlpha(n)},!1)}class Xr extends ee{constructor(e,t,i){super(),this.viewer=e,this.dataSource=new B,e.dataSources.add(this.dataSource),this.pointDataSource=new bt,e.scene.primitives.add(this.pointDataSource),this.labelDataSource=new Ge,e.scene.primitives.add(this.labelDataSource),this.billboardDataSource=new Le,e.scene.primitives.add(this.billboardDataSource),this.entity=void 0,this.lineEntity=void 0,this.option=i,vn(this,t,i,!1),this.viewer.clock.multiplier=i.fastForwardSpeed,this.viewer.clock.shouldAnimate=!0}destroy(){this.viewer.scene.primitives.remove(this.pointDataSource),this.viewer.scene.primitives.remove(this.labelDataSource),this.viewer.scene.primitives.remove(this.billboardDataSource),this.viewer.dataSources.remove(this.dataSource),this.entity=void 0,this.lineEntity=void 0,this.viewer.clock.multiplier=1}}function _n(n,e){let t=new Ae;n.forEach(s=>{let r=b.addSeconds(b.fromDate(new Date(s.createTime)),e.stayTime,new b);t.addSample(r,d.fromDegrees(s.jd,s.wd,s.alt))});let i=b.addSeconds(b.fromDate(new Date(n[n.length-1].createTime)),e.timeout,new b);return t.addSample(i,d.fromDegrees(n[n.length-1].jd,n[n.length-1].wd,n[n.length-1].alt)),t}function bn(n,e){n.planeList[e.deviceCode]={data:[e],taskId:e.taskId,deviceCode:e.deviceCode};let t=_n(n.planeList[e.deviceCode].data,n.opt);n.dataSource.entities.add({id:e.deviceCode,position:t,billboard:{image:n.uavImage,scale:.25,color:ii()},type:"real-time-uav_fixed"})}function Qr(n){return n.pathTime||(n.pathTime=10),n.timeout||(n.timeout=60),n.stayTime||(n.stayTime=3),n.lineColor||(n.lineColor=A.YELLOW),n.path||(n.path={default:!1}),n}class eo{constructor(e,t={}){M(e),t=Qr(t),this.map=e,this.viewer=this.map._viewer,this.planeList={},this.dataSource=new B,this.viewer.dataSources.add(this.dataSource),this.interval=null,this.opt=t,this.handler=new ae(this.viewer.scene.canvas),this.init(t.timeout),this.isCurrentTimeInit=!0,this.flight=null,this.stopWhenEnd=!0,this.speed=8,this.stayTime=1,this.viewFrom=[-50,0,50],this.lineOptions=t.lineOptions||{},this.fastForwardSpeed=1,this.uavImage=t.uavImage,a(t.fixedLine)&&(this.fl=new Xr(this.map._viewer,t.fixedLine,ct(this,t)),this.fl.lineOptions=this.lineOptions)}init(e){let t=this.viewer,i=this;t.clock.multiplier=1,t.clock.shouldAnimate=!0,this.handler.setInputAction(function(s){let r=t.scene.pick(s.position);a(r)&&r.id&&r.id.type==="real-time-uav_fixed"?i.map.dispatchEvent({type:"real-time-uav_fixed",data:{id:r.id.id}}):i.map._viewer.trackedEntity=void 0},F.LEFT_CLICK),this.interval=setInterval(()=>{for(let s in this.planeList){let r=this.planeList[s],o=LiGlobe_Core.JulianDate.toDate(this.viewer.clock.currentTime).getTime(),l=new Date(r.data[r.data.length-1].createTime).getTime();o-l>e*1e3&&(this.dataSource.entities.removeById(s),delete this.planeList[s])}},1e3*e)}start(e){let t=this.viewer;if(e instanceof Array)if(!this.isCurrentTimeInit)e.forEach((i,s)=>{let r=this.planeList[i.deviceCode];if(r){let o=r.data[r.data.length-1];if(o.jd===i.jd&&o.wd===i.wd)return;r.data.push(i);let l=this.dataSource.entities.getById(i.deviceCode);l.position=_n(r.data,this.opt)}else bn(this,i)});else{let i;e.forEach(s=>{i?new Date(s.createTime).getTime()<new Date(i).getTime()&&(i=s.createTime):i=s.createTime,bn(this,s)}),t.clock.currentTime=b.addSeconds(b.fromDate(new Date(i)),-2,new b),this.isCurrentTimeInit=!1}else throw new Error("传递数据类型有误！应是数组")}destroy(){this.viewer.dataSources.remove(this.dataSource),this.planeList={},a(this.handler)&&this.handler.destroy(),a(this.fl)&&this.fl.destroy(),clearInterval(this.interval)}flyTo(e,t={}){let i=this.dataSource.entities.getById(e);a(i)&&this.viewer.flyTo(i,t={})}zoomTo(e){let t=this.dataSource.entities.getById(e);a(t)&&this.viewer.zoomTo(t)}trackOn(e,t=[-50,0,50]){let i=this.dataSource.entities.getById(e);a(i)&&(this.map._viewer.trackedEntity=i,i.viewFrom=new d(...t))}trackOff(){this.map._viewer.trackedEntity=void 0}getRealTimeData(){return this.planeList}}class K{constructor(e){this.viewer=e._viewer,this.dataSource=new B,this.viewer.dataSources.add(this.dataSource)}set show(e){this.dataSource.show=e}get show(){return this.dataSource.show}add(e){return this.dataSource.entities.add(e)}remove(e){this.dataSource.entities.remove(e)}removeById(e){this.dataSource.entities.removeById(e)}addImage(e){let t=this.dataSource.entities.add({id:e.id,position:d.fromDegrees(e.position[0],e.position[1],e.position[2]||0),billboard:{image:e.image.url,width:e.image.width,height:e.image.height,scale:e.image.scale}});return a(e.blink)&&(t.billboard.color=ii()),t}removeAll(){this.dataSource.entities.removeAll()}destroy(){this.removeAll(),this.viewer.dataSources.remove(this.dataSource)}}class ni{constructor(e){this.map=e,this.viewer=e._viewer}start(e){let t=this;this.destroy(),this.datasource=new K(this.map),this.handler=new te(this.map);let i=[],s=this.datasource.add({polyline:{positions:[],material:new U({color:S.GREEN}),width:3}});this.handler.leftClick(r=>{let o=ve(t.viewer,r.position);this.datasource.add({position:o,point:{pixelSize:10,color:S.YELLOW}}),i.length>0&&this.datasource.add({polyline:{positions:[i[i.length-1],o],material:S.GREEN,width:2}}),i.push(o)}),this.handler.mouseMove(r=>{if(i.length>1){r=r.endPosition;let o=ve(t.viewer,r);s.polyline.positions=[i[0],o,i[i.length-1]]}},1),this.handler.rightClick(()=>{if(i.length>2){let r=[];i.forEach(o=>{let l=Ee(t.viewer,o);r.push([l.x,l.y,l.z])}),e(r),t.destroy()}else t.destroy(),t.map.canvas.setAttribute("style","cursor: auto")})}destroy(){a(this.datasource)&&this.datasource.destroy(),a(this.handler)&&this.handler.destroy()}}class Sn{constructor(e){this.map=e,this.viewer=e._viewer}start(e){let t=this;a(this.dynamicPickUp)&&this.dynamicPickUp.destroy(),this.dynamicPickUp=new ni(this.map),this.map.canvas.setAttribute("style","cursor: crosshair"),this.dynamicPickUp.start(i=>{t.compute(i,e),t.map.canvas.setAttribute("style","cursor: auto"),this.dynamicPickUp.destroy()})}compute(e,t={}){if(t.labelOpt=p(t.labelOpt,{}),t.interpolationNum=p(t.interpolationNum,100),!window.turf)throw new Error("需引入turf.js");a(this.dataSource)&&this.dataSource.destroy(),this.dataSource=new K(this.map);let i=1e4,s=0,r=0,o=0,l=[1e4,1e4,0,0],c=t.baseHeight||1e4,h=[];e.forEach(_=>{l[0]=Math.min(_[0],l[0]),l[1]=Math.min(_[1],l[1]),l[2]=Math.max(_[0],l[2]),l[3]=Math.max(_[1],l[3]),a(t.baseHeight)||(c=Math.min(_[2],c))}),e.forEach(_=>{h.push(d.fromDegrees(_[0],_[1],c))});let u=turf.randomPoint(t.interpolationNum,{bbox:l}),f=Oi(l),m=turf.polygon([f]),w=turf.centroid(m).geometry.coordinates;turf.voronoi(u,{bbox:l}).features.forEach(_=>{let P=turf.intersect(m,_);if(P.geometry.coordinates.length>0){let H=P.geometry.coordinates[0],X=0,j=[];H.forEach(Je=>{let oe=ve(this.viewer,_t.wgs84ToWindowCoordinates(this.viewer.scene,d.fromDegrees(...Je)));j.push(oe),oe=Ee(this.viewer,oe),i=Math.min(oe.z,i),s=Math.max(oe.z,s),X+=oe.z});let Ce=X/H.length,fe=Mi(new et(j));c>Ce?o+=(c-Ce)*fe:r+=(Ce-c)*fe}});let v={minHeight:parseFloat(i.toFixed(2)),maxHeight:parseFloat(s.toFixed(2)),cutVolume:Math.round(r/1e4),fillVolume:Math.round(o/1e4),baseHeight:parseFloat(c.toFixed(2))},C=`基准高度：${v.baseHeight}米
挖方体积：${v.cutVolume}万立方米
填方体积：${v.fillVolume}万立方米`;return this.map.depthTestAgainstTerrain=!0,this.dataSource.add({position:d.fromDegrees(w[0],w[1],s+10),label:{text:C,font:t.labelOpt.font||"600 24px Helvetica",scale:t.labelOpt.scale||.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,disableDepthTestDistance:Number.POSITIVE_INFINITY},polygon:{hierarchy:h,material:S.ORANGE.withAlpha(.5)}}),this.dataSource.add({polygon:{hierarchy:h,material:S.YELLOW.withAlpha(.5),perPositionHeight:!0,extrudedHeight:c}}),v}clear(){this.dataSource.destroy(),a(this.dynamicPickUp)&&this.dynamicPickUp.destroy(),this.map.canvas.setAttribute("style","cursor: auto")}}function to(n){let e=n.toolManager.cutFillVolumeAnalysis;return a(e)&&e instanceof Sn||(e=new Sn(n),n.toolManager.cutFillVolumeAnalysis=e),e}class Tn{constructor(e){this.map=e,this.viewer=e._viewer}start(e){let t=this;a(this.dynamicPickUp)&&this.dynamicPickUp.destroy(),this.map.depthTestAgainstTerrain=!0,this.map.canvas.setAttribute("style","cursor: crosshair"),this.dynamicPickUp=new ni(this.map),this.dynamicPickUp.start(i=>{t.compute(i,e),t.map.depthTestAgainstTerrain=!1,t.map.canvas.setAttribute("style","cursor: auto"),t.dynamicPickUp.destroy()})}compute(e,t={}){t.labelOpt=p(t.labelOpt,{}),t.speed=p(t.speed,10),a(this.dataSource)&&this.dataSource.destroy(),this.dataSource=new K(this.map);let i=1e4,s=0,r=t.baseHeight||1e4,o=[];e.forEach(u=>{a(t.baseHeight)||(r=Math.min(u[2],r)),i=Math.min(i,u[2]),s=Math.max(s,u[2]),o.push(d.fromDegrees(u[0],u[1],0))});let l=Fi(o),c=Ee(this.viewer,l),h=i;this.dataSource.add({position:new W(()=>d.fromDegrees(c.x,c.y,h),!1),polygon:{hierarchy:o,extrudedHeight:new W(()=>(h<s&&(h+=t.speed/100),h),!1),material:new S.fromBytes(64,157,253,150),perPositionHeight:!0,extrudedHeightReference:2},polyline:{positions:new W(()=>[l,d.fromDegrees(c.x,c.y,h)],!1),material:S.RED,width:3},label:{text:new W(()=>"水面海拔"+h.toFixed(1)+"m",!1),font:t.labelOpt.font||"600 24px Helvetica",scale:t.labelOpt.scale||.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,disableDepthTestDistance:Number.POSITIVE_INFINITY}})}clear(){a(this.dataSource)&&this.dataSource.destroy(),a(this.dynamicPickUp)&&this.dynamicPickUp.destroy(),this.map.canvas.setAttribute("style","cursor: auto")}}function io(n){let e=n.toolManager.floodAnalysis;return a(e)&&e instanceof Tn||(e=new Tn(n),n.toolManager.floodAnalysis=e),e}class Ln{constructor(e){this.map=e,this.viewer=e._viewer}start(e){let t=this;a(this.dynamicPickUp)&&this.dynamicPickUp.destroy(),this.map.depthTestAgainstTerrain=!0,this.map.canvas.setAttribute("style","cursor: crosshair"),this.dynamicPickUp=new ni(this.map),this.dynamicPickUp.start(i=>{t.compute(i,e),t.map.depthTestAgainstTerrain=!1,t.map.canvas.setAttribute("style","cursor: auto"),t.dynamicPickUp.destroy()})}compute(e,t={}){if(t.labelOpt=p(t.labelOpt,{}),t.cellSide=p(t.cellSide,.02),!window.turf)throw new Error("需引入turf.js");a(this.dataSource)&&this.dataSource.destroy(),this.dataSource=new K(this.map);let i=[180,90,-180,-90],s=[];e.forEach(o=>{i[0]=Math.min(o[0],i[0]),i[1]=Math.min(o[1],i[1]),i[2]=Math.max(o[0],i[2]),i[3]=Math.max(o[1],i[3]),s.push([o[0],o[1]])}),s.push([e[0][0],e[0][1]]),turf.squareGrid(i,t.cellSide,{units:"miles",mask:turf.polygon([s])}).features.forEach(async o=>{let l=o.geometry.coordinates[0],c=[],h=[],u=[];for(let _=0;_<l.length;_++)c.push(q.fromDegrees(...l[_]));(await cs(this.viewer.terrainProvider,c)).forEach(_=>{h.push([T.toDegrees(_.longitude),T.toDegrees(_.latitude),_.height]),u.push(q.toCartesian(_))}),h.sort((_,P)=>_[2]-P[2]);let m=Math.abs(h[4][2]-Math.abs(h[0][2]))/d.distance(d.fromDegrees(h[0][0],h[0][1],0),d.fromDegrees(h[4][0],h[4][1],0)),w=T.toDegrees(Math.atan(m)),y=d.fromDegrees(h[4][0],h[4][1]),v=d.fromDegrees(h[0][0],h[0][1]),C=Ri(h[4][0],h[4][1],h[0][0],h[0][1]);this.dataSource.add({polyline:{positions:[d.lerp(y,v,.3,new d),d.lerp(y,v,.7,new d)],material:new ss(S.ORANGE),width:20,clampToGround:!0},type:"slopeAspect",info:{slope:m,slopeDegrees:w,aspect:C}})})}clear(){a(this.dataSource)&&this.dataSource.destroy(),a(this.dynamicPickUp)&&this.dynamicPickUp.destroy(),this.map.canvas.setAttribute("style","cursor: auto")}}function no(n){let e=n.toolManager.slopeAspectAnalysis;return a(e)&&e instanceof Ln||(e=new Ln(n),n.toolManager.slopeAspectAnalysis=e),e}class En{constructor(e){this.map=e,this.viewer=e._viewer,this.startPos,this.endPos,this.wayPos=[],this.wayEntity=[]}startPoint(){let e=this;this.removeEvent(),this.handler=new te(this.map),this.map.canvas.setAttribute("style","cursor: crosshair"),this.handler.leftClick(t=>{let i=ve(e.viewer,t.position);i&&(e.viewer.entities.removeById("route_plan_start"),e.viewer.entities.add({id:"route_plan_start",position:i,billboard:{image:R()+"/Assets/Images/img/startPoint.png"}}),e.startPos=i),e.map.canvas.setAttribute("style","cursor: auto"),e.removeEvent(),e.compute()})}wayPoint(){let e=this;this.removeEvent(),this.handler=new te(this.map),this.map.canvas.setAttribute("style","cursor: crosshair"),this.handler.leftClick(t=>{let i=ve(e.viewer,t.position);if(i){let s=e.viewer.entities.add({position:i,billboard:{image:R()+"/Assets/Images/img/wayPoint.png"}});e.wayEntity.push(s),e.wayPos.push(i)}e.map.canvas.setAttribute("style","cursor: auto"),e.removeEvent(),e.compute()})}endPoint(){let e=this;this.removeEvent(),this.handler=new te(this.map),this.map.canvas.setAttribute("style","cursor: crosshair"),this.handler.leftClick(t=>{let i=ve(e.viewer,t.position);i&&(e.viewer.entities.removeById("route_plan_end"),e.viewer.entities.add({id:"route_plan_end",position:i,billboard:{image:R()+"/Assets/Images/img/endPoint.png"}}),e.endPos=i),e.map.canvas.setAttribute("style","cursor: auto"),e.compute()})}compute(){if(a(this.startPos)&&a(this.endPos)){let e=[];this.wayPos.length>0?e=[this.startPos,...this.wayPos,this.endPos]:e=[this.startPos,this.endPos],this.viewer.entities.removeById("route_plan_line"),this.viewer.entities.add({id:"route_plan_line",polyline:{positions:e,material:S.YELLOW,clampToGround:!0,width:2}})}}removeEvent(){a(this.handler)&&(this.handler.destroy(),this.handler=null)}clear(){this.removeEvent(),this.viewer.entities.removeById("route_plan_start"),this.viewer.entities.removeById("route_plan_end"),this.viewer.entities.removeById("route_plan_line"),this.startPos=null,this.endPos=null,this.wayPos=[],this.wayEntity.forEach(e=>{this.viewer.entities.remove(e)}),this.wayEntity=[]}}function so(n){let e=n.toolManager.routePlan;return a(e)&&e instanceof En||(e=new En(n),n.toolManager.routePlan=e),e}class si{constructor(e){this.map=e,e.isTooling=!1}get cursor(){return this._cursor}set cursor(e){this._cursor=e}init(e,t){switch(e){case"measure":return Xt(this.map,t);case"bufferanalysis":return ei(this.map,t);case"sightline":return Nt(this.map,t);case"terrainprofile":return Re(this.map,t)}}start(e,t){switch(this.map.isTooling=!0,e){case"angle":case"area":case"distance":case"height":case"pickup":return Xt(this.map).startInsertion(e,t);case"boxbuffer":case"tubebuffer":case"spherebuffer":return ei(this.map).start(e,t);case"terrainprofile":return Re(this.map).start();case"sightline":return Nt(this.map).start();case"viewshed":return gn(this.map).start(t);case"terrainutil":return sn(this.map);case"autorotate":return rn(this.map);case"navigationcontrol":return Ht(this.map);case"cutFill":return this.removeAllByTypes(["cutFill","flood","slopeAspect","routePlan"]),to(this.map).start(t);case"flood":return this.removeAllByTypes(["cutFill","flood","slopeAspect","routePlan"]),io(this.map).start(t);case"slopeAspect":return this.removeAllByTypes(["cutFill","flood","slopeAspect","routePlan"]),no(this.map).start(t);case"routePlan":return this.removeAllByTypes(["cutFill","flood","slopeAspect","routePlan"]),so(this.map)}}remove(e){(e instanceof He||e instanceof ot)&&this.map.scene.removeMeasurement(e),e instanceof Qt?this.map.scene.removeBufferAnalysis(e):e instanceof ze?this.map.scene.removePowerLine(e):e instanceof ji?this.map.scene.removeSightLine(e):e instanceof Wt?this.map.scene.removeTerrainProfile(e):e instanceof lt?this.map.scene.removeFlightLine(e):e instanceof pn&&this.map.scene.removeViewshed(e)}removeAllByTypes(e){e.forEach(t=>{this.remove(t)})}removeAllByType(e){switch(this.map.isTooling=!1,e){case"measure":this.map.scene.removeAllMeasurements();break;case"bufferanalysis":this.map.scene.removeAllBufferAnalysiss();break;case"sightline":this.map.scene.removeAllSightLines();break;case"terrainprofile":this.map.scene.removeAllTerrainProfiles();break;case"flightline":this.map.scene.removeAllFlightLines();break;case"powerline":this.map.scene.removeAllPowerLines();break;case"viewshed":this.map.scene.removeAllViewsheds();break;case"cutFill":a(this.map.toolManager)&&a(this.map.toolManager.cutFillVolumeAnalysis)&&this.map.toolManager.cutFillVolumeAnalysis.clear();break;case"flood":a(this.map.toolManager)&&a(this.map.toolManager.floodAnalysis)&&this.map.toolManager.floodAnalysis.clear();break;case"slopeAspect":a(this.map.toolManager)&&a(this.map.toolManager.slopeAspectAnalysis)&&this.map.toolManager.slopeAspectAnalysis.clear();break;case"routePlan":a(this.map.toolManager)&&a(this.map.toolManager.routePlan)&&this.map.toolManager.routePlan.clear();break}}}function ri(n){M(n);let e=n.toolManager;return a(e)&&e instanceof si||(e=new si(n),n.toolManager=e),e}function ro(n){let e=new te(n);return n.handler=e,e.leftClick(function(t){let i=n.pick3DTileFeature(t.position),s=n.pickPosition(t.position);i&&n.dispatchEvent({type:"3DTileFeature",obj:i,position:s})}),e}class oi extends ee{constructor(){super()}static checkType(e,t=!0){let i=e instanceof oi;if(t&&!i)throw new Error("当前对象不是继承自MapBase");return i}}let oo=new E;function ao(n,e){let t=Pn(),i={animation:!1,baseLayerPicker:!1,fullscreenButton:!1,geocoder:!1,homeButton:!1,infoBox:!1,selectionIndicator:!1,timeline:!1,navigationHelpButton:!1,showRenderLoopErrors:!0,contextOptions:{webgl:{preserveDrawingBuffer:!0}},sceneModePicker:!1,scene3DOnly:!0,creditContainer:"creditContainer",imageryProvider:e.imageryProvider||new Pi({url:t+"worldimage.jpg"}),terrainProvider:e.terrainProvider||null,shouldAnimate:!0};return or(i,e),new wi(n,i)}class Dn extends oi{constructor(e,t={}){super(),this.domElement=Ys(e),this._viewer=ao(this.domElement,t);let i=a(t)?t.sysConfig:void 0;sr(this,i),$s(this),Js(this),ur(this),this._viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(3),this.scene=new ar,this.canvas=this._viewer.canvas,this.toolManager=new si(this),this.handler=null}cameraInfo(){return lr(this)}goTo(e){hr(this,e)}flyTo(e,t){this._viewer.flyTo(e,t)}zoomTo(e,t){this._viewer.zoomTo(e,t)}set cursor(e){e?this.canvas.setAttribute("style",`cursor: ${e}`):this.canvas.setAttribute("style",`cursor: ${this.toolManager.cursor||"auto"}`)}canvasPos(e){return this._viewer.scene.cartesianToCanvasCoordinates(e,oo)}cameraAngle(e){return d.angleBetween(this._viewer.camera.position,e)}zoomToJiangSu(e={position:[]}){let t=938111.7527;a(e.height)?t=e.height:a(e.position)&&e.position.length===3&&(t=e.position[2]),this._viewer.camera.flyTo({destination:d.fromDegrees(e.position[0]||119.81376893935216,e.position[1]||33.08775466966692,t),duration:e.duration||0,orientation:{heading:T.toRadians(e.heading||360),pitch:T.toRadians(e.pitch||-90),roll:T.toRadians(e.roll||0)}})}open3DTileFeatureClick(){this.handler==null&&(this.handler=ro(this))}close3DTileFeatureClick(){this.handler!=null&&(Gi(),this.handler.destroy(),this.handler=null)}clear3DTileSilhouette(){Gi()}set globe(e){this._viewer.scene.globe.show=e}get globe(){return this._viewer.scene.globe.show}set depthTestAgainstTerrain(e){this._viewer.scene.globe.depthTestAgainstTerrain=e}get depthTestAgainstTerrain(){return this._viewer.scene.globe.depthTestAgainstTerrain}enableMove(e){this._viewer.scene.screenSpaceCameraController.enableRotate=e,this._viewer.scene.screenSpaceCameraController.enableZoom=e,this._viewer.scene.screenSpaceCameraController.enableTilt=e}destroy(){this._viewer.destroy()}}function R(){if(window.LIGLOBE_BASE_URL)return window.LIGLOBE_BASE_URL;if(document.currentScript&&document.currentScript.src){let n=new URL(document.currentScript.src+"/..").href;return n.slice(-1)==="/"&&(n=n.slice(0,-1)),n}return""}function Pn(){return R()+"/Assets/Textures/"}function lo(n,e){try{G(e)?n(...e):n()}catch(t){console.log(t)}}function M(n){if(n instanceof Dn)return!0;throw new Error("请设置实例化Map对象")}function dt(n,e){return a(n)?typeof n===e:!1}function ai(n){return dt(n,"string")}function re(n){return dt(n,"object")}function ho(n){return dt(n,"function")}function De(n){return dt(n,"number")}function G(n){return a(n)?n instanceof Array:!1}function co(n,e){let t=document.head||document.getElementsByTagName("head")[0]||document.documentElement,i,s,r;typeof n=="object"&&(s=n,n=void 0),r=s||{},n=n||r.url,e=e||r.success,i=document.createElement("script"),i.async=r.async||!1,i.type="text/javascript",r.charset&&(i.charset=r.charset),r.cache===!1&&(n=n+(/\?/.test(n)?"&":"?")+"_="+new Date().getTime()),i.src=n,t.insertBefore(i,t.firstChild),e&&(document.addEventListener?i.addEventListener("load",e,!1):i.onreadystatechange=function(){/loaded|complete/.test(i.readyState)&&(i.onreadystatechange=null,e())})}function ut(n,e){fetch(n).then(t=>t.json()).then(t=>{t?e(t):console.error("请求错误")})}function uo(n,e){if(!n||n===null)return"";let t=new Date(n),i=t.getFullYear()+"-",s=(t.getMonth()+1<10?"0"+(t.getMonth()+1):t.getMonth()+1)+"-",r=(t.getDate()<10?"0"+t.getDate():t.getDate())+" ",o=(t.getHours()<10?"0"+t.getHours():t.getHours())+":",l=(t.getMinutes()<10?"0"+t.getMinutes():t.getMinutes())+":",c=t.getSeconds()<10?"0"+t.getSeconds():t.getSeconds(),h="";switch(e){case"day":h=i+s+r;break;default:h=i+s+r+o+l+c}return h}function fo(n,e){if(!a(e)||!a(e.url))return;let t=new Xn;return t.load(e.url,e).then(function(s){if(n.dataSources.add(s),a(e.tag)&&(s.tag=e.tag),a(e.success)){let r=s.entities.values;for(let o=0;o<r.length;o++){let l=r[o];e.success(l)}}}).otherwise(function(s){console.error(s)}),t}function po(n,e){if(a(e.position)&&(e.position=d.fromDegrees(...e.position)),e.model&&e.model.heightReference){let i=e.model.heightReference;e.model.heightReference=i==1?yt.CLAMP_TO_GROUND:yt.RELATIVE_TO_GROUND}if(e.orientation){let i=T.PI*(e.orientation.heading||0),s=T.PI*(e.orientation.pitch||0),r=0,o=new Qn(i,s,r),l=le.headingPitchRollQuaternion(e.position,o);e.orientation=l}let t=n.entities.add(e);return a(e.tag)&&(t.tag=e.tag),t}function mo(n,e){let t=new es(e);return n.terrainProvider=t,t}function go(n,e){if(!a(e)||!a(e.url))return;let t=new us;return t.load(e.url,e).then(function(s){if(n.dataSources.add(s),a(e.tag)&&(s.tag=e.tag),a(e.success)){let r=s.entities.values;for(let o=0;o<r.length;o++){let l=r[o];e.success(l)}}}).otherwise(function(s){console.error(s)}),t}function vo(n,e,t){let i=n.scene.primitives.add(new pe(e));return t&&(i.modelMatrix=O.fromArray(t)),a(e.tag)&&(i.tag=e.tag),i}function xn(n,e,t){return e.rectangle&&(e.rectangle=ne.fromDegrees(...e.rectangle)),n.imageryLayers.addImageryProvider(new os(e),t)}function wo(n,e,t){return e.rectangle&&(e.rectangle=ne.fromDegrees(...e.rectangle)),n.imageryLayers.addImageryProvider(new as(e),t)}function yo(n,e,t){return e.rectangle&&(e.rectangle=ne.fromDegrees(...e.rectangle)),n.imageryLayers.addImageryProvider(new ls(e),t)}class ye{static get NONE(){}static get WMTS(){return"wmts"}static get WMS(){return"wms"}static get TMS(){return"tms"}static get URL(){return"url"}static support(e){switch(e){case ye.WMTS:case ye.WMS:case ye.URL:return!0;default:return!1}}}const V={token:"a78d45afd2fecea2e21d12e37330d0ab",subdomains:["t0","t1","t2","t3","t4"],tileMatrixSetID:"GoogleMapsCompatible",style:"default",minimumLevel:0,maximumLevel:15,imgLayer:"img",vecLayer:"vec",terLayer:"ter",imgLabel:"cia",terLabel:"cta",vecLabel:"cva",iboLayer:"ibo",template:"http://{s}.tianditu.gov.cn/[TDT_LAYER]_w/wmts?service=wmts&request=GetTile&version=1.0.0&LAYER=[TDT_LAYER]&tileMatrixSet=w&TileMatrix={TileMatrix}&TileRow={TileRow}&TileCol={TileCol}&style=default&format=tiles"};function Pe(n){let e={};return e.type=ye.WMTS,e.url=V.template.replace(/\[TDT_LAYER\]/g,n)+"&tk="+V.token,e.style=V.style,e.layer="tdt_"+n+"_layer",e.tileMatrixSetID=V.tileMatrixSetID,a(V.subdomains)&&(e.subdomains=V.subdomains),a(V.minimumLevel)&&(e.minimumLevel=V.minimumLevel),a(V.maximumLevel)&&(e.maximumLevel=V.maximumLevel),e}class Te{static setConfig(e){re(e)&&Object.entries(V).forEach(([t,i])=>{a(e[t])&&(V[t]=i)})}static get IMG_LAYER(){return Pe(p(V.imgLayer,"img"))}static get IMG_LABEL(){return Pe(p(V.imgLabel,"cia"))}static get VEC_LAYER(){return Pe(p(V.vecLayer,"vec"))}static get VEC_LABEL(){return Pe(p(V.vecLabel,"cva"))}static get TER_LAYER(){return Pe(p(V.terLayer,"ter"))}static get TER_LABEL(){return Pe(p(V.terLabel,"cta"))}static get IBO_LAYER(){return Pe(p(V.iboLayer,"ibo"))}}function Co(n="#FF3D00",e=32,t=32){return Y.marker(n,e,t)}let kn=Y.getColor;class _o{constructor(e,t){if(M(e),this.map=e,this.pointCollection=new B("CustomPointCollection_"+t.name||$()),!re(t))throw new Error("CustomDataCollection parameter error");let i=t.points,s=t.lines,r=t.polygons;a(t.tag)&&(this.pointCollection.tag=t.tag),this.pointCollection.entities.suspendEvents(),G(i)&&i.forEach(o=>{let c={position:he.getCartesian(o.position)};a(o.name)&&(c.name=name);let h=new Image;h.src=o.image||t.image||Co(),c.billboard={image:h,horizontalOrigin:Qe.CENTER,verticalOrigin:tt.BOTTOM,disableDepthTestDistance:Number.POSITIVE_INFINITY,distanceDisplayCondition:new k(0,1e7)},this.pointCollection.entities.add(c)}),G(s)&&s.forEach(o=>{let l={};if(a(o.name)&&(l.name=name),!G(o.positions))return;let c=[];o.positions.forEach(h=>{c.push(he.getCartesian(h))}),l.polyline={positions:c,material:kn(o.lineColor||t.lineColor||A.RED.toCssColorString()),width:o.lineWidth||t.lineWidth||2,distanceDisplayCondition:new k(0,1e7)},this.pointCollection.entities.add(l)}),G(r)&&r.forEach(o=>{let l={};if(a(o.name)&&(l.name=name),!G(o.positions))return;let c=[];o.positions.forEach(h=>{c.push(he.getCartesian(h))}),l.polygon={hierarchy:new et(c),distanceDisplayCondition:new k(0,1e7),material:kn(o.fillColor||t.fillColor||A.RED.toCssColorString()),classificationType:yi.BOTH},this.pointCollection.entities.add(l)}),this.pointCollection.entities.resumeEvents(),L(this.map).dataSources.add(this.pointCollection)}get show(){if(a(this.pointCollection))return this.pointCollection.show}set show(e){a(this.pointCollection)&&(this.pointCollection.show=e)}destroy(){let e=L(this.map);a(this.pointCollection)&&e.dataSources.remove(this.pointCollection),this.pointCollection=null}}let li={SYS_TDT_IMG:Te.IMG_LAYER,SYS_TDT_CIA:Te.IMG_LABEL,SYS_TDT_VEC:Te.VEC_LAYER,SYS_TDT_CVA:Te.VEC_LABEL,SYS_TDT_TER:Te.TER_LAYER,SYS_TDT_CTA:Te.TER_LABEL,SYS_TDT_IBO:Te.IBO_LAYER};li=Object.freeze(li);const hi=li;class ci{constructor(e){this.viewer=e,this.tilesets=[],this.opts=[],this.centers=[],this.handler=new ae(e.scene.canvas),this.timer=null;let t=new Me;e.scene.primitives.add(t),this.collection=t,this.params={distance:7e3,pitch:-.3}}addTileset(e){this.opts.push(e);let t=this.collection.add(new Li(e));return this.tilesets.push(t),t}interval(){}mouseMove(e){let t=this;this.handler.setInputAction(function(i){clearTimeout(t.timer),t.opts.length!==0&&(t.timer=setTimeout(()=>{let s=t.viewer.camera.pickEllipsoid(i.endPosition,t.viewer.scene.globe.ellipsoid);if(s){if(viewer.camera.pitch>t.params.pitch||LiGlobe_Core.Cartographic.fromCartesian(s).height>8e3)return;let o=t.viewer.scene.camera.computeViewRectangle(),l=(T.toDegrees(o.west)+T.toDegrees(o.east))/2,c=(T.toDegrees(o.south)+T.toDegrees(o.north))/2;t.tilesets.forEach((h,u)=>{d.distance(d.fromDegrees(l,c),d.fromDegrees(t.opts[u].position[0],t.opts[u].position[1]))>t.params.distance?t.tilesets[u]&&(t.collection.remove(h),h.destroy(),t.tilesets[u]=void 0):t.tilesets[u]||(t.tilesets[u]=t.collection.add(new Li(t.opts[u])))})}},1e3))},F.MOUSE_MOVE)}removeEvent(e){this.handler.removeInputAction(e)}removeTilesets(){this.collection.removeAll(),this.timer=null,this.tilesets.length=0,this.opts.length=0,this.centers.length=0}destroyHangler(){a(this.handler)&&(this.handler.destroy(),this.handler=null)}}function bo(n,e){var t=n.x-e.x,i=n.y-e.y;return t*t+i*i}function So(n,e,t){var i=e.x,s=e.y,r=t.x-i,o=t.y-s;if(r!==0||o!==0){var l=((n.x-i)*r+(n.y-s)*o)/(r*r+o*o);l>1?(i=t.x,s=t.y):l>0&&(i+=r*l,s+=o*l)}return r=n.x-i,o=n.y-s,r*r+o*o}function To(n,e){for(var t=n[0],i=[t],s,r=1,o=n.length;r<o;r++)s=n[r],bo(s,t)>e&&(i.push(s),t=s);return t!==s&&i.push(s),i}function di(n,e,t,i,s){for(var r=i,o,l=e+1;l<t;l++){var c=So(n[l],n[e],n[t]);c>r&&(o=l,r=c)}r>i&&(o-e>1&&di(n,e,o,i,s),s.push(n[o]),t-o>1&&di(n,o,t,i,s))}function Lo(n,e){var t=n.length-1,i=[n[0]];return di(n,0,t,e,i),i.push(n[t]),i}function ft(n,e,t){if(n.length<=2)return n;var i=e!==void 0?e*e:1;return n=t?n:To(n,i),n=Lo(n,i),n}function Eo(n){return n.replace(/#/g,"%23")}function In(n){if(!re(n)||!a(n.url))throw new Error("请指定数据路径");return n.url=Eo(n.url),!0}function Do(n,e){let t,i=n.imageryLayers._layers;if(a(e.index)){for(let s=0;s<i.length;s++)if(a(i[s].layerIndex))if(i[s].layerIndex<e.index)t=s+1;else{t=s;break}return a(t)||(t=i.length),t}else return i.length}class An extends ee{constructor(e){super(),M(e),this.map=e,this.layers={},this.towerTilesets=null,this.dom=null,this.primitiveCollection=null,this.viewer=e._viewer,xo(this),this.controlAreaList={}}configTDT(e){re(e)&&Te.setConfig(e)}setDEM(e){mo(L(this.map),e)}removeDEM(){let e=L(this.map);e.terrainProvider=new Cs}addTileSet(e){return In(e),a(e.modelMatrix)&&(e.modelMatrix=O.fromTranslation(d.fromArray(e.modelMatrix))),a(e.maximumScreenSpaceError)||(e.maximumScreenSpaceError=48),a(e.maximumMemoryUsage)||(e.maximumMemoryUsage=32),vo(L(this.map),e)}addTowerTilesets(e){In(e);let t;return this.towerTilesets instanceof ci?t=this.towerTilesets.addTileset(e):(this.towerTilesets=new ci(L(this.map)),t=this.towerTilesets.addTileset(e),setTimeout(()=>{this.towerTilesets.mouseMove()},1e3)),t}update3dtilesMaxtrix(e,t){let i=Q.fromRotationX(T.toRadians(t.rx)),s=Q.fromRotationY(T.toRadians(t.ry)),r=Q.fromRotationZ(T.toRadians(t.rz)),o=O.fromRotationTranslation(i),l=O.fromRotationTranslation(s),c=O.fromRotationTranslation(r),h=d.fromDegrees(t.tx,t.ty,t.tz),u=le.eastNorthUpToFixedFrame(h);O.multiply(u,o,u),O.multiply(u,l,u),O.multiply(u,c,u),e._root.transform=u}addDOM(e){let t=L(this.map);if(ai(e)){if(a(hi[e]))return this.addDOM(hi[e])}else if(re(e)&&a(e.type)){let i=Do(t,e),s;switch(e.type){case ye.WMTS:s=yo(t,e,i);break;case ye.WMS:s=wo(t,e,i);break;case ye.URL:s=xn(t,e,i);break;case ye.TMS:e.tilingScheme=new qn,s=xn(t,e,i);break}return a(s)&&(s.layerIndex=e.index,s.layerId=e.id),s}}addCustomData(e){if(re(e))return new _o(this.map,e)}addGeoJson(e){let t=L(this.map);return fo(t,e)}addCZML(e){let t=L(this.map);return go(t,e)}addGlTF(e){let t=L(this.map);return po(t,e)}removeLayer(e){return L(this.map).imageryLayers.remove(e)}removeLayerById(e){let t,s=L(this.map).imageryLayers._layers;for(let r=0;r<s;r++)a(s.layerId)&&s.layerId===e&&(t=s[r]);a(t)&&this.removeLayer(t)}removeData(e){return L(this.map).entities.remove(e)}removeDataCollection(e){return L(this.map).dataSources.remove(e)}remove3dTiles(e){L(this.map).scene.primitives.remove(e),e&&e.destroy()}removeTowerTilesets(){this.towerTilesets instanceof ci&&this.towerTilesets.removeTilesets()}bindDom(e,t){let i=document.getElementById(e),s=L(this.map);this.domFunc&&s.scene.preRender.removeEventListener(this.domFunc),this.domFunc=function(){let r=d.fromDegrees(t.x,t.y,t.z),o=_t.wgs84ToWindowCoordinates(s.scene,r);a(o)&&(i.style.top=o.y+"px",i.style.left=o.x+"px")},s.scene.preRender.addEventListener(this.domFunc)}bindDoms(e,t=985160){let i=L(this.map);this.domFunc&&i.scene.preRender.removeEventListener(this.domFunc),this.domFunc=function(){e.forEach(s=>{let r=document.getElementById(s.id);if(i.camera.positionCartographic.height<t){let o=d.fromDegrees(s.x,s.y,s.z);s.pixelOffset||(s.pixelOffset=[0,0]);let l=i.scene.cartesianToCanvasCoordinates(o,new E);a(l)&&(r.style.top=l.y+s.pixelOffset[1]+"px",r.style.left=l.x+s.pixelOffset[0]+"px",r.style.display="block")}else r.style.display="none"})},i.scene.preRender.addEventListener(this.domFunc)}unBindDom(){L(this.map).scene.preRender.removeEventListener(this.domFunc)}drawRegion(e,t={}){L(this.map),Po(this),a(this.regionPolylineDataSource)||(this.regionPolylineDataSource=new St,this.primitiveCollection.add(this.regionPolylineDataSource));let i=[];e.forEach(s=>{i.push(d.fromDegrees(s[0],s[1]))}),this.regionPolylineDataSource.add({positions:i,width:t.width||2,material:Z.fromType("Color",{color:S.fromCssColorString(t.color||"rgba(255,255,255,0.4)")})})}drawJiangsuRegion(e={}){let t=this;ut(R()+"/Assets/data/jiangsu_outline.json",i=>{i=i.geometries[3].coordinates,t.drawRegion(i,e)})}removeRegion(){let e=L(this.map);a(this.primitiveCollection)&&(this.regionPolylineDataSource.removeAll(),this.primitiveCollection.remove(this.regionPolylineDataSource),e.scene.primitives.remove(this.primitiveCollection),this.regionPolylineDataSource=null,this.primitiveCollection=null)}removeLineBuffer(){a(this.dataSource)&&(this.dataSource.entities.removeAll(),this.controlAreaList={})}drawLineBuffer(e,t,i=[]){a(this.controlAreaList[e])||(this.controlAreaList[e]=[]);let s=t.data,r=[];s.forEach(c=>{r.push([parseFloat(c.x),parseFloat(c.y)])});let o=turf.lineString(r);[{name:"1000m普查",color:"#67C23A",len:1.35,id:"1000",z:2,midPos:t.textPos1000,image:i[0]},{name:"500m防治",color:"#E6A23C",len:.65,id:"500",z:1,midPos:t.textPos500,image:i[1]},{name:"300m严控",color:"red",len:.3,id:"300",z:0,midPos:t.textPos300,image:i[2]}].forEach(c=>{let u=turf.buffer(o,c.len,{units:"kilometers",steps:1e3}).geometry.coordinates[0],f=[];u.forEach(v=>{f.push(d.fromDegrees(v[0],v[1],c.z))});let m=d.fromDegrees(c.midPos[0],c.midPos[1]),w=S.fromCssColorString(c.color),y=this.dataSource.entities.add({position:m,polyline:{positions:f,width:t.lineWidth||3,material:new U({dashLength:48,color:w}),distanceDisplayCondition:new k(0,1e5)},billboard:{image:c.image||R()+"/Assets/Images/img/nest.png",scale:t.imageScale||.2,horizontalOrigin:Cesium.HorizontalOrigin.TOP,pixelOffset:new E(0,0)},clickTag:"buffer",color:c.color});this.controlAreaList[e].push(y)})}bufferLineAlertUp(e,t=1e3){if(a(this.controlAreaList[e]))for(let i=0;i<this.controlAreaList[e].length;i+=3){let s=this.controlAreaList[e][i],r=this.controlAreaList[e][i+1],o=this.controlAreaList[e][i+2];s.polyline.material=new U({dashLength:48,color:Ne(s.color)}),s.billboard.color=Ne(),setTimeout(()=>{s.polyline.material=new U({dashLength:48,color:S.fromCssColorString(s.color)}),s.billboard.color=void 0,setTimeout(()=>{r.polyline.material=new U({dashLength:48,color:Ne(r.color)}),r.billboard.color=Ne(),setTimeout(()=>{setTimeout(()=>{r.polyline.material=new U({dashLength:48,color:S.fromCssColorString(r.color)}),r.billboard.color=void 0,setTimeout(()=>{o.polyline.material=new U({dashLength:48,color:Ne(o.color)}),o.billboard.color=Ne(),setTimeout(()=>{o.polyline.material=new U({dashLength:48,color:S.fromCssColorString(o.color)}),o.billboard.color=void 0},t)},500)},500)},t)},500)},t)}}}function Ne(n="white"){let e=.5,t=!0;return new W(function(){return t?(e=e-.004,e<=0&&(t=!1)):(e=e+.004,e>=.5&&(t=!0)),S.fromCssColorString(n).withAlpha(e)},!1)}function Po(n){a(n.primitiveCollection)||(n.primitiveCollection=new Me,n.map._viewer.scene.primitives.add(n.primitiveCollection))}function xo(n){a(n.dataSource)||(n.dataSource=new B,n.map._viewer.dataSources.add(n.dataSource))}function ko(n){M(n);let e=n.dataManager;return a(e)&&e instanceof An||(e=new An(n),n.dataManager=e),e}class xe{constructor(){}static enter(e){if(xe.isFullScreen)return;let t=L(e);mt.requestFullscreen(t.container)}static exit(){xe.isFullScreen&&mt.exitFullscreen()}static get isFullScreen(){return!!mt.fullscreen}static switchStatus(e){xe.isFullScreen?xe.exit():xe.enter(e)}}function Io(n){var e=/\.{1}[a-z]{1,}$/;return e.exec(n)!==null?n.slice(0,e.exec(n).index):n}class Ao{constructor(){}static getScene(e,t){M(e);let i=p(t,$());i=Io(i);let s=de(e),r=document.createElement("a");if(s.toBlob)s.toBlob(function(o){r.href=URL.createObjectURL(o),r.download=i+".png",document.body.appendChild(r),r.click(),document.body.removeChild(r)});else{let o="image/png";r.href=s.toDataURL(o,.7),r.dataset.downloadurl=[o,r.download,r.href].join(":"),r.download=i+".png",document.body.appendChild(r),r.click(),document.body.removeChild(r)}}static getSceneThumbnail(e){return M(e),de(e).toDataURL("image/png",.3)}}class Mn{constructor(e){M(e),this.map=e;let t=this;this.powerLines=[],this.pd=30,this.distance=2e4,this.container=ge.createElement("div",{className:"powerline-bubble",container:e.domElement}),e.addEventListener("update",function(i){t._update(t,i.options)}),e.scene.addEventListener("powerLine_added",function(i){const s=t.getPowerLineById(i.powerLine.id);a(s)&&s.destroy(),t.container.appendChild(i.powerLine.container),t.powerLines.push(i.powerLine)}),e.scene.addEventListener("powerLine_removed",function(i){let s=t.powerLines.indexOf(i.powerLine);s>-1&&t.powerLines.splice(s,1)[0].destroy()})}_update(e,t){this.powerLines.forEach(i=>{a(i)&&i.active&&i.update(e,t)})}add(e){let t;return e instanceof ze?t=e:t=new ze(this.map,e),this.map.scene.addPowerLine(t),t}remove(e){this.map.scene.removePowerLine(e)}getPowerLineById(e){const t=this.powerLines;for(let i=0;i<t.length;i++){const s=t[i];if(s.id===e)return s}}}function Mo(n){M(n);let e=n.powerLineManager;return a(e)&&e instanceof Mn||(e=new Mn(n),n.powerLineManager=e),e}class Fo{constructor(e,t,i){if(!t)return null;i||(i={}),this._cesium=e,this._options=i,this._id=I._getID(),this._options.gradient=this._options.gradient?this._options.gradient:I.defaults.gradient,this._options.maxOpacity=this._options.maxOpacity?this._options.maxOpacity:I.defaults.maxOpacity,this._options.minOpacity=this._options.minOpacity?this._options.minOpacity:I.defaults.minOpacity,this._options.blur=this._options.blur?this._options.blur:I.defaults.blur,this._mbounds=I.wgs84ToMercatorBB(t),this._setWidthAndHeight(this._mbounds),this._options.radius=Math.round(this._options.radius?this._options.radius:this.width>this.height?this.width/I.defaults.radiusFactor:this.height/I.defaults.radiusFactor),this._spacing=this._options.radius*I.defaults.spacingFactor,this._xoffset=this._mbounds.west,this._yoffset=this._mbounds.south,this.width=Math.round(this.width+this._spacing*2),this.height=Math.round(this.height+this._spacing*2),this._mbounds.west-=this._spacing*this._factor,this._mbounds.east+=this._spacing*this._factor,this._mbounds.south-=this._spacing*this._factor,this._mbounds.north+=this._spacing*this._factor,this.bounds=I.mercatorToWgs84BB(this._mbounds),this._rectangle=ne.fromDegrees(this.bounds.west,this.bounds.south,this.bounds.east,this.bounds.north),this._container=I._getContainer(this.width,this.height,this._id),this._options.container=this._container,this._heatmap=h337.create(this._options),this._container.children[0].setAttribute("id",this._id+"-hm")}wgs84PointToHeatmapPoint(e){return this.mercatorPointToHeatmapPoint(I.wgs84ToMercator(e))}mercatorPointToHeatmapPoint(e){let t={};return t.x=Math.round((e.x-this._xoffset)/this._factor+this._spacing),t.y=Math.round((e.y-this._yoffset)/this._factor+this._spacing),t.y=this.height-t.y,t}_setWidthAndHeight(e){this.width=e.east>0&&e.west<0?e.east+Math.abs(e.west):Math.abs(e.east-e.west),this.height=e.north>0&&e.south<0?e.north+Math.abs(e.south):Math.abs(e.north-e.south),this._factor=1,this.width>this.height&&this.width>I.defaults.maxCanvasSize?(this._factor=this.width/I.defaults.maxCanvasSize,this.height/this._factor<I.defaults.minCanvasSize&&(this._factor=this.height/I.defaults.minCanvasSize)):this.height>this.width&&this.height>I.defaults.maxCanvasSize?(this._factor=this.height/I.defaults.maxCanvasSize,this.width/this._factor<I.defaults.minCanvasSize&&(this._factor=this.width/I.defaults.minCanvasSize)):this.width<this.height&&this.width<I.defaults.minCanvasSize?(this._factor=this.width/I.defaults.minCanvasSize,this.height/this._factor>I.defaults.maxCanvasSize&&(this._factor=this.height/I.defaults.maxCanvasSize)):this.height<this.width&&this.height<I.defaults.minCanvasSize&&(this._factor=this.height/I.defaults.minCanvasSize,this.width/this._factor>I.defaults.maxCanvasSize&&(this._factor=this.width/I.defaults.maxCanvasSize)),this.width=this.width/this._factor,this.height=this.height/this._factor}setData(e,t,i){return i&&i.length>0&&e!==null&&e!==!1&&t!==null&&t!==!1?(this._heatmap.setData({min:e,max:t,data:i}),this.updateLayer(),!0):!1}setWGS84Data(e,t,i){if(i&&i.length>0&&e!==null&&e!==!1&&t!==null&&t!==!1){let s=[];for(let r=0;r<i.length;r++){let o=i[r],l=this.wgs84PointToHeatmapPoint(o);(o.value||o.value===0)&&(l.value=o.value),s.push(l)}return this.setData(e,t,s)}return!1}show(e){this._layer&&(this._layer.show=e)}updateLayer(){if(I.defaults.useEntitiesIfAvailable&&this._cesium.entities){this._layer&&this._cesium.entities.remove(this._layer);let e=new Si({image:this._heatmap._renderer.canvas});e.transparent=!0,this._layer=this._cesium.entities.add({show:!0,rectangle:{coordinates:this._rectangle,material:e}})}else this._layer&&this._cesium.scene.imageryLayers.remove(this._layer),this._layer=this._cesium.scene.imageryLayers.addImageryProvider(I._getImageryProvider(this))}}const I={defaults:{useEntitiesIfAvailable:!0,minCanvasSize:700,maxCanvasSize:2e3,radiusFactor:600,spacingFactor:22,maxOpacity:.8,minOpacity:.1,blur:.85,gradient:{".05":"yellow",".2":"orange",".95":"red"}}};I.create=function(n,e,t){var i=new Fo(n,e,t);return i},I._getContainer=function(n,e,t){var i=document.createElement("div");return t&&i.setAttribute("id",t),i.setAttribute("style","width: "+n+"px; height: "+e+"px; margin: 0px; display: none;"),document.body.appendChild(i),i},I._getImageryProvider=function(n){var e=n._heatmap.getDataURL(),t=new Pi({url:e,rectangle:n._rectangle});return t._tilingScheme=new hs({rectangleSouthwestInMeters:new E(n._mbounds.west,n._mbounds.south),rectangleNortheastInMeters:new E(n._mbounds.east,n._mbounds.north)}),t},I._getID=function(n){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<(n||8);i++)e+=t.charAt(Math.floor(Math.random()*t.length));return e};var We=new xi;I.wgs84ToMercator=function(n){var e=We.project(q.fromDegrees(n.x,n.y));return{x:e.x,y:e.y}},I.wgs84ToMercatorBB=function(n){var e=We.project(q.fromDegrees(n.west,n.south)),t=We.project(q.fromDegrees(n.east,n.north));return{north:t.y,east:t.x,south:e.y,west:e.x}},I.mercatorToWgs84=function(n){var e=We.unproject(new d(n.x,n.y));return{x:e.longitude,y:e.latitude}},I.mercatorToWgs84BB=function(n){var e=We.unproject(new d(n.west,n.south)),t=We.unproject(new d(n.east,n.north));return{north:this.rad2deg(t.latitude),east:this.rad2deg(t.longitude),south:this.rad2deg(e.latitude),west:this.rad2deg(e.longitude)}},I.deg2rad=function(n){var e=n*(Math.PI/180);return e},I.rad2deg=function(n){var e=n/(Math.PI/180);return e};function pt(n){return new Promise(e=>{setTimeout(()=>{e()},n)})}function ke(n){return n.replace(/#/g,"%23")}function Oo(n,e,t="json"){return new Promise((i,s)=>{fetch(n,e).then(function(r){let o="";return t==="json"?o=r.json():o=r.text(),o}).then(r=>{t==="json"&&r.code==404?s("请求异常:"+r.msg):i(r)}).catch(function(r){s("请求异常:"+r)})})}class Ro{constructor(e){this.map=e,this.viewer=e._viewer,this.isScreenCapture=!1}startScreenCapture(e,t){this.opt=e;let i=this.opt.dangers,s=[];for(let r=0;r<i.length&&i[r].pathInfos[1];r++)s.push(Oo(ke(""+i[r].pathInfos[1])));return new Promise((r,o)=>{Promise.all(s).then(l=>{this.isScreenCapture=!0,this.start(t),r(l)}).catch(l=>{o(l)})})}async start(e,t=1){if(!this.isScreenCapture)return;let i=this.opt.dangers;for(let s=0;s<i.length;s++){let r=i[s].basicInfo,o=await this.opt.addPointCloudTileSet(ke(i[s].pathInfos[1]),!0,0);i[s].pathInfos[2]&&await this.opt.addPointCloudTileSet(ke(i[s].pathInfos[2]),!1,1),i[s].pathInfos[3]&&await this.opt.addPointCloudTileSet(ke(i[s].pathInfos[3]),!1,2),await this.viewer.flyTo(o,{duration:t}),await pt(t*1e3);let l=await this.opt.addMeasureObj(this.opt.dangers[s]);a(e)&&e.onlyShowDangerById(r.defectId);try{await this.viewer.flyTo(l,{offset:new Ve(0,-.1,100),duration:t})}catch{}this.viewer.scene.canvas.toBlob(h=>{this.opt.upload(r.defectId,h,{index:s+1,total:i.length}),s===i.length-1&&a(e)&&e.showDangers()}),await pt(t*1e3)}}async singleScreenCapture(e,t){let i=this.viewer.scene.primitives;if(!this.map.toolManager&&!this.map.toolManager.measuringTool)throw new Error("先实例化toolManager.measuringTool");let s=this.map.toolManager.measuringTool;this.clearSingleScreenCapture();let r=e.basicInfo;a(t)&&t.onlyShowDangerById(r.defectId),this.pointCloudTileSet1=i.add(new pe({url:ke(e.pathInfos[1])})),this.pointCloudTileSet1.style=new wt({pointSize:2}),e.pathInfos[2]&&(this.pointCloudTileSet2=i.add(new pe({url:ke(e.pathInfos[2])})),this.pointCloudTileSet2.style=new wt({pointSize:5,color:'color("#ff00ff")'})),e.pathInfos[3]&&(this.pointCloudTileSet3=i.add(new pe({url:ke(e.pathInfos[3])})),this.pointCloudTileSet3.style=new wt({pointSize:5,color:'color("red")'})),this.measureObj=s.triangulation({start:[r.xD,r.yD,r.lineZ-r.vDistance],end:[r.lineX,r.lineY,r.lineZ],labelOpt:{margin:20},lineColor:"red",textInfo:{sd:r.distance,vd:r.vDistance,hd:r.hDistance}}),await this.viewer.zoomTo(this.pointCloudTileSet1),await pt(1e3),await this.viewer.zoomTo(this.measureObj.collection,new Ve(0,-.1,100));let o=this;await pt(e.sleepTime||1e3);let l=this.viewer.scene.canvas;this.pointCloudTileSet1.readyPromise.then(()=>{l.toBlob(c=>{e.callback(c),a(t)&&t.showDangers(),o.clearSingleScreenCapture()})})}clearSingleScreenCapture(){this.pointCloudTileSet1&&(this.viewer.scene.primitives.remove(this.pointCloudTileSet1),this.pointCloudTileSet1=void 0),this.pointCloudTileSet2&&(this.viewer.scene.primitives.remove(this.pointCloudTileSet2),this.pointCloudTileSet2=void 0),this.pointCloudTileSet3&&(this.viewer.scene.primitives.remove(this.pointCloudTileSet3),this.pointCloudTileSet3=void 0),this.measureObj&&(this.map.scene.removeMeasurement(this.measureObj),this.measureObj=void 0)}}class Ho{constructor(e,t){this.viewer=e,this.opt=t,this.entities=[];const i={positions:LiGlobe_Core.Cartesian3.fromDegreesArrayHeights([...t.left,t.right[0],t.right[1],t.left[2]]),material:new LiGlobe_Core.PolylineDashMaterialProperty({color:LiGlobe_Core.Color.RED})},s={positions:LiGlobe_Core.Cartesian3.fromDegreesArrayHeights([t.left[0],t.left[1],t.lowest[2],t.left[0],t.left[1],t.left[2]]),material:LiGlobe_Core.Color.YELLOW},r={positions:LiGlobe_Core.Cartesian3.fromDegreesArrayHeights([...t.right,t.left[0],t.left[1],t.right[2]]),material:new LiGlobe_Core.PolylineDashMaterialProperty({color:LiGlobe_Core.Color.RED})},o={positions:LiGlobe_Core.Cartesian3.fromDegreesArrayHeights([t.right[0],t.right[1],t.lowest[2],t.right[0],t.right[1],t.right[2]]),material:LiGlobe_Core.Color.YELLOW},l={positions:LiGlobe_Core.Cartesian3.fromDegreesArrayHeights([t.right[0],t.right[1],t.lowest[2],t.left[0],t.left[1],t.lowest[2]]),material:new LiGlobe_Core.PolylineDashMaterialProperty({color:LiGlobe_Core.Color.RED})};function c(y,v){return Math.round(y*Math.pow(10,v))/Math.pow(10,v)}let h=new LiGlobe_Core.Entity({polyline:i}),u=new LiGlobe_Core.Entity({polyline:s,position:LiGlobe_Core.Cartesian3.fromDegrees(t.left[0],t.left[1],(t.left[2]+t.lowest[2])/2),label:{text:c(t.left[2]-t.lowest[2],2)+"m",fillColor:LiGlobe_Core.Color.YELLOW,distanceDisplayCondition:new LiGlobe_Core.DistanceDisplayCondition(0,100)}}),f=new LiGlobe_Core.Entity({polyline:r}),m=new LiGlobe_Core.Entity({polyline:o,position:LiGlobe_Core.Cartesian3.fromDegrees(t.right[0],t.right[1],(t.right[2]+t.lowest[2])/2),label:{text:c(t.right[2]-t.lowest[2],2)+"m",fillColor:LiGlobe_Core.Color.YELLOW,distanceDisplayCondition:new LiGlobe_Core.DistanceDisplayCondition(0,100)}}),w=new LiGlobe_Core.Entity({polyline:l});this.entities.push(h),this.entities.push(u),this.entities.push(f),this.entities.push(m),this.entities.push(w)}add(){if(!this.viewer.entities.contains(this.entities[0]))for(var e=0;e<this.entities.length;e++)this.viewer.entities.add(this.entities[e])}remove(){if(this.viewer.entities.contains(this.entities[0]))for(var e=0;e<this.entities.length;e++)this.viewer.entities.remove(this.entities[e])}flyTo(){this.viewer.entities.contains(this.entities[0])&&this.viewer.flyTo(this.entities[0])}}function Fn(n,e){let t=new Ae;n.forEach(s=>{let r=b.addSeconds(b.fromDate(new Date(s.createTime)),e.stayTime,new b);t.addSample(r,d.fromDegrees(s.jd,s.wd,s.alt))});let i=b.addSeconds(b.fromDate(new Date(n[n.length-1].createTime)),e.timeout,new b);return t.addSample(i,d.fromDegrees(n[n.length-1].jd,n[n.length-1].wd,n[n.length-1].alt)),t}function On(n,e){n.planeList[e.deviceCode]={data:[e],taskId:e.taskId,deviceCode:e.deviceCode};let t=Fn(n.planeList[e.deviceCode].data,n.opt),i=n.dataSource.entities.add({id:e.deviceCode,position:t,model:new vs({uri:R()+"/Assets/models/uav/dji.gltf",scale:.2,minimumPixelSize:30}),type:"real-time-uav",info:e});n.opt.path&&!n.opt.path.default?i.path={leadTime:0,trailTime:n.opt.pathTime,width:5,resolution:60,material:new Ai({glowPower:.2,taperPower:.8,color:n.opt.lineColor})}:i.path=n.opt.path}function zo(n){return n.pathTime||(n.pathTime=10),n.timeout||(n.timeout=60),n.stayTime||(n.stayTime=3),n.lineColor||(n.lineColor=A.YELLOW),n.path||(n.path={default:!1}),n}class Bo{constructor(e,t={}){M(e),t=zo(t),this.map=e,this.viewer=this.map._viewer;let i=this.viewer;this.planeList={},this.dataSource=new B,this.viewer.dataSources.add(this.dataSource),this.interval=null,this.opt=t,this.handler=new ae(this.viewer.scene.canvas),this.init(t.timeout);let s=t.defaultView||{position:[119.02055955096634,33.11658003273969,821319.9589410495]};e.goTo(s);let r=this;this.handler.setInputAction(function(o){let l=i.scene.pick(o.position);a(l)&&l.id&&l.id.type==="real-time-uav"?(r.map.dispatchEvent({type:"real-time-uav",data:{id:l.id.id}}),t.clickEvent&&t.clickEvent(l.id.info)):r.map._viewer.trackedEntity=void 0},F.LEFT_CLICK),this.isCurrentTimeInit=!0}init(e){let t=this.viewer;t.clock.multiplier=1,t.clock.shouldAnimate=!0,this.interval=setInterval(()=>{for(let i in this.planeList){let s=this.planeList[i],r=b.toDate(this.viewer.clock.currentTime).getTime(),o=new Date(s.data[s.data.length-1].createTime).getTime();r-o>e*1e3&&(this.dataSource.entities.removeById(i),delete this.planeList[i])}},1e3*e)}start(e){let t=this.viewer;if(e instanceof Array)if(!this.isCurrentTimeInit)e.forEach((i,s)=>{let r=this.planeList[i.deviceCode];if(r){let o=r.data[r.data.length-1];if(o.jd===i.jd&&o.wd===i.wd)return;r.data.push(i);let l=this.dataSource.entities.getById(i.deviceCode);l.position=Fn(r.data,this.opt),l.info=i}else On(this,i)});else{let i;e.forEach(s=>{i?new Date(s.createTime).getTime()<new Date(i).getTime()&&(i=s.createTime):i=s.createTime,On(this,s)}),t.clock.currentTime=b.addSeconds(b.fromDate(new Date(i)),-2,new b),this.isCurrentTimeInit=!1}else throw new Error("传递数据类型有误！应是数组")}removeById(e){debugger;this.dataSource.entities.getById(e)&&(this.dataSource.entities.removeById(e),delete this.planeList[e])}destroy(){this.viewer.dataSources.remove(this.dataSource),this.planeList={},a(this.handler)&&this.handler.destroy(),clearInterval(this.interval)}flyTo(e,t={}){let i=this.dataSource.entities.getById(e);a(i)&&this.viewer.flyTo(i,t={})}zoomTo(e){let t=this.dataSource.entities.getById(e);a(t)&&this.viewer.zoomTo(t)}trackOn(e,t=[-50,0,50]){let i=this.dataSource.entities.getById(e);a(i)&&(this.map._viewer.trackedEntity=i,i.viewFrom=new d(...t))}trackOff(){this.map._viewer.trackedEntity=void 0}getRealTimeData(){return this.planeList}}function No(n,e){let t=new Ae,i=b.fromDate(new Date),s=0;for(let r=0;r<n.length-1;r++){let o,l=d.fromDegrees(n[r+1].coordinates[0],n[r+1].coordinates[1],n[r+1].coordinates[2]);if(r>0){let h=d.distance(d.fromDegrees(n[r].coordinates[0],n[r].coordinates[1],n[r].coordinates[2]),d.fromDegrees(n[r+1].coordinates[0],n[r+1].coordinates[1],n[r+1].coordinates[2]));s+=h/e.speed,o=b.addSeconds(i,s,new b),t.addSample(o,l)}else o=b.addSeconds(i,0,new b),t.addSample(o,d.fromDegrees(n[r].coordinates[0],n[r].coordinates[1],n[r+1].coordinates[2]));s+=e.stayTime;let c=b.addSeconds(i,s,new b);t.addSample(c,l)}return t}class Wo{constructor(e,t={}){this.map=e,this.viewer=e._viewer,this.dataSource=new B,this.viewer.dataSources.add(this.dataSource),this.interval=null,this.opt=t,this.opt.speed||(this.opt.speed=10),this.opt.stayTime||(this.opt.stayTime=1),this.entity=void 0}start(e){e||(e=Vo),this.dataSource.entities.removeAll(),this.viewer.clock.multiplier=1,this.viewer.clock.shouldAnimate=!0;let t=e.geometries;if(t&&t.length>0){this.viewer.clock.currentTime=b.addSeconds(b.fromDate(new Date),-2,new b);let i=No(t,this.opt),s=this.dataSource.entities.add({id:e.ticketObjId,position:i,model:{uri:R()+"/Assets/models/uav/dji.gltf"},type:"histroy-time"});s.path={leadTime:0,trailTime:6e5,width:5,resolution:60,material:new Ai({glowPower:.2,taperPower:.8,color:S.YELLOW})},this.entity=s,this.viewer.camera.setView({destination:d.fromDegrees(t[0].coordinates[0],t[0].coordinates[1],t[0].coordinates[2]+50)})}}pause(){this.viewer.clock.shouldAnimate=!1}continue(){this.viewer.clock.shouldAnimate=!0}setMultiplier(e){this.viewer.clock.multiplier=e}trackOn(e=[-50,0,50]){a(this.entity)&&(this.viewer.trackedEntity=this.entity)}trackOff(){this.viewer.trackedEntity=void 0}remove(){this.dataSource.entities.removeAll(),this.entity=void 0,this.trackOff()}destroy(){this.viewer.dataSources.remove(this.dataSource),this.dataSource=void 0,this.entity=void 0}}let Vo={type:"GeometryCollection",geometries:[{type:"Point",coordinates:[118.642112674847,31.9478991638088,36]},{type:"Point",coordinates:[118.642110971584,31.947901683257,151.5]},{type:"Point",coordinates:[118.642112196046,31.9479008369072,151.399993896484]},{type:"Point",coordinates:[118.633281662415,31.9442890327973,152.199996948242]},{type:"Point",coordinates:[118.633087052098,31.9441300741974,152.199996948242]},{type:"Point",coordinates:[118.633086995104,31.9441299105335,108.199996948242]},{type:"Point",coordinates:[118.633328023694,31.9439312704712,108.199996948242]},{type:"Point",coordinates:[118.635023790791,31.9424470482708,108.099998474121]},{type:"Point",coordinates:[118.63664627242,31.9410447961037,108.199996948242]},{type:"Point",coordinates:[118.638357873447,31.9395473486687,108.199996948242]},{type:"Point",coordinates:[118.638259563322,31.9394513907337,108.199996948242]},{type:"Point",coordinates:[118.638513388282,31.939212410988,108.199996948242]},{type:"Point",coordinates:[118.638536115472,31.9392283842388,40.7999992370605]},{type:"Point",coordinates:[118.638534445808,31.9392275267176,40.7999992370605]},{type:"Point",coordinates:[118.638533987038,31.9392279160015,39.4000015258789]},{type:"Point",coordinates:[118.638534494592,31.9392285405006,38]},{type:"Point",coordinates:[118.638534254869,31.9392257436876,67.9000015258789]},{type:"Point",coordinates:[118.638617575191,31.9393067454443,68]},{type:"Point",coordinates:[118.638660360948,31.9392719950023,68]},{type:"Point",coordinates:[118.639574094353,31.938497756469,73.3000030517578]}]};class Uo{constructor(e,t,i){this.viewer=e,t.clustering.enabled=!0,t.clustering.pixelRange=i.pixelRange||50,t.clustering.minimumClusterSize=i.minimumClusterSize||1,this.dataSource=t}cluster(e){this.dataSource.clustering.clusterEvent.addEventListener(function(t,i){i.label.show=!0,i.billboard.show=!0;let s=t.length,r=new E(-15,-13);s>999?s="999+":s>=0&&s<10?r=new E(-2,-13):s>=10&&s<100?r=new E(-6,-13):s>=100&&s<1e3&&(r=new E(-10,-13)),i.billboard.disableDepthTestDistance=Number.POSITIVE_INFINITY,i.label.text=""+s,i.label.font="bolder 12px sans-serif",i.label.fill_Color=A.WHITE,i.label.pixelOffset=r,i.label.disableDepthTestDistance=Number.POSITIVE_INFINITY,i.billboard.image=e,i.billboard.scale=.5})}}class Go{constructor(e,t){this.map=e,this.viewer=e._viewer,this.dataSources={},this.typeImageList={},this.clusterImageList={},this.statusImageList={},this.screenSpaceEvent=null,this.clustering=!1,this.opt=t,t.cluster&&t.cluster.showHeight?this.clusteringHeight=t.cluster.showHeight:this.clusteringHeight=3e4}addDangers(e,t){if(t=this.opt,t.dangers&&t.dangers.images&&t.dangers.images.default)this.typeImageList=t.dangers.images.type,this.statusImageList=t.dangers.images.status;else throw new Error("请传入默认图片");t.cluster&&t.cluster.images&&(this.clusterImageList=t.cluster.images);let i=t.dangers.images.default;if(t.dangers&&a(e)&&e.features.forEach(s=>{this.statusImageList[s.properties.status]?i=this.statusImageList[s.properties.status]:i=this.typeImageList[s.properties.type]||t.dangers.images.default;let r={image:i,lon:s.geometry.coordinates[0],lat:s.geometry.coordinates[1],altitude:s.geometry.coordinates[2],width:t.dangers.images.width,height:t.dangers.images.height,scale:t.dangers.images.scale,properties:s.properties};if(this.dataSources[s.properties.type])Rn(this.dataSources[s.properties.type],r);else{let o=new B;this.viewer.dataSources.add(o),this.dataSources[s.properties.type]=o,Rn(o,r)}}),t.cluster){let s={pixelRange:t.cluster.pixelRange,minimumClusterSize:t.cluster.minimumClusterSize};Object.entries(this.dataSources).forEach(o=>{new Uo(this.viewer,o[1],s).cluster(this.clusterImageList[o[0]],s)});let r=this;this.screenSpaceEvent===null&&(this.screenSpaceEvent=()=>{r.viewer.camera.positionCartographic.height>r.clusteringHeight?r.showCluster(!0):r.showCluster(!1)},this.viewer.camera.changed.addEventListener(this.screenSpaceEvent)),this.clustering=!0}}showCluster(e=!0){if(this.clustering)if(e)for(let t in this.dataSources)this.dataSources[t].clustering.enabled=!0;else for(let t in this.dataSources)this.dataSources[t].clustering.enabled=!1}removeAll(){Object.entries(this.dataSources).forEach((e,t)=>{this.viewer.dataSources.remove(e[1])}),this.dataSources={},this.clusterImageList={},this.statusImageList={},this.clusterImageList={},this.screenSpaceEvent!=null&&(this.viewer.camera.changed.removeEventListener(this.screenSpaceEvent),this.screenSpaceEvent=null)}onlyShowDangerById(e){for(let t in this.dataSources)this.dataSources[t].entities._entities._array.forEach(s=>{s.id!=e?s.show=!1:s.show=!0})}showDangers(){for(let e in this.dataSources)this.dataSources[e].entities._entities._array.forEach(i=>{i.show||(i.show=!0)})}}function Rn(n,e){n.entities.add({id:e.properties.defectId,position:d.fromDegrees(e.lon,e.lat,e.altitude||10),billboard:{image:e.image,horizontalOrigin:Qe.CENTER,verticalOrigin:tt.BOTTOM,disableDepthTestDistance:Number.POSITIVE_INFINITY,scale:e.scale||.8,width:e.width||32,height:e.height||32},tag:"tower",properties:e.properties,zIndex:0})}class jo{constructor(e,t){this.map=e,this.opt=t,this.viewer=this.map._viewer,this.typeImageList={},this.statusImageList={},this.primitiveCollection=new Me,this.viewer.scene.primitives.add(this.primitiveCollection),this.dangerImageCollection=new Le,this.primitiveCollection.add(this.dangerImageCollection)}initDangers(e){let t=this;a(this.inputHandler)||(this.inputHandler=new te(this.map),this.inputHandler.leftClick(i=>{const s=t.viewer.scene.pick(i.position);s&&s&&s.primitive&&s.primitive.clickTag==="danger_image"&&a(e.dangerClickEvent)&&e.dangerClickEvent({clickTag:"danger_image",properties:s.primitive.properties})}))}showArea(e){a(this.powerLine)&&(this.powerLine.active=e)}addDangers(e){let t=this.opt;if(t.dangers&&t.dangers.images&&t.dangers.images.default)this.typeImageList=t.dangers.images.type,this.statusImageList=t.dangers.images.status;else throw new Error("请传入默认图片");let i=t.dangers.images.default;t.dangers&&a(e)&&e.forEach(s=>{this.statusImageList[s.status]?i=this.statusImageList[s.status]:i=this.typeImageList[s.defectLevel]||t.dangers.images.default;let r=this.dangerImageCollection.add({image:i,position:d.fromDegrees(s.lineX,s.lineY,s.lineZ),width:t.dangers.images.width,height:t.dangers.images.height,scale:t.dangers.images.scale});r.clickTag="danger_image",r.properties=s})}showDangers(e=!0){this.dangerImageCollection._billboards.forEach(t=>{t.show=e})}showByParams(e={}){let t=!0;a(e.defectId)&&e.defectId.length>0?this.dangerImageCollection._billboards.forEach(i=>{for(let s=0;s<e.defectId.length;s++)i.properties.defectId===e.defectId[s]?i.show=t:i.show=!t}):this.dangerImageCollection._billboards.forEach(i=>{if(a(e.status)){let s=!1;e.status.indexOf(i.properties.status)!=-1&&(s=!0),s||e.defectLevel.indexOf(i.properties.defectLevel)!=-1?i.show=t:i.show=!t}else e.defectLevel.indexOf(i.properties.defectLevel)!=-1?i.show=t:i.show=!t})}showByParam(e,t,i){this.dangerImageCollection._billboards.forEach(s=>{s.properties[e]===t&&(s.show=i)})}onlyShowDangerById(e){this.dangerImageCollection._billboards.forEach(t=>{t.properties.defectId===e?t.show=!0:t.show=!1})}removeDangers(){this.dangerImageCollection.removeAll()}removeAll(){this.removeDangers()}destroy(){this.removeAll(),this.viewer.scene.primitives.remove(this.primitiveCollection),a(this.inputHandler)&&(this.inputHandler.destroy(),this.inputHandler=void 0)}}Z.LineFlowMaterialProperty="LineFlowMaterialProperty",Z.LineFlowMaterialType="LineFlowMaterialType",Z.LineFlowMaterialSource=`
      uniform vec4 color;
      uniform float speed;
      uniform float percent;
      uniform float gradient;
      
      czm_material czm_getMaterial(czm_materialInput materialInput){
        czm_material material = czm_getDefaultMaterial(materialInput);
        vec2 st = materialInput.st;
        float t =fract(czm_frameNumber * speed / 1000.0);
        t *= (1.0 + percent);
        float alpha = smoothstep(t- percent, t, st.s) * step(-t, -st.s);
        alpha += gradient;
        material.diffuse = color.rgb;
        material.alpha = alpha;
        return material;
      }
      `,Z._materialCache.addMaterial(Z.LineFlowMaterialType,{fabric:{type:Z.LineFlowMaterialType,uniforms:{color:new S(1,0,0,1),speed:10,percent:.1,gradient:.01},source:Z.LineFlowMaterialSource},translucent:function(n){return!0}});class ui{constructor(e){this._definitionChanged=new qe,this._color=void 0,this._speed=void 0,this._percent=void 0,this._gradient=void 0,this.color=e.color,this.speed=e.speed,this.percent=e.percent,this.gradient=e.gradient}get isConstant(){return!1}get definitionChanged(){return this._definitionChanged}getType(e){return Z.LineFlowMaterialType}getValue(e,t){return a(t)||(t={}),t.color=ie.getValueOrDefault(this._color,e,this.color,t.color),t.speed=ie.getValueOrDefault(this._speed,e,this.speed,t.speed),t.percent=ie.getValueOrDefault(this._percent,e,this.percent,t.percent),t.gradient=ie.getValueOrDefault(this._gradient,e,this.gradient,t.gradient),t}equals(e){return this===e||e instanceof ui&&ie.equals(this._color,e._color)&&ie.equals(this._speed,e._speed)&&ie.equals(this._percent,e._percent)&&ie.equals(this._gradient,e._gradient)}}function $o(n,e,t=0,i=50){let s=[];t=Math.max(+t,100),i=Math.max(+i,50);let r=Math.abs(n[0]-e[0]),o=Math.abs(n[1]-e[1]),l=Math.max(r,o),c=l/i;if(r>o){let h=(e[1]-n[1])/i;n[0]-e[0]>0&&(c=-c);for(let u=0;u<i;u++){let f=t-Math.pow(-.5*l+Math.abs(c)*u,2)*4*t/Math.pow(l,2),m=n[0]+c*u,w=n[1]+h*u,y=new d.fromDegrees(m,w,f);s.push(y)}}else{let h=(e[0]-n[0])/i;n[1]-e[1]>0&&(c=-c);for(let u=0;u<i;u++){let f=t-Math.pow(-.5*l+Math.abs(c)*u,2)*4*t/Math.pow(l,2),m=n[0]+h*u,w=n[1]+c*u,y=new d.fromDegrees(m,w,f);s.push(y)}}return s.push(new d.fromDegrees(e[0],e[1],0)),s}function Hn(n,e,t,i,s=10){let r=[];for(let o=0;o<360;o+=s)r.push(Yo(n,e,t,T.toRadians(o),i));return r.push(r[0]),r}function Yo(n,e,t,i,s){let r=d.fromDegrees(n,e,t),o=new xi(_i.WGS84),l=o.project(q.fromCartesian(r)),c=new d(l.x+s*Math.cos(i),l.y+s*Math.sin(i),0);c=o.unproject(c);let h=c.clone();return h.height=t,c=q.toCartesian(h),c}class zn{constructor(e){M(e),this.map=e,this.viewer=e._viewer,this.dataSource=new B,this.viewer.dataSources.add(this.dataSource),this.cityPrimitiveCollection=new Me,this.viewer.scene.primitives.add(this.cityPrimitiveCollection),this.labelDataSource=new Ge,this.cityPrimitiveCollection.add(this.labelDataSource),this.billboardDataSource=new Le,this.cityPrimitiveCollection.add(this.billboardDataSource),this.polylineDataSource=new St,this.cityPrimitiveCollection.add(this.polylineDataSource),this.defaultMaxHeight=2e4,this.cityBillboardDataSource=new Le,this.cityPrimitiveCollection.add(this.cityBillboardDataSource)}drawFixedCircle(e,t,i,s,r=1,o="rgba(255,255,255,1)"){this.dataSource.entities.add({polyline:{positions:Hn(parseFloat(e),parseFloat(t),i,parseFloat(s),r),width:2,material:new U({color:S.fromCssColorString(o)})}})}addEvent(e=()=>{}){let t=this;a(this.inputHandler)||(this.inputHandler=new te(this.map),this.inputHandler.leftClick(i=>{const s=t.viewer.scene.pick(i.position);s&&(s&&s.primitive&&s.primitive.clickTag==="point_bdz"?e({clickTag:"point_bdz",info:s.primitive.info}):s&&s.id&&s.id.clickTag==="point_nest"&&e({clickTag:"point_nest",id:s.id.info}))}))}setNestPointsCircleShow(e=!0){this.dataSource.entities._entities._array.forEach(i=>{i.clickTag==="point_nest"&&(i.polyline.show=e)})}drawNoFlyZone(e){let t=e.data;a(this.noFlyZoneSource)||(this.noFlyZoneSource=new K(this.map)),t.forEach(i=>{this.noFlyZoneSource.add({polygon:{hierarchy:d.fromDegreesArrayHeights(i.position),material:S.fromCssColorString(e.color)||S.RED.withAlpha(.2),extrudedHeight:e.height||120,perPositionHeight:!0}})})}setNoFlyZoneShow(e=!0){a(this.noFlyZoneSource)&&(this.noFlyZoneSource.show=e)}removeNoFlyZone(){a(this.noFlyZoneSource)&&(this.noFlyZoneSource.destroy(),this.noFlyZoneSource=void 0)}drawLineFlow(e){let t=e.data;a(this.lineFlowDataSource)||(this.lineFlowDataSource=new K(this.map)),t.forEach(i=>{i.children.forEach(s=>{this.lineFlowDataSource.add({polyline:{positions:$o(i.center,s.position,e.height||3500),material:new ui({color:S.WHITE.withAlpha(.9),speed:e.speed||1,percent:e.percent||.8,gradient:e.gradient||.1}),width:e.lineWidth||3.5,distanceDisplayCondition:new k(e.visibleHeight||1e3,1e9)}})})})}removeLineFlow(){a(this.lineFlowDataSource)&&(this.lineFlowDataSource.destroy(),this.lineFlowDataSource=void 0)}drawNestPoints(e){a(e)&&e.data.forEach(t=>{let i=d.fromDegrees(parseFloat(t.jd),parseFloat(t.wd),parseFloat(t.z)||0);this.dataSource.entities.add({id:t.deviceCode,position:i,billboard:{image:t.image||R()+"/Assets/Images/img/nest.png",scale:.3,pixelOffset:new E(0,0)},polyline:{positions:Hn(parseFloat(t.jd),parseFloat(t.wd),parseFloat(t.z)||0,parseFloat(t.patrolRadius)),width:2,material:new U({color:S.fromCssColorString("rgba(255,255,255,1)")})},label:{text:t.deviceName+"",position:i,font:"600 24px Helvetica",scale:.6,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(0,-25)},clickTag:"point_nest",info:t})})}drawJiangsuRegion(e={}){ut(R()+"/Assets/data/jiangsu_outline.json",t=>{t=t.geometries[3].coordinates;let i=[];t.forEach(r=>{i.push(d.fromDegrees(r[0],r[1]))});let s=ft(i,e.tolerance||1e3);this.polylineDataSource.add({positions:s,width:2,material:Z.fromType("Color",{color:S.fromCssColorString("rgba(255,255,255,0.4)")})})})}set bdzShow(e){const t=this.billboardDataSource.length;for(let i=0;i<t;++i){const s=this.billboardDataSource.get(i),r=this.labelDataSource.get(i);s.show=e,r.show=e}}get bdzShow(){}drawBDZPoints(e){e.data.forEach(t=>{let i=new d.fromDegrees(parseFloat(t.x),parseFloat(t.y),parseFloat(t.z)||0),s=this.billboardDataSource.add({position:i,image:t.image||R()+"/Assets/Images/img/city.png",scale:.3,pixelOffset:new E(0,0),distanceDisplayCondition:new k(0,e.maxVisibleHeight||this.defaultMaxHeight)});s.clickTag="point_bdz",s.id=t.id,s.info=t;let r=0;t.name.length>3?r=20+t.name.length*4:r=23;let o=this.labelDataSource.add({text:t.name+"",position:i,font:"600 24px Helvetica",scale:.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,distanceDisplayCondition:new k(0,e.maxVisibleHeight||this.defaultMaxHeight),pixelOffset:new E(-r,-23)});o.clickTag="point_bdz",o.id=t.id,o.info=t})}showArea(e){a(this.powerLine)&&(this.powerLine.active=e)}removeAllNest(){this.dataSource.entities.removeAll(),this.cityPrimitiveCollection.removeAll()}removeAll(){this.cityPrimitiveCollection.removeAll(),this.dataSource.entities.removeAll(),a(this.inputHandler)&&(this.inputHandler.destroy(),this.inputHandler=void 0)}destroy(){this.removeAll(),this.viewer.dataSources.remove(this.dataSource),this.cityPrimitiveCollection=void 0,this.dataSource=void 0}}function Zo(n){let e=n.fixedNestManager;return a(e)&&e instanceof zn||(e=new zn(n),n.FixedNestManager=e),e}function Jo(n,e={}){const t=new Ts({polygonHierarchy:new et(d.fromDegreesArray(n))}),i=new Cesium.GroundPolylineGeometry({positions:d.fromDegreesArray(n),width:e.outlineWidth||4});let s=A.TRANSPARENT;e.fillColor&&(s=A.fromCssColorString(e.fillColor));let r=A.RED;return e.outlineColor&&(r=A.fromCssColorString(e.outlineColor)),{polygonInstance:new _e({geometry:t,attributes:{color:new se.fromColor(s)},id:"multi_polygon_"+e.info}),lineInstance:new _e({geometry:i,attributes:{color:new se.fromColor(r)},id:"multi_polyline_"+e.info})}}class fi{constructor(e,t){this.viewer=e._viewer,this.primitiveCollection=new Me,this.viewer.scene.primitives.add(this.primitiveCollection),this.inputHandler=new te(e)}add(e){return this.primitiveCollection.add(e)}addPolygons(e,t={}){let i=[],s=[];e.forEach(c=>{let h=Ci(t);if(h.info=c.info,c.positions.length>0){let u=Jo(c.positions.reduce((f,m)=>f.concat(m)),h);i.push(u.polygonInstance),s.push(u.lineInstance)}});let r=new Ls({geometryInstances:i}),o=new Es({geometryInstances:s,appearance:new be});this.primitiveCollection.add(r),this.primitiveCollection.add(o);let l;if(a(t.leftClick)){let c=this;this.inputHandler.leftClick(h=>{let u=c.viewer.scene.pick(h.position);if(u&&u.id&&u.id.length>0){let f=u.id.split("_");if(f.length!=3||f[0]!="multi")return;let m=f[0]+"_polyline_"+f[2];t.leftClick(f[2]);let w=o.getGeometryInstanceAttributes(m),y;t.highLightColor?y=A.fromCssColorString(t.highLightColor):y=A.AQUA,w.color=se.toValue(y),l&&(l.color=se.toValue(A.fromCssColorString(t.outlineColor))),l=w}else l&&(l.color=se.toValue(A.fromCssColorString(t.outlineColor)),l=void 0)})}}addBillboardCollection(){return this.primitiveCollection.add(new Le)}addPointPrimitiveCollection(e){return this.primitiveCollection.add(new bt(e))}addLabelCollection(){return this.primitiveCollection.add(new Ge)}addPolylineCollection(){return this.primitiveCollection.add(new St)}remove(e){this.primitiveCollection.remove(e)}removeAll(){this.primitiveCollection.removeAll()}destroy(){this.removeAll(),this.viewer.scene.primitives.remove(this.primitiveCollection),this.primitiveCollection=null,this.inputHandler&&this.inputHandler.destroy()}}function Bn(n,e){let t=[],i=[];for(let s=0;s<n.length-1;s++){let r=d.fromDegrees(n[s][0],n[s][1],e),o=d.distanceSquared(r,d.fromDegrees(n[s+1][0],n[s+1][1],e));i.push(r),o/1e3/1e3>400&&(t.push(i),i=[])}return t.push(i),t.forEach((s,r)=>{if(s.length>1){let o=[];t.forEach((h,u)=>{h.length>1&&r!=u&&(o=o.concat(h))});let l=[],c=[];for(let h=0;h<o.length;h++){let u=d.distance(s[s.length-1],o[h])/1e3,f=d.distance(s[0],o[h])/1e3;l.push({type:"end",dis:u,pos:o[h]}),c.push({type:"start",dis:f,pos:o[h]})}l.sort((h,u)=>h.dis-u.dis),c.sort((h,u)=>h.dis-u.dis),l[0].dis<22&&s.push(l[0].pos),c[0].dis<22&&s.unshift(c[0].pos)}}),t}class Ko{constructor(e){this.map=e,this.viewer=e._viewer,this.extrudedHeight=2e4,this.tolerance=700,this.regionPolygons=[],this.regionPolygonDefaultColor=S.fromCssColorString("rgba(129,202,196,0.3)"),this.moveOnPolygonId="",this.dataSource=new B,this.viewer.dataSources.add(this.dataSource)}add(e={}){let t=this,i={};ut(R()+"/Assets/data/jiangsu.json",s=>{s=s.features,s.forEach(h=>{const u=h.geometry.coordinates[0][0],f=h.properties;let m=Cesium.Cartesian3.fromDegreesArray(u.reduce((y,v)=>y.concat(v)));this.tolerance&&(m=ft(m,this.tolerance));let w=this.dataSource.entities.add({position:d.fromDegrees(f.center[0],f.center[1],this.extrudedHeight),polygon:{hierarchy:m,material:this.regionPolygonDefaultColor,extrudedHeight:this.extrudedHeight},label:{text:f.name+"",font:"600 20px Helvetica",scale:.8,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(0,-25)},type:"region",info:f});this.regionPolygons.push(w);for(let y=0;y<u.length;y++)i[u[y][0]]?i[u[y][0]].value===u[y][1]&&(i[u[y][0]].num=i[u[y][0]].num+1):i[u[y][0]]={value:u[y][1],num:1}});let r=[],o=[],l=[];for(let h in i)i[h].num>1?r.push([parseFloat(h),i[h].value]):l.push([parseFloat(h),i[h].value]);Bn(r,this.extrudedHeight).forEach(h=>{h.length>1&&(this.tolerance&&(h=ft(h,this.tolerance)),this.dataSource.entities.add({polyline:{positions:h,material:S.fromCssColorString("rgba(4,178,165,1)"),width:2}}))}),o=Bn(l,this.extrudedHeight),o.forEach(h=>{h.length>1&&(this.tolerance&&(h=ft(h,this.tolerance)),this.dataSource.entities.add({polyline:{positions:h,material:S.fromCssColorString("rgba(255,255,255,1)"),width:4}}))}),a(this.inputHandler)||(this.inputHandler=new te(this.map),this.inputHandler.mouseMove(h=>{const u=t.viewer.scene.pick(h.endPosition);if(u&&u.id&&u.id.type==="region"){if(t.moveOnPolygonId===u.id.id)return;u.id.polygon.material=S.fromCssColorString("rgba(80,183,177,0.9)"),u.id.polygon.extrudedHeight=t.extrudedHeight*1.5,t.regionPolygons.forEach(f=>{u.id!=f&&(f.polygon.material=t.regionPolygonDefaultColor,f.polygon.extrudedHeight=t.extrudedHeight)}),t.moveOnPolygonId=u.id.id}}),a(e.click)&&this.inputHandler.leftClick(h=>{const u=t.viewer.scene.pick(h.position);u&&u.id&&u.id.type==="region"&&e.click(u.id.info)})),t.map.zoomToJiangSu(e.cameraInfo||{position:[120.218669,29.77413,706173],heading:5.063,pitch:-65.26,roll:.51})})}removeAll(){this.map.enableMove(!0),this.dataSource.removeAll(),this.viewer.dataSources.remove(this.dataSource),a(this.inputHandler)&&this.inputHandler.destroy()}}class qo{constructor(e){this.map=e,this.viewer=e._viewer,this.primitiveCollection=new Me,this.viewer.scene.primitives.add(this.primitiveCollection),this.billboardCollection=new Le,this.primitiveCollection.add(this.billboardCollection),this.labelCollection=new Ge,this.primitiveCollection.add(this.labelCollection)}add(e={}){let t=this;const i=e.eventType||"mixedPoints";a(e.data)&&e.data.forEach(s=>{if(!a(s.position))return;let r=d.fromDegrees(s.position[0],s.position[1],s.position[2]||0);a(s.image)&&s.image.forEach(o=>{a(o.pixelOffset)||(o.pixelOffset=[0,0]);let l=this.billboardCollection.add({position:r,image:o.url,scale:o.scale,width:o.width,height:o.height,pixelOffset:new E(o.pixelOffset[0],o.pixelOffset[1])});l.type=i,l.info=s.clickInfo}),a(s.text)&&s.text.forEach(o=>{a(o.pixelOffset)||(o.pixelOffset=[0,0]);let l=this.labelCollection.add({text:o.text+"",position:r,font:o.font||"600 24px Helvetica",scale:o.scale||.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(o.pixelOffset[0],o.pixelOffset[1])});l.type=i,l.info=s.clickInfo})}),a(e.click)&&(this.inputHandler||(this.inputHandler=new te(this.map)),this.inputHandler.leftClick(s=>{const r=t.viewer.scene.pick(s.position);r&&r.primitive&&r.primitive.type===i&&e.click(r.primitive.info)})),a(e.mouseMove)&&(this.inputHandler||(this.inputHandler=new te(this.map)),this.inputHandler.mouseMove(s=>{const r=t.viewer.scene.pick(s.endPosition);if(r&&r.primitive&&r.primitive.type===i){let o=t.map.pickPosition(s.endPosition);e.mouseMove({info:r.primitive.info,position:o})}else e.mouseMove(void 0)}))}removeAll(){a(this.primitiveCollection)&&(this.labelCollection.removeAll(),this.billboardCollection.removeAll(),this.viewer.scene.primitives.remove(this.primitiveCollection),this.labelCollection=null,this.billboardCollection=null,this.primitiveCollection=null,a(this.inputHandler)&&this.inputHandler.destroy())}}function Xo(n,e,t){n.getLayer("service")?(n.getSource("service").setData({type:"FeatureCollection",features:[]}),t()):n.loadImage(e,function(s,r){n.addImage("ganta",r),n.addLayer({id:"service",type:"symbol",minzoom:0,maxzoom:20,source:{type:"geojson",data:{type:"FeatureCollection",features:[]}},layout:{"icon-image":"ganta","icon-size":.8,"icon-ignore-placement":!0,"text-ignore-placement":!1,"text-field":"{name}","text-size":12,"text-anchor":"top","text-allow-overlap":!1,"icon-anchor":"bottom","text-offset":[0,0],"text-max-width":8,"text-font":["Microsoft YaHei Regular"]},paint:{"text-color":"#555252","text-halo-color":"#FFFFFF","text-halo-width":1.33333}}),t()})}function Qo(n,e,t){n.getLayer("power-line")?n.getSource("power-line").setData({type:"FeatureCollection",features:[]}):n.loadImage(e,function(s,r){n.addImage("arrowline",r);let o={type:"geojson",data:{type:"FeatureCollection",features:[]}};n.addLayer({id:"power-line",type:"line",source:o,layout:{"line-cap":"round","line-join":"round"},paint:{"line-width":4,"line-pattern":"arrowline"}}),n.addLayer({id:"line-animation",type:"line",source:o,layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#AF5","line-width":3,"line-opacity":.9}}),t()})}function ea(n,e,t){Xo(n,e,()=>{n.getSource("service").setData({type:"FeatureCollection",features:t})})}function ta(n,e,t,i="#ed6498"){Qo(n,t,()=>{n.getSource("power-line").setData({type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:e},properties:{"line-color":i}}]})})}function pi(n,e){n.getSource(e).setData({type:"FeatureCollection",features:[]}),n.getLayer(e)&&n.removeLayer(e)&&n.removeSource(e)}function ia(n){pi(n,"power-line"),pi(n,"line-animation")}function na(n){pi(n,"service")}function sa(n,e,t){e.scrollZoom.disable(),e.dragRotate.disable(),e.dragPan.disable();let i=[],s=[];t.forEach(r=>{i.push({type:"Feature",geometry:{type:"Point",coordinates:[r.lon,r.lat]},properties:{type:"ganta",name:r.name}}),s.push([r.lon,r.lat])}),ta(e,s,R()+"/Assets/Images/img/roadFragment.jpg"),ea(e,R()+"/Assets/Images/img/ganta.png",i)}class ra{constructor(e,t={}){M(e),this.map=e,this.viewer=this.map._viewer,this.speed=t.speed||10,this.stayTime,a(t.stayTime)?this.stayTime=t.stayTime:this.stayTime=1,this.entity=null,this.listener=void 0,this.listenerMap2d=void 0,this.viewFrom=new d(-.001,0,0),this.enableMove=!1,this.cameraMoveEnd=!0}createFlight(e,t){let i=this,s=this.viewer;this.remove(),this.cameraMoveEnd=!0,a(t["2d"])&&a(t["2d"].map2d)&&(sa(this,t["2d"].map2d,e),this.map2d=t["2d"].map2d);let r=b.fromDate(new Date),o,l=new Ae,c=new Ct(Number),h=0;for(let v=0;v<e.length;v++){let C=d.fromDegrees(e[v].lon,e[v].lat,e[v].height+20),_;if(v>0){let H=d.distance(d.fromDegrees(e[v].lon,e[v].lat,e[v].height),d.fromDegrees(e[v-1].lon,e[v-1].lat,e[v-1].height));h+=H/this.speed,_=b.addSeconds(r,h,new b)}else _=b.addSeconds(r,0,new b);c.addSample(b.addSeconds(r,h,new b),v),v>0&&(h+=this.stayTime);let P=b.addSeconds(r,h,new b);l.addSample(_,C),l.addSample(P,C),v===e.length-1&&(o=b.addSeconds(r,h,new b),c.addSample(b.addSeconds(r,h,new b),v))}let u=s.entities.add({availability:new ps([new ms({start:r,stop:o})]),position:l,orientation:new fs(l),model:{uri:R()+"/Assets/models/uav/dji.gltf",scale:.2,minimumPixelSize:20}});this.entity=u,s.clock.startTime=r.clone(),s.clock.currentTime=r.clone(),s.clock.stopTime=o.clone(),s.clock.clockRange=gs.CLAMPED,s.clock.multiplier=1,s.clock.shouldAnimate=!0;let f=0,m,w=0;this.setVisualView(t.visualView);let y=[];return i.listener=function(v){let C=c.getValue(v.currentTime);if(!a(C))return;let _=Math.floor(C),P=i.entity.position.getValue(v.currentTime);if(!i.enableMove){if(!i.cameraMoveEnd)return;let X=i.entity.orientation.getValue(v.currentTime);a(X)&&(m=X);let j=le.eastNorthUpToFixedFrame(P);j=O.fromRotationTranslation(Cesium.Matrix3.fromQuaternion(m),P),s.camera.lookAtTransform(j,i.viewFrom)}let H=Ee(i.viewer,P);y.push([H.x,H.y]),a(i.map2d)&&i.map2d.getSource("line-animation")&&i.map2d.getSource("line-animation").setData({type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:y},properties:{"line-color":"red"}}]}),_===e.length-1&&(a(t.towerEndEvent)&&i.cameraMoveEnd&&t.towerEndEvent(),i.cameraMoveEnd=!1),parseFloat(C.toFixed(1))==f+.2&&parseFloat(C.toFixed(1))!=w&&(a(t.towerMidEvent)&&t.towerMidEvent([e[_],e[_+1]]),w=parseFloat(C.toFixed(1))),f!=_&&(f=_,i.map.dispatchEvent({type:"patrol-flying",data:e[_]}),a(t.towerEvent)&&(a(e[_+1])?t.towerEvent([e[_],e[_+1]]):t.towerEvent([e[_],e[_]])),a(i.map2d)&&(a(e[_+2])?i.map2d.fitBounds([[e[_].lon,e[_].lat],[e[_+2].lon,e[_+2].lat]],{animate:!1,padding:{top:50,bottom:50,left:50,right:50}}):i.map2d.fitBounds([[e[_].lon,e[_].lat],[e[_-1].lon,e[_-1].lat]],{animate:!1,padding:{top:50,bottom:50,left:50,right:50}})))},s.clock.onTick.addEventListener(i.listener),this.entity}setVisualView(e="first"){a(this.entity)&&(e==="first"?(this.viewer.trackedEntity=void 0,this.enableMove=!1,this.viewFrom=new d(-.001,0,0),this.entity.model.show=!1):e==="third"?(this.enableMove=!0,this.viewer.trackedEntity=this.entity,this.entity.viewFrom=new d(-100,0,200),this.entity.model.show=!0):e==="free"&&(this.viewer.trackedEntity=void 0,this.enableMove=!0,this.viewer.camera.lookAtTransform(O.IDENTITY),this.entity.model.show=!0))}setMultiplierTime(e){if(e>10)throw new Error("模拟速度过快，不高于10");this.viewer.clock.multiplier=e}pause(){this.viewer.clock.shouldAnimate=!1}continue(){this.viewer.clock.shouldAnimate=!0}remove(){a(this.entity)&&(this.viewer.entities.remove(this.entity),this.viewer.clock.shouldAnimate=!1,this.viewer.clock.multiplier=1,this.entity=null,a(this.listener)&&(this.viewer.clock.onTick.removeEventListener(this.listener),this.listener=null),this.viewer.trackedEntity=void 0,this.viewer.camera.lookAtTransform(O.IDENTITY),a(this.map2d)&&(ia(this.map2d),na(this.map2d)))}}class oa{constructor(){this.lng=null,this.lat=null,this.x=null,this.y=null,this.tlng=null,this.tlat=null,this.age=null,this.speed=null,this.color=null}}class aa{constructor(e){this.west=null,this.east=null,this.south=null,this.north=null,this.rows=null,this.cols=null,this.dx=null,this.dy=null,this.unit=null,this.date=null,this.grid=null,this.init(e)}calcUV(e,t){return[+e,+t,Math.sqrt(e*e+t*t)]}init(e){const{header:t,uComponent:i,vComponent:s}=e;this.west=+t.lo1,this.east=+t.lo2,this.south=+t.la2,this.north=+t.la1,this.rows=+t.ny,this.cols=+t.nx,this.dx=+t.dx,this.dy=+t.dy,this.unit=t.parameterUnit,this.date=t.refTime,this.grid=[];let r=0,o=null,l=null;for(let c=0;c<this.rows;c++){o=[];for(let h=0;h<this.cols;h++,r++)l=this.calcUV(i[r],s[r]),o.push(l);this.grid.push(o)}}bilinearInterpolation(e,t,i,s,r,o){const l=1-e,c=1-t,h=l*c,u=e*c,f=l*t,m=e*t,w=i[0]*h+s[0]*u+r[0]*f+o[0]*m,y=i[1]*h+s[1]*u+r[1]*f+o[1]*m;return this.calcUV(w,y)}getIn(e,t){if(e<0||e>=359||t>=180)return[0,0,0];const i=Math.floor(e),s=Math.floor(t);if(i===e&&s===t)return this.grid[t]&&this.grid[t][e]?this.grid[t][e]:[0,0,0];const r=i+1,o=s+1,l=this.getIn(i,s),c=this.getIn(r,s),h=this.getIn(i,o),u=this.getIn(r,o);let f=null;try{f=this.bilinearInterpolation(e-i,t-s,l,c,h,u)}catch{console.error(e,t)}return f}isInBound(e,t){return e>=0&&e<this.cols-1&&t>=0&&t<this.rows-1}}class la{constructor(e){this.color=e||["#293C8B","#BBF49A","#869C4A","#369D41","#287A61"]}getWindColor(e){return e<=6?this.color[0]:e<=8?this.color[1]:e<=10?this.color[2]:e<=12?this.color[3]:this.color[4]}}class ha{constructor(e,t){this.windData=e,this.viewer=t.viewer,this.canvas=t.canvas,this.extent=t.extent||[],this.canvasContext=t.canvas.getContext("2d"),this.canvasWidth=t.canvasWidth||300,this.canvasHeight=t.canvasHeight||180,this.speedRate=t.speedRate||100,this.particlesNumber=t.particlesNumber||2e4,this.maxAge=t.maxAge||120,this.frameTime=1e3/(t.frameRate||10),this.color=t.color||"#ffffff",this.lineWidth=t.lineWidth||1,this.initExtent=[],this.calc_speedRate=[0,0],this.windField=null,this.particles=[],this.animateFrame=null,this.isdistory=!1,this.windyColor=new la(t.windyColor),this._init()}_init(){const e=this;this.windField=this.createField(),this.initExtent=[this.windField.west,this.windField.east,this.windField.south,this.windField.north],this.extent.length!==0&&(this.extent=[Math.max(this.initExtent[0],this.extent[0]),Math.min(this.initExtent[1],this.extent[1]),Math.max(this.initExtent[2],this.extent[2]),Math.min(this.initExtent[3],this.extent[3])]),this._calcStep();for(let i=0;i<this.particlesNumber;i++)this.particles.push(this.randomParticle(new oa));this.canvasContext.fillStyle="rgba(0, 0, 0, 0.97)",this.canvasContext.globalAlpha=.6,this.animate();let t=Date.now();(function i(){if(e.isdistory)e.removeLines();else{e.animateFrame=requestAnimationFrame(i);const s=Date.now(),r=s-t;r>e.frameTime&&(t=s-r%e.frameTime,e.animate())}})()}_calcStep(){const t=this.extent.length!==0?this.extent:this.initExtent,i=this.speedRate;this.calc_speedRate=[(t[1]-t[0])/i,(t[3]-t[2])/i]}redraw(){window.cancelAnimationFrame(this.animateFrame),this.particles=[],this._init()}createField(){const e=this._parseWindJson();return new aa(e)}animate(){const e=this,t=e.windField;let i=null,s=null,r=null;e.particles.forEach(o=>{if(o.age<=0&&e.randomParticle(o),o.age>0){const{tlng:l,tlat:c}=o,h=e._togrid(l,c),u=h[0],f=h[1];e.isInExtent(l,c)?(r=t.getIn(u,f),i=l+e.calc_speedRate[0]*r[0],s=c+e.calc_speedRate[1]*r[1],o.lng=l,o.lat=c,o.x=u,o.y=f,o.tlng=i,o.tlat=s,o.age--):o.age=0}}),e.particles.length<=0&&this.removeLines(),e._drawLines()}isInExtent(e,t){const i=this.initExtent;return e>=i[0]&&e<=i[1]&&t>=i[2]&&t<=i[3]}_resize(e,t){this.canvasWidth=e,this.canvasHeight=t}_parseWindJson(){let e=null,t=null,i=null;return this.windData.forEach(s=>{switch(`${s.header.parameterCategory},${s.header.parameterNumber}`){case"2,2":e=s.data,i=s.header;break;case"2,3":t=s.data;break}}),{header:i,uComponent:e,vComponent:t}}removeLines(){var e;window.cancelAnimationFrame(this.animateFrame),this.isdistory=!0,this.canvas.width=1,(e=document.getElementById("content"))==null||e.removeChild(this.canvas)}_tomap(e,t,i){const s=d.fromDegrees(e,t,0),r=new bs(_i.WGS84,this.viewer.camera.position).isPointVisible(s),o=_t.wgs84ToWindowCoordinates(this.viewer.scene,s);return r||(i.age=0),o?[o.x,o.y]:null}_togrid(e,t){const i=this.windField,s=(e-this.initExtent[0])/(this.initExtent[1]-this.initExtent[0])*(i.cols-1),r=(this.initExtent[3]-t)/(this.initExtent[3]-this.initExtent[2])*(i.rows-1);return[s,r]}_drawLines(){const e=this,{particles:t}=this;this.canvasContext.lineWidth=e.lineWidth,this.canvasContext.globalCompositeOperation="destination-in",this.canvasContext.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.canvasContext.globalCompositeOperation="lighter",this.canvasContext.globalAlpha=.9,t.forEach(i=>{const s=e._tomap(i.lng,i.lat,i),r=e._tomap(i.tlng,i.tlat,i);e.canvasContext.beginPath(),s!=null&&r!=null&&(e.canvasContext.moveTo(s[0],s[1]),e.canvasContext.lineTo(r[0],r[1]),e.canvasContext.strokeStyle=i.color,e.canvasContext.stroke())})}fRandomByfloat(e,t){return e+Math.random()*(t-e)}fRandomBy(e,t){switch(arguments.length){case 1:return parseInt(Math.random()*e+1,10);case 2:return parseInt(Math.random()*(t-e+1)+e,10);default:return 0}}randomParticle(e){let t=30,i=-1,s=-1,r=null,o=null;const l=this.extent.length!=0,c=l?this.extent:this.initExtent;do{try{if(l){const w=this.fRandomBy(0,this.canvasWidth),y=this.fRandomBy(0,this.canvasHeight),v=this.viewer.camera.pickEllipsoid(new E(w,y),this.viewer.scene.globe.ellipsoid);if(!v)return;const C=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(v);C&&(r=T.toDegrees(C.longitude),o=T.toDegrees(C.latitude))}else r=this.fRandomByfloat(c[0],c[1]),o=this.fRandomByfloat(c[2],c[3])}catch(w){console.error(w)}if(r){const w=this._togrid(r,o);i=w[0],s=w[1]}}while(this.windField.getIn(i,s)[2]<=0&&t++<30);const u=this.windField.getIn(i,s),f=r+this.calc_speedRate[0]*u[0],m=o+this.calc_speedRate[1]*u[1];return e.lng=r,e.lat=o,e.x=i,e.y=s,e.tlng=f,e.tlat=m,e.speed=u[2],e.age=Math.round(Math.random()*this.maxAge),e.color=this.windyColor.getWindColor(e.speed),e}clearRect(){this.isdistory=!0}start(){this.isdistory=!1}}const mi=function(){document.getElementById("windycanvas").style.display="block"},Nn=function(){document.getElementById("windycanvas").style.display="none"};function Wn(n){let e=[],t=window.innerWidth,i=window.innerHeight,s=new E(0,0),r=new E(0,i),o=new E(t,0),l=new E(t,i),c=n.scene.globe.pick(n.camera.getPickRay(s),n.scene),h=n.scene.globe.pick(n.camera.getPickRay(r),n.scene),u=n.scene.globe.pick(n.camera.getPickRay(o),n.scene),f=n.scene.globe.pick(n.camera.getPickRay(l),n.scene);if(c&&h&&u&&f){let m=n.scene.globe.ellipsoid.cartesianToCartographic(h),w=n.scene.globe.ellipsoid.cartesianToCartographic(u),y=[m.longitude/Math.PI*180,m.latitude/Math.PI*180],v=[w.longitude/Math.PI*180,w.latitude/Math.PI*180];y[0]>v[0]?e=[y[0],180,y[1],v[1],-180,v[0],y[1],v[1]]:e=[y[0],v[0],y[1],v[1]]}else!a(c)&&!a(u)&&a(h)&&a(f)?e=void 0:e=[];return e}const ca=function(n,e){n!=null&&(n.width=window.innerWidth,n.height=window.innerHeight,e&&e._resize(n.width,n.height))};class Vn{constructor(e){this.map=e,this.viewer=e._viewer,this.windy=null,this.timeout=-1,this.windyShow=!0}initWindy(e,t={}){this.remove();let i=this.viewer,s=document.createElement("canvas");this.windycanvas=s,s.setAttribute("id","windycanvas"),s.style.position="fixed",s.style["pointer-events"]="none",s.style["z-index"]=10,s.style.bottom=0,s.style.top=0,s.style.left=0,s.style.right=0,i.container.appendChild(s);let r={viewer:i,canvas:s,canvasWidth:window.innerWidth,canvasHeight:window.innerHeight,speedRate:t.speedRate||5e3,particlesNumber:t.particlesNumber||5e3,maxAge:t.maxAge||120,frameRate:t.frameRate||10,color:t.color||"#3a92ff",lineWidth:t.lineWidth||3};r.windyColor=t.windyColor;let o=new ha(e,r);this.windy=o,mi(),ca(s,o);let l=Wn(i);this.postRender=()=>{l=Wn(i)},i.scene.postRender.addEventListener(this.postRender),this.cameraEvent=()=>{this.windyShow&&(clearTimeout(this.timeout),Nn(),this.timeout=setTimeout(()=>{l&&(o.extent=l,o.redraw()),mi()},500))},this.viewer.camera.changed.addEventListener(this.cameraEvent)}showWindy(){this.windyShow=!0,mi()}hideWindy(){this.windyShow=!1,Nn()}remove(){a(this.windy)&&(clearTimeout(this.timeout),this.windy.removeLines(),this.viewer.scene.postRender.removeEventListener(this.postRender),this.viewer.camera.changed.removeEventListener(this.cameraEvent),this.viewer.container.removeChild(this.windycanvas),this.windycanvas=null,this.windy=null)}}function da(n){let e=n.windyManager;return a(e)&&e instanceof Vn||(e=new Vn(n),n.windyManager=e),e}class ua{constructor(e){this.map=e,this.viewer=e._viewer,this.collection=new K(this.map),this.primitiveCollection=new fi(this.map),this.lists={}}add(e){e.data.forEach(t=>{this.lists[t.lineId]||(this.lists[t.lineId]={});let i=this.lists[t.lineId];i.polyline=[];let s=[],r=!0;if(t.towerList.forEach((o,l)=>{if(!o.yxId)throw new Error("缺少杆塔id");if(!i[o.yxId]){i[o.yxId]={};let c=d.fromDegrees(o.lon,o.lat);if(s.push(c),o.tileList.length>0){let h=[];o.tileList.forEach(u=>{let f=this.primitiveCollection.add(new pe({url:u.path.replace(/#/g,"%23")}));h.push(f)}),i[o.yxId].tiles=h,r=!1}else{let h=!1;if(l>0?t.towerList[l-1].tileList.length==0&&(h=!0):h=!0,h){let f=this.collection.add({billboard:{image:t.towerImage,heightReference:yt.CLAMP_TO_GROUND},position:c});i[o.yxId].billboard=f}let u=[c];l<t.towerList.length-1&&(u.push(d.fromDegrees(t.towerList[l+1].lon,t.towerList[l+1].lat)),i.polyline.push(this.collection.add({polyline:{positions:u,width:t.lineWidth,material:S.fromCssColorString(t.color),clampToGround:!0}})))}}}),r){let o=this.collection.add({polyline:{positions:s,width:t.lineWidth,material:S.fromCssColorString(t.color),clampToGround:!0}});i.polyline.push(o)}})}removeByLineId(e){let t=this.lists[e];for(let i in t)a(t[i].billboard)&&this.collection.remove(t[i].billboard),a(t[i].tiles)&&t[i].tiles.forEach(s=>{this.primitiveCollection.remove(s)});a(t.polyline)&&t.polyline.forEach(i=>{this.collection.remove(i)}),delete this.lists[e]}removeAll(){for(let e in this.lists)this.removeByLineId(e);this.lists={}}destroy(){this.removeAll(),this.collection.destroy(),this.primitiveCollection.destroy()}}let Un=.1,fa=2,pa=new S(0,0,0,0);Z.WaveCircleMaterialType="WaveCircleMaterial",Z._materialCache.addMaterial(Z.WaveCircleMaterialType,{fabric:{type:Z.WaveCircleMaterialType,uniforms:{color:pa,time:1,count:fa,gradient:Un},source:`
czm_material czm_getMaterial(czm_materialInput materialInput)
 {
 
czm_material material = czm_getDefaultMaterial(materialInput);
 
material.diffuse = 1.5 * color.rgb;
 vec2 st = materialInput.st;
 
vec3 str = materialInput.str;
                  
float dis = distance(st, vec2(0.5, 0.5));
 
float per = fract(time);

if(abs(str.z)>0.001){
       
discard;
 
}
       
if(dis >0.5){
   
 discard;
                 
}else {
                        
float perDis = 0.5/count;
  
float disNum;
       
float bl = .0;
 
for(int i=0;i<=999;i++){
  
if(float(i)<=count){
   
 disNum = perDis*float(i) - dis + per/count;
  
if(disNum>0.0){
  
if(disNum<perDis){
                                    
 bl = 1.0-disNum/perDis;
                     
}
                               
else if(disNum-perDis<perDis){
 
bl = 1.0 - abs(1.0-disNum/perDis);
     
}
                
material.alpha = pow(bl,gradient);
    
}
         
}
       }
  
 }
 
  return material;
 }`},translucent:function(){return!0}});class gi{constructor(e){e=p(e,{}),this._definitionChanged=new qe,this._duration=e.duration||1e3,this._count=e.count||2,this._count<=0&&(this._count=1),this._gradient=p(e.gradient,Un),this._gradient<0&&(this._gradient=0),this._gradient>1&&(this._gradient=1),this._color=void 0,this.color=p(e.color,S.RED),this._time=void 0}get definitionChanged(){return this._definitionChanged}getType(){return Z.WaveCircleMaterialType}getValue(e,t){return a(t)||(t={}),t.color=ie.getValueOrClonedDefault(this._color,e,this.color,t.color),a(this._time)||(this._time=$()),t.time=($()-this._time)/this._duration,t.count=this._count,t.gradient=1+10*(1-this._gradient),t}equals(e){return this===e||e instanceof gi&&ie.equals(this._color,e._color)}}class ma extends K{constructor(t,i){super(t);Gn(this,"count");this.id=i,this.duration=1e3,this.maxRadius=1e3,this.pointDraged=null,this.leftDownFlag=!1}change_duration(t){const i=this.viewer.entities.getById(this.id);i._ellipse._material.duration=t}change_waveCount(t){const i=this.viewer.entities.getById(this.id);i._ellipse._material.count=t}add(t,i,s,r,o=2){const l=this;this.count=o,this.entityDataSource.entities.add({id:l.id,position:d.fromDegrees(t[0],t[1],t[2]),ellipse:{semiMinorAxis:new W(function(c){return s},!1),semiMajorAxis:new W(function(c){return s},!1),material:new gi({duration:r,gradient:0,color:new S.fromCssColorString(i),count:o})}})}}class vi{constructor(e){this.map=e,this.viewer=e._viewer}drawTowerIncline(e,t={}){a(this.inclineSource)||(this.inclineSource=new K(this.map));let i=p(t.labelOpt,{});e.forEach(s=>{this.inclineSource.add({position:d.fromDegrees(s.inclinePoints[0],s.inclinePoints[1],s.inclinePoints[2]),polyline:{positions:d.fromDegreesArrayHeights(s.inclinePoints),width:t.lineWidth||3,material:S.fromCssColorString(t.lineColor||"#78FF91")},label:{text:i.text||"杆塔倾斜："+s.incline,font:i.font||"600 24px Helvetica",scale:i.scale||.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(10,-10),disableDepthTestDistance:Number.POSITIVE_INFINITY}})})}drawPowerLineToGroundSpace(e,t={}){a(this.powerLineToGroundSpaceSource)||(this.powerLineToGroundSpaceSource=new K(this.map));let i=p(t.labelOpt,{});e.forEach(s=>{Object.entries(s).forEach(r=>{r=r[1],a(r.point)&&this.powerLineToGroundSpaceSource.add({position:d.fromDegrees(r.point[0],r.point[1],r.point[2]),polyline:{positions:d.fromDegreesArrayHeights(r.point),width:t.lineWidth||3,material:S.fromCssColorString(t.lineColor||"#78FF91")},label:{text:i.text||"导线对地物距离："+r.distance.toFixed(2)+"m",font:i.font||"600 24px Helvetica",scale:i.scale||.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(10,-10),disableDepthTestDistance:Number.POSITIVE_INFINITY}})})})}drawWirePhaseSpace(e,t={}){a(this.wirePhaseSpaceSource)||(this.wirePhaseSpaceSource=new K(this.map));let i=p(t.labelOpt,{});e.forEach(s=>{this.wirePhaseSpaceSource.add({position:d.fromDegrees(s.spacePoints[0],s.spacePoints[1],s.spacePoints[2]),polyline:{positions:d.fromDegreesArrayHeights(s.spacePoints),width:t.lineWidth||3,material:S.fromCssColorString(t.lineColor||"#78FF91")},label:{text:"相间距离："+s.space.toFixed(2)+"m",font:i.font||"600 24px Helvetica",scale:i.scale||.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(10,-10),disableDepthTestDistance:Number.POSITIVE_INFINITY}})})}drawSag(e,t={}){a(this.sagSource)||(this.sagSource=new K(this.map));let i=p(t.labelOpt,{});e.forEach(s=>{let r=s.type==1?"导线弧垂距离：":"地线弧垂距离：";a(s.sagPoints);let o=s.sagPoints.splice(0,6),l=s.sagPoints.splice(6,9).concat(s.sagPoints.splice(0,3));this.sagSource.add({polyline:{positions:d.fromDegreesArrayHeights(o),width:t.lineWidth||3,material:S.fromCssColorString(t.lineColor||"#78FF91")}}),this.sagSource.add({position:d.midpoint(d.fromDegrees(l[0],l[1],l[2]),d.fromDegrees(l[3],l[4],l[5]),new d),polyline:{positions:d.fromDegreesArrayHeights(l),width:t.lineWidth||3,material:S.fromCssColorString(t.lineColor||"#78FF91")},label:{text:r+s.distance.toFixed(2)+"m",font:i.font||"600 24px Helvetica",scale:i.scale||.7,fillColor:S.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(10,-10),disableDepthTestDistance:Number.POSITIVE_INFINITY}})})}removeTowerIncline(){a(this.inclineSource)&&this.inclineSource.removeAll()}removePowerLineToGroundSpace(){a(this.powerLineToGroundSpaceSource)&&this.powerLineToGroundSpaceSource.removeAll()}removeWirePhaseSpace(){a(this.wirePhaseSpaceSource)&&this.wirePhaseSpaceSource.removeAll()}removeSag(){a(this.sagSource)&&this.sagSource.removeAll()}removeAll(){this.removeTowerIncline(),this.removePowerLineToGroundSpace(),this.removeWirePhaseSpace(),this.removeSag()}destroy(){this.removeAll(),a(this.inclineSource)&&this.inclineSource.destroy(),a(this.powerLineToGroundSpaceSource)&&this.powerLineToGroundSpaceSource.destroy(),a(this.wirePhaseSpaceSource)&&this.wirePhaseSpaceSource.destroy(),a(this.sagSource)&&this.sagSource.destroy()}}function ga(n){let e=n.electricCheckManager;return a(e)&&e instanceof vi||(e=new vi(n),n.electricCheckManager=e),e}new Ds({vertexShaderSource:`
                in vec3 position3DHigh;
                in vec3 position3DLow;
                in float batchId;
                out vec4 v_positionEC;
  
                in vec4 color;
                out vec4 v_color;
  
                void main()
                {
                    v_color = color;
                    vec4 p = czm_computePosition(); // 获取模型相对于视点位置
                    vec4 eyePosition = czm_modelViewRelativeToEye * p; // 由模型坐标 得到视点坐标
                    v_positionEC =  czm_inverseModelView * eyePosition;   // 视点在 模型坐标系中的位置
                    gl_Position = czm_modelViewProjectionRelativeToEye * p;  // 视点坐标转为屏幕坐标
                }
                    `,fragmentShaderSource:`           
                in vec4 v_positionEC;
                in vec3 v_normalEC;
                in vec4 v_color;
                void main() {
                  float l = sqrt(pow(v_positionEC.x,2.0) + pow(v_positionEC.y,2.0) + pow(v_positionEC.z,2.0)); // 距离模型坐标系原点的距离
                  float cy3 = fract((abs(l - 400.0))/4800.0); 
                  float alpha = cy3;
                  out_FragColor = vec4(v_color.rgb,alpha);
                }
                `});class va{constructor(e,t){this.map=e,this.opt=t,this.viewer=this.map._viewer,this.primitiveCollection=new fi(e),this.entityDataSource=new K(e)}addTest(e,t){e.forEach(i=>{let s=[];s.push({lon:i.top.startPos[0],lat:i.top.startPos[1],height:i.top.startPos[2],color:"blue"}),s.push({lon:i.top.endPos[0],lat:i.top.endPos[1],height:i.top.endPos[2],color:"blue"}),s.push({lon:i.bottom.startPos[0],lat:i.bottom.startPos[1],height:i.bottom.startPos[2],color:"red"}),s.push({lon:i.bottom.endPos[0],lat:i.bottom.endPos[1],height:i.bottom.endPos[2],color:"red"}),this.entityDataSource.add({polygon:{hierarchy:d.fromDegreesArrayHeights(i.topWire.pos),material:A.BLUE.withAlpha(.3),perPositionHeight:!0,extrudedHeight:i.topWire.len}});let r=d.fromDegrees(...i.cross.top),o=d.fromDegrees(...i.cross.bottom);this.entityDataSource.add({polygon:{hierarchy:d.fromDegreesArrayHeights(i.bottomWire.pos),material:A.RED.withAlpha(.3),perPositionHeight:!0,extrudedHeight:20}}),this.entityA=this.entityDataSource.add({show:!1,polyline:{positions:[r,o],material:A.WHITE,width:2.5},position:d.midpoint(r,o,new d),label:{text:`${i.cross.distance}m`,font:"600 20px Helvetica",scale:1,fillColor:A.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,disableDepthTestDistance:Number.POSITIVE_INFINITY,pixelOffset:new E(0,30)}});let l=d.fromDegrees(...i.lineA),c=d.fromDegrees(...i.lineB);parseInt(d.distance(l,c)),this.entityB=this.entityDataSource.add({polyline:{positions:[l,c],material:A.CYAN,width:2.5},position:d.midpoint(l,c,new d),label:{text:`距离为${i.closeDis}m`,font:"600 20px Helvetica",scale:1,fillColor:A.WHITE,outlineWidth:3,style:J.FILL_AND_OUTLINE,pixelOffset:new E(0,-20),distanceDisplayCondition:new k(0,2e3),disableDepthTestDistance:Number.POSITIVE_INFINITY}})})}destroy(){this.primitiveCollection.destroy(),this.entityDataSource.destroy()}}if(document.currentScript&&document.currentScript.src){let n=new URL(document.currentScript.src+"/..").href;if(n.slice(-1)==="/"){window.LIGLOBE_BASE_URL=n.slice(0,-1);let e=ge.getBaseUrlFromScript();e&&e.url&&(window.LIGLOBE_CORE_BASE_URL=e.url)}}window.Cesium&&(window.LiGlobe_Core=Cesium);let wa={GisUtils:x};const ya="buildDate:"+uo(new Date().getTime());D.AsyncScreenCapture=Ro,D.AutoRotate=rn,D.BufferAnalysisTool=ei,D.CircleWave=ma,D.Collection=fi,D.CrossPoints=va,D.DangerPoints=jo,D.DangerPointsCluster=Go,D.DataManager=ko,D.ElectricCheck=vi,D.ElectricCheckManager=ga,D.Entity=K,D.EntityDataSource=K,D.FixedNestManager=Zo,D.FixedRealTimePath=eo,D.FlightLineManager=qr,D.FullScreen=xe,D.HeatmapManager=I,D.InputHandler=te,D.KmzPath=Wo,D.LineTower=ua,D.Map=Dn,D.MeasuringTool=Xt,D.MixedPoints=qo,D.NavigationControl=Ht,D.Patrol=ra,D.PickUp=qt,D.PowerLine=ze,D.PowerLineManager=Mo,D.RealTimePath=Bo,D.Regions=Ko,D.SagCalcu=Ho,D.ScreenCapture=Ao,D.SightLineTool=Nt,D.SystemData=hi,D.TerrainProfileTool=Re,D.TerrainUtil=sn,D.ToolManager=ri,D.Utils=wa,D.VERSION=ya,D.ViewshedAnalysis=gn,D.WindyManager=da,D.fetchData=ut,D.getBasePath=R,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});
